# =============================================================================
# HubTube — Nginx Production Configuration
# =============================================================================
# Designed for: Ubuntu 22.04+ / Nginx / PHP-FPM / Cloudflare CDN
#
# Install:
#   sudo cp hubtube.conf /etc/nginx/sites-available/hubtube
#   sudo ln -s /etc/nginx/sites-available/hubtube /etc/nginx/sites-enabled/
#   sudo nginx -t && sudo systemctl reload nginx
#
# Cloudflare Notes:
#   - SSL mode: "Full (Strict)" in Cloudflare dashboard
#   - Cloudflare handles edge SSL; Nginx terminates with origin cert
#   - Real visitor IPs restored via set_real_ip_from directives
#   - WebSocket support must be enabled in Cloudflare Network settings
#   - Large video uploads: increase Cloudflare upload limit (free plan = 100MB)
#     For larger uploads, use a DNS-only (gray cloud) subdomain like upload.yourdomain.com
# =============================================================================

# Rate limiting zones
limit_req_zone $binary_remote_addr zone=api:10m rate=30r/s;
limit_req_zone $binary_remote_addr zone=login:10m rate=5r/m;
limit_req_zone $binary_remote_addr zone=upload:10m rate=2r/s;

# Upstream definitions
upstream php-fpm {
    server unix:/run/php/php8.2-fpm.sock;
}

upstream reverb {
    server 127.0.0.1:8080;
}

upstream scraper {
    server 127.0.0.1:3001;
}

# =============================================================================
# Redirect HTTP → HTTPS (Cloudflare always connects via HTTPS to origin)
# =============================================================================
server {
    listen 80;
    listen [::]:80;
    server_name yourdomain.com www.yourdomain.com;
    return 301 https://$host$request_uri;
}

# =============================================================================
# Main HTTPS Server
# =============================================================================
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name yourdomain.com www.yourdomain.com;

    root /var/www/hubtube/public;
    index index.php;

    charset utf-8;

    # -------------------------------------------------------------------------
    # SSL — Cloudflare Origin Certificate
    # -------------------------------------------------------------------------
    # Generate at: Cloudflare Dashboard → SSL/TLS → Origin Server → Create Certificate
    # Valid for 15 years, trusted only by Cloudflare (not browsers directly)
    ssl_certificate     /etc/ssl/cloudflare/hubtube-origin.pem;
    ssl_certificate_key /etc/ssl/cloudflare/hubtube-origin-key.pem;

    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers off;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 1d;
    ssl_session_tickets off;

    # -------------------------------------------------------------------------
    # Cloudflare — Restore Real Visitor IP
    # -------------------------------------------------------------------------
    # Cloudflare IPv4 ranges (update periodically from https://www.cloudflare.com/ips-v4)
    set_real_ip_from 173.245.48.0/20;
    set_real_ip_from 103.21.244.0/22;
    set_real_ip_from 103.22.200.0/22;
    set_real_ip_from 103.31.4.0/22;
    set_real_ip_from 141.101.64.0/18;
    set_real_ip_from 108.162.192.0/18;
    set_real_ip_from 190.93.240.0/20;
    set_real_ip_from 188.114.96.0/20;
    set_real_ip_from 197.234.240.0/22;
    set_real_ip_from 198.41.128.0/17;
    set_real_ip_from 162.158.0.0/15;
    set_real_ip_from 104.16.0.0/13;
    set_real_ip_from 104.24.0.0/14;
    set_real_ip_from 172.64.0.0/13;
    set_real_ip_from 131.0.72.0/22;

    # Cloudflare IPv6 ranges
    set_real_ip_from 2400:cb00::/32;
    set_real_ip_from 2606:4700::/32;
    set_real_ip_from 2803:f800::/32;
    set_real_ip_from 2405:b500::/32;
    set_real_ip_from 2405:8100::/32;
    set_real_ip_from 2a06:98c0::/29;
    set_real_ip_from 2c0f:f248::/32;

    real_ip_header CF-Connecting-IP;

    # -------------------------------------------------------------------------
    # Upload Size — Video uploads can be very large
    # -------------------------------------------------------------------------
    # NOTE: Cloudflare free plan limits uploads to 100MB.
    #       For larger video uploads, either:
    #       1. Upgrade to Cloudflare Pro ($200/month, 500MB limit)
    #       2. Use a DNS-only (gray-cloud) subdomain: upload.yourdomain.com
    #       3. Use Cloudflare Workers with streaming uploads
    client_max_body_size 5G;
    client_body_timeout 600s;
    client_body_buffer_size 512k;

    # -------------------------------------------------------------------------
    # Security Headers
    # -------------------------------------------------------------------------
    # Note: Some headers (like HSTS) are better set in Cloudflare dashboard
    # to avoid duplication. These are origin-level headers.
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    add_header X-XSS-Protection "1; mode=block" always;

    # -------------------------------------------------------------------------
    # Logging
    # -------------------------------------------------------------------------
    access_log /var/log/nginx/hubtube-access.log;
    error_log  /var/log/nginx/hubtube-error.log;

    # -------------------------------------------------------------------------
    # Gzip Compression (Cloudflare also compresses, but this helps origin→CF)
    # -------------------------------------------------------------------------
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 4;
    gzip_min_length 256;
    gzip_types
        text/plain
        text/css
        text/javascript
        application/javascript
        application/json
        application/xml
        application/vnd.apple.mpegurl
        image/svg+xml
        font/woff2;

    # -------------------------------------------------------------------------
    # Static Assets — Vite build output (hashed filenames = long cache)
    # -------------------------------------------------------------------------
    location /build/ {
        alias /var/www/hubtube/public/build/;
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off;
    }

    # -------------------------------------------------------------------------
    # Storage — Local video/thumbnail/preview files
    # -------------------------------------------------------------------------
    # Only needed if serving from local disk (not Wasabi).
    # When using Wasabi with pre-signed URLs, files are served directly from S3.
    location /storage/ {
        alias /var/www/hubtube/storage/app/public/;
        expires 7d;
        add_header Cache-Control "public";

        # HLS segments — short cache (live-ish content)
        location ~* \.(m3u8)$ {
            expires 5s;
            add_header Cache-Control "public, no-transform";
            add_header Access-Control-Allow-Origin "*";
        }

        location ~* \.(ts)$ {
            expires 1h;
            add_header Cache-Control "public";
            add_header Access-Control-Allow-Origin "*";
        }

        # Video files — allow range requests for seeking
        location ~* \.(mp4|webm)$ {
            expires 30d;
            add_header Cache-Control "public";
            add_header Accept-Ranges bytes;
        }

        # Images — thumbnails, previews, sprites
        location ~* \.(jpg|jpeg|png|webp|gif|svg)$ {
            expires 30d;
            add_header Cache-Control "public";
        }
    }

    # -------------------------------------------------------------------------
    # Favicon & Robots
    # -------------------------------------------------------------------------
    location = /favicon.ico { access_log off; log_not_found off; }
    location = /robots.txt  { access_log off; log_not_found off; }

    # -------------------------------------------------------------------------
    # PWA Assets
    # -------------------------------------------------------------------------
    location = /manifest.json {
        expires 1d;
        add_header Cache-Control "public";
    }

    location = /sw.js {
        expires off;
        add_header Cache-Control "no-cache, no-store, must-revalidate";
    }

    location /icons/ {
        expires 30d;
        add_header Cache-Control "public";
    }

    # -------------------------------------------------------------------------
    # WebSocket — Laravel Reverb (proxied through Cloudflare)
    # -------------------------------------------------------------------------
    # Cloudflare supports WebSockets — enable in: Network → WebSockets
    # Client connects to: wss://yourdomain.com/app/{key}
    location /app/ {
        proxy_pass http://reverb;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 86400s;
        proxy_send_timeout 86400s;
    }

    # Reverb health/API endpoints
    location /apps/ {
        proxy_pass http://reverb;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # -------------------------------------------------------------------------
    # Scraper Microservice (internal only — not exposed to Cloudflare)
    # -------------------------------------------------------------------------
    location /scraper-api/ {
        # Only allow from localhost / internal
        allow 127.0.0.1;
        allow ::1;
        deny all;

        proxy_pass http://scraper/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # -------------------------------------------------------------------------
    # Rate Limiting on Sensitive Endpoints
    # -------------------------------------------------------------------------
    location ~ ^/login$ {
        limit_req zone=login burst=3 nodelay;
        try_files $uri $uri/ /index.php?$query_string;
    }

    location ~ ^/api/ {
        limit_req zone=api burst=60 nodelay;
        try_files $uri $uri/ /index.php?$query_string;
    }

    # -------------------------------------------------------------------------
    # Filament Admin Panel
    # -------------------------------------------------------------------------
    location /admin {
        try_files $uri $uri/ /index.php?$query_string;
    }

    # -------------------------------------------------------------------------
    # Horizon Dashboard (restrict access)
    # -------------------------------------------------------------------------
    location /horizon {
        try_files $uri $uri/ /index.php?$query_string;
    }

    # -------------------------------------------------------------------------
    # Main Application — Laravel (catch-all)
    # -------------------------------------------------------------------------
    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }

    # PHP-FPM Processing
    location ~ \.php$ {
        fastcgi_pass php-fpm;
        fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name;
        include fastcgi_params;

        fastcgi_index index.php;
        fastcgi_buffering on;
        fastcgi_buffer_size 16k;
        fastcgi_buffers 16 16k;
        fastcgi_read_timeout 300s;
        fastcgi_send_timeout 300s;

        # Pass Cloudflare headers to PHP
        fastcgi_param HTTP_CF_CONNECTING_IP $http_cf_connecting_ip;
        fastcgi_param HTTP_CF_IPCOUNTRY $http_cf_ipcountry;
        fastcgi_param HTTP_CF_RAY $http_cf_ray;
    }

    # Block access to hidden files (except .well-known for ACME)
    location ~ /\.(?!well-known).* {
        deny all;
    }
}

# =============================================================================
# Upload Subdomain (bypasses Cloudflare proxy for large video uploads)
# =============================================================================
# Use this if you need uploads > 100MB on Cloudflare free plan.
# Set upload.yourdomain.com to DNS-only (gray cloud) in Cloudflare.
# Then use Let's Encrypt for SSL on this subdomain.
#
# server {
#     listen 443 ssl http2;
#     server_name upload.yourdomain.com;
#
#     root /var/www/hubtube/public;
#     index index.php;
#
#     # Let's Encrypt cert (since this bypasses Cloudflare)
#     ssl_certificate     /etc/letsencrypt/live/upload.yourdomain.com/fullchain.pem;
#     ssl_certificate_key /etc/letsencrypt/live/upload.yourdomain.com/privkey.pem;
#
#     client_max_body_size 5G;
#     client_body_timeout 600s;
#
#     # Only allow upload-related routes
#     location ~ ^/(api/videos|videos/upload) {
#         try_files $uri $uri/ /index.php?$query_string;
#     }
#
#     location ~ \.php$ {
#         fastcgi_pass php-fpm;
#         fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name;
#         include fastcgi_params;
#         fastcgi_read_timeout 600s;
#     }
#
#     location / {
#         return 403;
#     }
# }
