/**
 * AgoraWebSDK_N-v4.24.2-0-g002485b1-dirty Copyright AgoraInc.
 */

import{logger as e,report as t,AgoraRTCError as n}from"@agora-js/report";import{IS_GLOBAL_VERSION as i,EventEmitter as o,getParameter as r,ScalabilityMode as s,parseSdp as a,isFirefox as c,jsonClone as d,printSdp as p,getRandomString as l,getBrowserInfo as h,BrowserName as u,BrowserOS as E,isSafari as _,isChromeBelow90 as C,isAboveChrome as m,isAboveEdge as R,isChrome as S,isFirefoxVersion as f,isBelowIOS14_6 as I,VideoCodec as N,QualityLimitationReason as g,OVERUSE_DETECTOR_PARAMS as T,isAboveIOS as A,isBelowIOS as D,isAboveSafari as v,isBelowSafari as O,PromiseMutex as P,createWebRTCStatsFilter as y,AgoraRTCError as L,AgoraRTCErrorCode as w,AgoraAPIName as b,AgoraAPITag as M,DEFAULT_CANDIDATE_STATS as U,isRTCIceServerList as x,isChromeKernel as V,setBigUint64 as F,getBigUint64 as k,NETWORK_STATE as B,networkIndicator as G,NETWORK_INDICATOR_EVENTS as H,emitAsPromise as K,getRetryWaitTime as W,wait as Y,emitAsInvokerNoResponse as j,ConnectionDisconnectedReason as J,Rolling as X,emitAsInvoker as Q}from"@agora-js/shared";import{LocalAudioTrack as q,MicrophoneAudioTrack as z,LocalVideoTrack as Z,getCompatibility as $,TrackHint as ee,CameraVideoTrack as te,detectSupportPreSub as ne,AgoraRTCPlayer as ie,getOriginSenderConfig as oe}from"@agora-js/media";import{deflateRaw as re,inflateRaw as se}from"pako";function ae(e,t){this.v=e,this.k=t}function ce(e,t,n,i,o){var r={};return Object.keys(i).forEach((function(e){r[e]=i[e]})),r.enumerable=!!r.enumerable,r.configurable=!!r.configurable,("value"in r||r.initializer)&&(r.writable=!0),r=n.slice().reverse().reduce((function(n,i){return i(e,t,n)||n}),r),o&&void 0!==r.initializer&&(r.value=r.initializer?r.initializer.call(o):void 0,r.initializer=void 0),void 0===r.initializer?(Object.defineProperty(e,t,r),null):r}function de(e){var t={},n=!1;function i(t,i){return n=!0,i=new Promise((function(n){n(e[t](i))})),{done:!1,value:new ae(i,1)}}return t["undefined"!=typeof Symbol&&Symbol.iterator||"@@iterator"]=function(){return this},t.next=function(e){return n?(n=!1,e):i("next",e)},"function"==typeof e.throw&&(t.throw=function(e){if(n)throw n=!1,e;return i("throw",e)}),"function"==typeof e.return&&(t.return=function(e){return n?(n=!1,e):i("return",e)}),t}function pe(e){var t,n,i,o=2;for("undefined"!=typeof Symbol&&(n=Symbol.asyncIterator,i=Symbol.iterator);o--;){if(n&&null!=(t=e[n]))return t.call(e);if(i&&null!=(t=e[i]))return new le(t.call(e));n="@@asyncIterator",i="@@iterator"}throw new TypeError("Object is not async iterable")}function le(e){function t(e){if(Object(e)!==e)return Promise.reject(new TypeError(e+" is not an object."));var t=e.done;return Promise.resolve(e.value).then((function(e){return{value:e,done:t}}))}return le=function(e){this.s=e,this.n=e.next},le.prototype={s:null,n:null,next:function(){return t(this.n.apply(this.s,arguments))},return:function(e){var n=this.s.return;return void 0===n?Promise.resolve({value:e,done:!0}):t(n.apply(this.s,arguments))},throw:function(e){var n=this.s.return;return void 0===n?Promise.reject(e):t(n.apply(this.s,arguments))}},new le(e)}function he(e){return new ae(e,0)}function ue(e,t,n){return(t=function(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var i=n.call(e,t||"default");if("object"!=typeof i)return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:t+""}(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function Ee(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function _e(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Ee(Object(n),!0).forEach((function(t){ue(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Ee(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function Ce(e){return function(){return new me(e.apply(this,arguments))}}function me(e){var t,n;function i(t,n){try{var r=e[t](n),s=r.value,a=s instanceof ae;Promise.resolve(a?s.v:s).then((function(n){if(a){var c="return"===t?"return":"next";if(!s.k||n.done)return i(c,n);n=e[c](n).value}o(r.done?"return":"normal",n)}),(function(e){i("throw",e)}))}catch(e){o("throw",e)}}function o(e,o){switch(e){case"return":t.resolve({value:o,done:!0});break;case"throw":t.reject(o);break;default:t.resolve({value:o,done:!1})}(t=t.next)?i(t.key,t.arg):n=null}this._invoke=function(e,o){return new Promise((function(r,s){var a={key:e,arg:o,resolve:r,reject:s,next:null};n?n=n.next=a:(t=n=a,i(e,o))}))},"function"!=typeof e.return&&(this.return=void 0)}me.prototype["function"==typeof Symbol&&Symbol.asyncIterator||"@@asyncIterator"]=function(){return this},me.prototype.next=function(e){return this._invoke("next",e)},me.prototype.throw=function(e){return this._invoke("throw",e)},me.prototype.return=function(e){return this._invoke("return",e)};let Re=function(e){return e[e.ACCESS_POINT=101]="ACCESS_POINT",e[e.UNILBS=201]="UNILBS",e[e.STRING_UID_ALLOCATOR=901]="STRING_UID_ALLOCATOR",e}({}),Se=function(e){return e[e.IIIEGAL_APPID=1]="IIIEGAL_APPID",e[e.IIIEGAL_UID=2]="IIIEGAL_UID",e[e.INTERNAL_ERROR=3]="INTERNAL_ERROR",e}({}),fe=function(e){return e[e.INVALID_VENDOR_KEY=5]="INVALID_VENDOR_KEY",e[e.INVALID_CHANNEL_NAME=7]="INVALID_CHANNEL_NAME",e[e.INTERNAL_ERROR=8]="INTERNAL_ERROR",e[e.NO_AUTHORIZED=9]="NO_AUTHORIZED",e[e.DYNAMIC_KEY_TIMEOUT=10]="DYNAMIC_KEY_TIMEOUT",e[e.NO_ACTIVE_STATUS=11]="NO_ACTIVE_STATUS",e[e.DYNAMIC_KEY_EXPIRED=13]="DYNAMIC_KEY_EXPIRED",e[e.STATIC_USE_DYNAMIC_KEY=14]="STATIC_USE_DYNAMIC_KEY",e[e.DYNAMIC_USE_STATIC_KEY=15]="DYNAMIC_USE_STATIC_KEY",e[e.USER_OVERLOAD=16]="USER_OVERLOAD",e[e.FORBIDDEN_REGION=18]="FORBIDDEN_REGION",e[e.CANNOT_MEET_AREA_DEMAND=19]="CANNOT_MEET_AREA_DEMAND",e[e.REQ_DOWNGRADE_FALLBACK=27]="REQ_DOWNGRADE_FALLBACK",e}({}),Ie=function(e){return e[e.NO_FLAG_SET=100]="NO_FLAG_SET",e[e.FLAG_SET_BUT_EMPTY=101]="FLAG_SET_BUT_EMPTY",e[e.INVALID_FALG_SET=102]="INVALID_FALG_SET",e[e.FLAG_SET_BUT_NO_RE=103]="FLAG_SET_BUT_NO_RE",e[e.INVALID_SERVICE_ID=104]="INVALID_SERVICE_ID",e[e.NO_SERVICE_AVAILABLE=200]="NO_SERVICE_AVAILABLE",e[e.NO_SERVICE_AVAILABLE_P2P=201]="NO_SERVICE_AVAILABLE_P2P",e[e.NO_SERVICE_AVAILABLE_VOICE=202]="NO_SERVICE_AVAILABLE_VOICE",e[e.NO_SERVICE_AVAILABLE_WEBRTC=203]="NO_SERVICE_AVAILABLE_WEBRTC",e[e.NO_SERVICE_AVAILABLE_CDS=204]="NO_SERVICE_AVAILABLE_CDS",e[e.NO_SERVICE_AVAILABLE_CDN=205]="NO_SERVICE_AVAILABLE_CDN",e[e.NO_SERVICE_AVAILABLE_TDS=206]="NO_SERVICE_AVAILABLE_TDS",e[e.NO_SERVICE_AVAILABLE_REPORT=207]="NO_SERVICE_AVAILABLE_REPORT",e[e.NO_SERVICE_AVAILABLE_APP_CENTER=208]="NO_SERVICE_AVAILABLE_APP_CENTER",e[e.NO_SERVICE_AVAILABLE_ENV0=209]="NO_SERVICE_AVAILABLE_ENV0",e[e.NO_SERVICE_AVAILABLE_VOET=210]="NO_SERVICE_AVAILABLE_VOET",e[e.NO_SERVICE_AVAILABLE_STRING_UID=211]="NO_SERVICE_AVAILABLE_STRING_UID",e[e.NO_SERVICE_AVAILABLE_WEBRTC_UNILBS=212]="NO_SERVICE_AVAILABLE_WEBRTC_UNILBS",e[e.NO_SERVICE_AVAILABLE_UNILBS_FLV=213]="NO_SERVICE_AVAILABLE_UNILBS_FLV",e}({}),Ne=function(e){return e[e.K_TIMESTAMP_EXPIRED=2]="K_TIMESTAMP_EXPIRED",e[e.K_CHANNEL_PERMISSION_INVALID=3]="K_CHANNEL_PERMISSION_INVALID",e[e.K_CERTIFICATE_INVALID=4]="K_CERTIFICATE_INVALID",e[e.K_CHANNEL_NAME_EMPTY=5]="K_CHANNEL_NAME_EMPTY",e[e.K_CHANNEL_NOT_FOUND=6]="K_CHANNEL_NOT_FOUND",e[e.K_TICKET_INVALID=7]="K_TICKET_INVALID",e[e.K_CHANNEL_CONFLICTED=8]="K_CHANNEL_CONFLICTED",e[e.K_SERVICE_NOT_READY=9]="K_SERVICE_NOT_READY",e[e.K_SERVICE_TOO_HEAVY=10]="K_SERVICE_TOO_HEAVY",e[e.K_UID_BANNED=14]="K_UID_BANNED",e[e.K_IP_BANNED=15]="K_IP_BANNED",e[e.K_CHANNEL_BANNED=16]="K_CHANNEL_BANNED",e[e.DATASTREAM2_NOT_AVAILABLE=27]="DATASTREAM2_NOT_AVAILABLE",e[e.K_AUTO_REBALANCE=28]="K_AUTO_REBALANCE",e[e.K_VOS_FALLBACK=30]="K_VOS_FALLBACK",e[e.WARN_NO_AVAILABLE_CHANNEL=103]="WARN_NO_AVAILABLE_CHANNEL",e[e.WARN_LOOKUP_CHANNEL_TIMEOUT=104]="WARN_LOOKUP_CHANNEL_TIMEOUT",e[e.WARN_LOOKUP_CHANNEL_REJECTED=105]="WARN_LOOKUP_CHANNEL_REJECTED",e[e.WARN_OPEN_CHANNEL_TIMEOUT=106]="WARN_OPEN_CHANNEL_TIMEOUT",e[e.WARN_OPEN_CHANNEL_REJECTED=107]="WARN_OPEN_CHANNEL_REJECTED",e[e.WARN_REQUEST_DEFERRED=108]="WARN_REQUEST_DEFERRED",e[e.ERR_DYNAMIC_KEY_TIMEOUT=109]="ERR_DYNAMIC_KEY_TIMEOUT",e[e.ERR_NO_AUTHORIZED=110]="ERR_NO_AUTHORIZED",e[e.ERR_VOM_SERVICE_UNAVAILABLE=111]="ERR_VOM_SERVICE_UNAVAILABLE",e[e.ERR_NO_CHANNEL_AVAILABLE_CODE=112]="ERR_NO_CHANNEL_AVAILABLE_CODE",e[e.ERR_MASTER_VOCS_UNAVAILABLE=114]="ERR_MASTER_VOCS_UNAVAILABLE",e[e.ERR_INTERNAL_ERROR=115]="ERR_INTERNAL_ERROR",e[e.ERR_NO_ACTIVE_STATUS=116]="ERR_NO_ACTIVE_STATUS",e[e.ERR_INVALID_UID=117]="ERR_INVALID_UID",e[e.ERR_DYNAMIC_KEY_EXPIRED=118]="ERR_DYNAMIC_KEY_EXPIRED",e[e.ERR_STATIC_USE_DYANMIC_KE=119]="ERR_STATIC_USE_DYANMIC_KE",e[e.ERR_DYNAMIC_USE_STATIC_KE=120]="ERR_DYNAMIC_USE_STATIC_KE",e[e.ERR_NO_VOCS_AVAILABLE=2e3]="ERR_NO_VOCS_AVAILABLE",e[e.ERR_NO_VOS_AVAILABLE=2001]="ERR_NO_VOS_AVAILABLE",e[e.ERR_JOIN_CHANNEL_TIMEOUT=2002]="ERR_JOIN_CHANNEL_TIMEOUT",e[e.ERR_REPEAT_JOIN_CHANNEL=2003]="ERR_REPEAT_JOIN_CHANNEL",e[e.ERR_JOIN_BY_MULTI_IP=2004]="ERR_JOIN_BY_MULTI_IP",e[e.ERR_NOT_JOINED=2011]="ERR_NOT_JOINED",e[e.ERR_REPEAT_JOIN_REQUEST=2012]="ERR_REPEAT_JOIN_REQUEST",e[e.ERR_INVALID_VENDOR_KEY=2013]="ERR_INVALID_VENDOR_KEY",e[e.ERR_INVALID_CHANNEL_NAME=2014]="ERR_INVALID_CHANNEL_NAME",e[e.ERR_INVALID_STRINGUID=2015]="ERR_INVALID_STRINGUID",e[e.ERR_TOO_MANY_USERS=2016]="ERR_TOO_MANY_USERS",e[e.ERR_SET_CLIENT_ROLE_TIMEOUT=2017]="ERR_SET_CLIENT_ROLE_TIMEOUT",e[e.ERR_SET_CLIENT_ROLE_NO_PERMISSION=2018]="ERR_SET_CLIENT_ROLE_NO_PERMISSION",e[e.ERR_SET_CLIENT_ROLE_ALREADY_IN_USE=2019]="ERR_SET_CLIENT_ROLE_ALREADY_IN_USE",e[e.ERR_PUBLISH_REQUEST_INVALID=2020]="ERR_PUBLISH_REQUEST_INVALID",e[e.ERR_SUBSCRIBE_REQUEST_INVALID=2021]="ERR_SUBSCRIBE_REQUEST_INVALID",e[e.ERR_NOT_SUPPORTED_MESSAGE=2022]="ERR_NOT_SUPPORTED_MESSAGE",e[e.ERR_ILLEAGAL_PLUGIN=2023]="ERR_ILLEAGAL_PLUGIN",e[e.ERR_REJOIN_TOKEN_INVALID=2024]="ERR_REJOIN_TOKEN_INVALID",e[e.ERR_REJOIN_USER_NOT_JOINED=2025]="ERR_REJOIN_USER_NOT_JOINED",e[e.ERR_INVALID_OPTIONAL_INFO=2027]="ERR_INVALID_OPTIONAL_INFO",e[e.ILLEGAL_AES_PASSWORD=2028]="ILLEGAL_AES_PASSWORD",e[e.ILLEGAL_CLIENT_ROLE_LEVEL=2029]="ILLEGAL_CLIENT_ROLE_LEVEL",e[e.ERR_TOO_MANY_BROADCASTERS=2031]="ERR_TOO_MANY_BROADCASTERS",e[e.ERR_TOO_MANY_SUBSCRIBERS=2032]="ERR_TOO_MANY_SUBSCRIBERS",e[e.ERR_LICENSE_MISSING=32769]="ERR_LICENSE_MISSING",e[e.ERR_LICENSE_EXPIRED=32771]="ERR_LICENSE_EXPIRED",e[e.ERR_LICENSE_MINUTES_EXCEEDED=32773]="ERR_LICENSE_MINUTES_EXCEEDED",e[e.ERR_LICENSE_PERIOD_INVALID=32774]="ERR_LICENSE_PERIOD_INVALID",e[e.ERR_LICENSE_MULTIPLE_SDK_SERVICE=32778]="ERR_LICENSE_MULTIPLE_SDK_SERVICE",e[e.ERR_LICENSE_ILLEGAL=32783]="ERR_LICENSE_ILLEGAL",e[e.ERR_TEST_RECOVER=9e3]="ERR_TEST_RECOVER",e[e.ERR_TEST_TRYNEXT=9001]="ERR_TEST_TRYNEXT",e[e.ERR_TEST_RETRY=9002]="ERR_TEST_RETRY",e}({}),ge=function(e){return e.CONNECTING="connecting",e.CONNECTED="connected",e.RECONNECTING="reconnecting",e.CLOSED="closed",e}({}),Te=function(e){return e.WS_CONNECTED="ws_connected",e.WS_RECONNECTING="ws_reconnecting",e.WS_CLOSED="ws_closed",e.WS_RECONNECT_CREATE_CONNECTION="ws_reconnect_create_connection",e.ON_BINARY_DATA="on_binary_data",e.REQUEST_RECOVER="request_recover",e.REQUEST_JOIN_INFO="request_join_info",e.REQUEST_REJOIN_INFO="req_rejoin_info",e.IS_P2P_DISCONNECTED="is_p2p_dis",e.DISCONNECT_P2P="dis_p2p",e.ABORT_P2P_EXECUTION="abort_p2p_execution",e.NEED_RENEW_SESSION="need-sid",e.REPORT_JOIN_GATEWAY="report_join_gateway",e.REQUEST_TIMEOUT="request_timeout",e.REQUEST_SUCCESS="request_success",e.JOIN_RESPONSE="join_response",e.PRE_CONNECT_PC="pre_connect_pc",e.DATACHANNEL_PRECONNECT="datachannel_preconnect",e.DATACHANNEL_CONNECTING="datachannel_connecting",e.DATACHANNEL_FAILBACK="datachannel_failback",e.P2P_CONNECTION="p2p_connection",e.P2P_REMOTE_CANDIDATE_UPDATE="p2p_remote_candidate_update",e.P2P_SUBSCRIBE="p2p_subscribe",e.P2P_UNSUBSCRIBE="p2p_unsubscribe",e.P2P_EXCHANGE_SDP="p2p_exchange_sdp",e.P2P_ON_ADD_VIDEO_STREAM="p2p_on_add_video_stream",e.P2P_ON_ADD_AUDIO_STREAM="p2p_on_add_audio_stream",e.RECOVER_NOTIFICATION="recover_notification",e.VOS_FALLBACK="vos_fallback",e.VOS_FALLBACK_PROMISE="vos_fallback_promise",e}({}),Ae=function(e){return e.PING="ping",e.PING_BACK="ping_back",e.JOIN="join_v3",e.REJOIN="rejoin_v3",e.LEAVE="leave",e.SET_CLIENT_ROLE="set_client_role",e.PUBLISH="publish",e.PUBLISH_DATASTREAM="publish_datastream",e.UNPUBLISH="unpublish",e.UNPUBLISH_DATASTREAM="unpublish_datastream",e.SUBSCRIBE="subscribe",e.PRE_SUBSCRIBE="pre_subscribe",e.SUBSCRIBE_DATASTREAM="subscribe_datastream",e.SUBSCRIBE_STREAMS="subscribe_streams",e.UNSUBSCRIBE="unsubscribe",e.UNSUBSCRIBE_DATASTREAM="unsubscribe_datastream",e.UNSUBSCRIBE_STREAMS="unsubscribe_streams",e.SUBSCRIBE_CHANGE="subscribe_change",e.TRAFFIC_STATS="traffic_stats",e.RENEW_TOKEN="renew_token",e.SET_DUAL_STREAM_MODE="set_dual_stream_mode",e.SWITCH_VIDEO_STREAM="switch_video_stream",e.DEFAULT_VIDEO_STREAM="default_video_stream",e.SET_FALLBACK_OPTION="set_fallback_option",e.CONFIGURE="configure",e.GATEWAY_INFO="gateway_info",e.CONTROL="control",e.SEND_METADATA="send_metadata",e.DATA_STREAM="data_stream",e.PICK_SVC_LAYER="pick_svc_layer",e.RESTART_ICE="restart_ice",e.CONNECT_PC="connect_pc",e.SET_VIDEO_PROFILE="set_video_profile",e.SET_PARAMETER="set_parameter",e.SET_RTM2_FLAG="set_rtm2_flag",e.DOWNGRADE_CODEC="downgrade_codec",e}({}),De=function(e){return e.WRTC_STATS="wrtc_stats",e.WS_INFLATE_DATA_LENGTH="ws_inflate_data_length",e.DENOISER_STATS="denoiser_stats",e.EXTENSION_USAGE_STATS="extension_usage_stats",e}({}),ve=function(e){return e.ON_USER_ONLINE="on_user_online",e.ON_USER_OFFLINE="on_user_offline",e.ON_STREAM_FALLBACK_UPDATE="on_stream_fallback_update",e.ON_PUBLISH_STREAM="on_publish_stream",e.ON_UPLINK_STATS="on_uplink_stats",e.ON_P2P_LOST="on_p2p_lost",e.ON_REMOVE_STREAM="on_remove_stream",e.ON_ADD_AUDIO_STREAM="on_add_audio_stream",e.ON_ADD_VIDEO_STREAM="on_add_video_stream",e.ON_TOKEN_PRIVILEGE_WILL_EXPIRE="on_token_privilege_will_expire",e.ON_TOKEN_PRIVILEGE_DID_EXPIRE="on_token_privilege_did_expire",e.ON_USER_BANNED="on_user_banned",e.ON_USER_LICENSE_BANNED="on_user_license_banned",e.ON_NOTIFICATION="on_notification",e.ON_CRYPT_ERROR="on_crypt_error",e.MUTE_AUDIO="mute_audio",e.MUTE_VIDEO="mute_video",e.UNMUTE_AUDIO="unmute_audio",e.UNMUTE_VIDEO="unmute_video",e.ON_P2P_OK="on_p2p_ok",e.RECEIVE_METADATA="receive_metadata",e.ON_DATA_STREAM="on_data_stream",e.ON_RTP_CAPABILITY_CHANGE="on_rtp_capability_change",e.ON_REMOTE_DATASTREAM_UPDATE="on_remote_datastream_update",e.ON_REMOTE_FULL_DATASTREAM_INFO="on_remote_full_datastream_info",e.ENABLE_LOCAL_VIDEO="enable_local_video",e.DISABLE_LOCAL_VIDEO="disable_local_video",e.ENABLE_LOCAL_AUDIO="enable_local_audio",e.DISABLE_LOCAL_AUDIO="disable_local_audio",e.ON_PUBLISHED_USER_LIST="on_published_user_list",e.ENABLE_MULTI_STREAM="enable_multi_stream",e}({}),Oe=function(e){return e.CHINA="CHINA",e.ASIA="ASIA",e.NORTH_AMERICA="NORTH_AMERICA",e.EUROPE="EUROPE",e.JAPAN="JAPAN",e.INDIA="INDIA",e.KOREA="KOREA",e.HKMC="HKMC",e.US="US",e.OCEANIA="OCEANIA",e.SOUTH_AMERICA="SOUTH_AMERICA",e.AFRICA="AFRICA",e.OVERSEA="OVERSEA",e.GLOBAL="GLOBAL",e.EXTENSIONS="EXTENSIONS",e}({});Oe.AFRICA,Oe.ASIA,Oe.CHINA,Oe.EUROPE,Oe.GLOBAL,Oe.INDIA,Oe.JAPAN,Oe.NORTH_AMERICA,Oe.OCEANIA,Oe.OVERSEA,Oe.SOUTH_AMERICA;let Pe=function(e){return e.CHINA="CN",e.ASIA="AS",e.NORTH_AMERICA="NA",e.EUROPE="EU",e.JAPAN="JP",e.INDIA="IN",e.KOREA="KR",e.HKMC="HK",e.US="US",e.OCEANIA="OC",e.SOUTH_AMERICA="SA",e.AFRICA="AF",e.OVERSEA="OVERSEA",e.GLOBAL="GLOBAL",e.EXTENSIONS="GLOBAL",e}({});Pe.ASIA,Pe.NORTH_AMERICA,Pe.EUROPE,Pe.JAPAN,Pe.INDIA,Pe.KOREA,Pe.HKMC,Pe.US,Pe.OVERSEA,Pe.GLOBAL,Pe.OCEANIA,Pe.SOUTH_AMERICA,Pe.AFRICA,i&&Pe.CHINA;class ye extends o{constructor(e,t){super(),this.onICEConnectionStateChange=void 0,this.onConnectionStateChange=void 0,this.onDTLSTransportStateChange=void 0,this.onDTLSTransportError=void 0,this.onICETransportStateChange=void 0,this.onFirstAudioReceived=void 0,this.onFirstVideoReceived=void 0,this.onFirstAudioDecoded=void 0,this.onFirstVideoDecoded=void 0,this.onFirstVideoRender=void 0,this.onFirstVideoBufferReady=void 0,this.onFirstVideoDecodedTimeout=void 0,this.onSelectedLocalCandidateChanged=void 0,this.onSelectedRemoteCandidateChanged=void 0,this.onICECandidateError=void 0,this.getLocalVideoStats=void 0}}class Le extends ye{constructor(e,t){super(e,t),this.establishPromise=void 0}}let we=function(e){return e.VIDEO="video",e.AUDIO="audio",e}({}),be=function(e){return e.UDP_RELAY="udp_relay",e.UDP_TCP_RELAY="udp_tcp_relay",e.TCP_RELAY="tcp_relay",e.RELAY="relay",e}({}),Me=function(e){return e.NETWORK_ERROR="NETWORK_ERROR",e.SERVER_ERROR="SERVER_ERROR",e.MULTI_IP="MULTI_IP",e.TIMEOUT="TIMEOUT",e.OFFLINE="OFFLINE",e.LEAVE="LEAVE",e.P2P_FAILED="P2P_FAILED",e.FALLBACK="FALLBACK",e}({}),Ue=function(e){return e.CONNECTED="transmitter:connected",e.RECONNECTING="transmitter:reconnecting",e.WILL_RECONNECT="transmitter:will_reconnect",e.CLOSED="transmitter:closed",e.FAILED="transmitter:failed",e.ON_MESSAGE="transmitter:on_message",e.REQUEST_NEW_URLS="transmitter:request_new_urls",e.RECONNECT_CREATE_CONNECTION="transmitter:reconnect_create_connection",e.ON_TOKEN_PRIVILEGE_DID_EXPIRE="transmitter:on_token_privilege_did_expire",e.TO_CONNECT_DATACHANNEL="transmitter:to_connect_datachannel",e.FAILBACK="transmitter:failback",e.PRE_CONNECT_PC="transmitter:pre_connect_pc",e}({}),xe=0;function Ve(t){const n=r("TURN_DOMAINS");xe=(xe+1)%n.length;const i=n[xe]||"edge.agora.io";return t.match(/^[\.\:\d]+$/)?"".concat(t.replace(/[^\d]/g,"-"),".").concat(i):(e.debug("Cannot recognized as ip address: ".concat(t,", use as host2")),t)}function Fe(e){return"number"==typeof e?e:e.exact||e.ideal||e.max||e.min||0}function ke(e){const t=e.split(":"),n=e.split(/[-.]/),i=e.includes("-")?"-":".";let o=e;return t.length>1?n.length>1?(n[1]="**",o=n[0]+i+"**:"+t[t.length-1]):o=t.length>2?t[0]+i+"**:"+t[t.length-1]:"**:"+t[t.length-1]:n.length>1&&(o=n[0]+i+"**"),o}function Be(e,t){return e.getTransceivers().find((e=>e.sender.track===t||e.receiver.track===t))}function Ge(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:r("SVC_MODE");if(r("ENABLE_SVC"))return function(e){return e in s}(e)?e:s.L1T3}const He={[we.VIDEO]:[{key:"abs-send-time",extensionName:"http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time"},{key:"video-orientation",extensionName:"urn:3gpp:video-orientation"},{key:"draft-holmer-rmcat-transport-wide-cc-extensions-01",extensionName:"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"},{key:"playout-delay",extensionName:"http://www.webrtc.org/experiments/rtp-hdrext/playout-delay"},{key:"video-content-type",extensionName:"http://www.webrtc.org/experiments/rtp-hdrext/video-content-type"},{key:"color-space",extensionName:"http://www.webrtc.org/experiments/rtp-hdrext/color-space"},{key:"video-timing",extensionName:"http://www.webrtc.org/experiments/rtp-hdrext/video-timing"}],[we.AUDIO]:[{key:"ssrc-audio-level",extensionName:"urn:ietf:params:rtp-hdrext:ssrc-audio-level"},{key:"draft-holmer-rmcat-transport-wide-cc-extensions-01",extensionName:"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"},{key:"abs-send-time",extensionName:"http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time"}]};function Ke(e){e.send&&(je(we.VIDEO,e.send.videoExtensions),je(we.AUDIO,e.send.audioExtensions)),e.recv&&(je(we.VIDEO,e.recv.videoExtensions),je(we.AUDIO,e.recv.audioExtensions)),e.sendrecv&&(je(we.VIDEO,e.sendrecv.videoExtensions),je(we.AUDIO,e.sendrecv.audioExtensions))}function We(e,t){e.send&&(Ye(we.VIDEO,e.send.videoExtensions,t.send.videoExtensions),Ye(we.AUDIO,e.send.audioExtensions,t.send.audioExtensions)),e.recv&&(Ye(we.VIDEO,e.recv.videoExtensions,t.recv.videoExtensions),Ye(we.AUDIO,e.recv.audioExtensions,t.recv.audioExtensions))}function Ye(e,t,n){t.forEach((t=>{const i=He[e].find((e=>{let{key:n}=e;return t.extensionName.includes(n)}));if(!i)return;const o=n.find((e=>{let{extensionName:t}=e;return t.includes(i.key)}));o&&o.extensionName.includes("gdpr_forbidden")&&(t.extensionName=o.extensionName)}))}function je(e,t){t.forEach((t=>{const n=He[e].find((e=>{let{key:n}=e;return t.extensionName.includes(n)}));t.extensionName.includes("gdpr_forbidden")&&n&&(t.extensionName=n.extensionName)}))}function Je(e){return"http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time"===e||e.includes("abs-send-time")}function Xe(e){return"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"===e||e.includes("draft-holmer-rmcat-transport-wide-cc-extensions-01")}function Qe(t){let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},o=arguments.length>3?arguments[3]:void 0;const{filterRTX:s,filterVideoFec:c,filterAudioFec:d,filterAudioCodec:p,filterVideoCodec:l,unsupportedVideoUplinkCodec:h,unsupportedVideoDownlinkCodec:u}=n,{useXR:E}=i;let _=[],C=[],m=[],R=[],S=!1,f=!1;if(a(t).mediaDescriptions.forEach((e=>{o&&o!==e.attributes.direction||("video"!==e.media.mediaType||S||(C=e.attributes.payloads,R=e.attributes.extmaps,S=!0),"audio"!==e.media.mediaType||f||(_=e.attributes.payloads,m=e.attributes.extmaps,f=!0))})),!R||0===C.length)throw new Error("Cannot get video capabilities from SDP.");if(!m||0===_.length)throw new Error("Cannot get audio capabilities from SDP.");if(C.forEach((e=>{var t;null!==(t=e.rtpMap)&&void 0!==t&&t.clockRate&&(e.rtpMap.clockRate=parseInt(e.rtpMap.clockRate)),E&&e.rtcpFeedbacks.push({type:"rrtr"})})),_.forEach((e=>{var t;null!==(t=e.rtpMap)&&void 0!==t&&t.clockRate&&(e.rtpMap.clockRate=parseInt(e.rtpMap.clockRate)),E&&e.rtcpFeedbacks.push({type:"rrtr"})})),s&&(_=_.filter((e=>{var t;return"rtx"!==(null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName.toLowerCase())})),C=C.filter((e=>{var t;return"rtx"!==(null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName.toLowerCase())}))),c){const e=C.filter((e=>{var t;return/(red)|(ulpfec)|(flexfec)/i.test((null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName)||"")})),t=ct(e,C).map((e=>e.payloadType)),n=[...e.map((e=>e.payloadType)),...t];C=C.filter((e=>!n.includes(e.payloadType)))}if(d&&(_=_.filter((e=>{var t;return!/(red)|(ulpfec)|(flexfec)/i.test((null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName)||"")}))),p&&(null==p?void 0:p.length)>0&&(_=_.filter((e=>{var t;return p.includes((null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName.toLowerCase())||"")}))),l&&(null==l?void 0:l.length)>0){const e=C.filter((e=>{var t;return l.includes((null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName.toLowerCase())||"")}));C=e.concat(s?[]:ct(e,C))}const I=r("UNSUPPORTED_VIDEO_CODEC");if(I&&I.length>0){const t=C.filter((e=>e.rtpMap&&I.includes(e.rtpMap.encodingName.toLowerCase()))),n=ct(t,C),i=t.concat(n).map((e=>e.payloadType));C=C.filter((e=>!i.includes(e.payloadType))),e.debug("unsupportedVideoCodec: ".concat(I,", toBeRemoved: ").concat(i))}if(h&&h.length>0&&"sendonly"===o){const t=C.filter((e=>e.rtpMap&&h.includes(e.rtpMap.encodingName.toLowerCase()))),n=ct(t,C),i=t.concat(n).map((e=>e.payloadType));C=C.filter((e=>!i.includes(e.payloadType))),e.debug("unsupportedVideoUplinkCodec: ".concat(h,", toBeRemoved: ").concat(i))}if(u&&u.length>0&&"recvonly"===o){const t=C.filter((e=>e.rtpMap&&u.includes(e.rtpMap.encodingName.toLowerCase()))),n=ct(t,C),i=t.concat(n).map((e=>e.payloadType));C=C.filter((e=>!i.includes(e.payloadType))),e.debug("unsupportedVideoDownlinkCodec: ".concat(u,", toBeRemoved: ").concat(i))}return{audioCodecs:_,videoCodecs:C,audioExtensions:m,videoExtensions:R}}function qe(e){const t=a(e);let n,i;for(const e of t.mediaDescriptions){if(!n){const t=e.attributes.iceUfrag,i=e.attributes.icePwd;if(!t||!i)throw new Error("Cannot get iceUfrag or icePwd from SDP.");n={iceUfrag:t,icePwd:i}}if(!i){const t=e.attributes.fingerprints;t.length>0&&(i={fingerprints:t})}}if(!i&&t.attributes.fingerprints.length>0&&(i={fingerprints:t.attributes.fingerprints}),!i||!n)throw new Error("Cannot get iceParameters or dtlsParameters from SDP.");return{iceParameters:n,dtlsParameters:i}}function ze(e,t){const n=[],i=e.attributes.ssrcGroups.filter((e=>"FID"===e.semantic)),o=e.attributes.ssrcGroups.find((e=>"SIM"===e.semantic)),r=e.attributes.ssrcs;if(o)o.ssrcIds.forEach((e=>{var o;const r=null===(o=i.find((t=>t.ssrcIds[0]===e)))||void 0===o?void 0:o.ssrcIds[1];n.push({ssrcId:e,rtx:t?r:void 0})}));else if(i.length>0){const e=i[0].ssrcIds[0],o=i[0].ssrcIds[1];n.push({ssrcId:e,rtx:t?o:void 0})}else{if(0===r.length)throw new Error("No ssrcs found on local media description.");n.push({ssrcId:r[0].ssrcId})}return n}function Ze(e,t,n){const i=[],o=[];return e.forEach((e=>{let{ssrcId:r,rtx:s}=e;const a=l(8,"track-"),c={ssrcId:r,attributes:_e({label:a,mslabel:n=n||l(10,""),msid:"".concat(n," ").concat(a)},t&&{cname:t})};if(i.push(c),void 0!==s){const e={ssrcId:s,attributes:_e({label:a,mslabel:n,msid:"".concat(n," ").concat(a)},t&&{cname:t})};i.push(e),o.push({semantic:"FID",ssrcIds:[r,s]})}})),e.length>1&&o.push({semantic:"SIM",ssrcIds:e.map((e=>{let{ssrcId:t}=e;return t}))}),{ssrcs:i,ssrcGroups:o}}function $e(e,t){t instanceof q&&e.attributes.payloads.forEach((e=>{var n;const i=null===(n=e.rtpMap)||void 0===n?void 0:n.encodingName.toLowerCase();if(!i||-1===["opus","pcmu","pcma","g722"].indexOf(i))return;e.fmtp||(e.fmtp={parameters:{}}),"opus"===i&&"number"==typeof r("OPUS_PTIME")?e.fmtp.parameters.ptime=r("OPUS_PTIME"):e.fmtp.parameters.minptime="10",e.fmtp.parameters.useinbandfec="1";const o=t._encoderConfig;o&&("pcmu"!==i&&"pcma"!==i&&"g722"!==i&&(o.bitrate&&!c()&&(e.fmtp.parameters.maxaveragebitrate="".concat(Math.floor(1e3*o.bitrate))),o.sampleRate&&(e.fmtp.parameters.maxplaybackrate="".concat(o.sampleRate),e.fmtp.parameters["sprop-maxcapturerate"]="".concat(o.sampleRate)),o.stereo&&(e.fmtp.parameters.stereo="1",e.fmtp.parameters["sprop-stereo"]="1")),t instanceof z&&"opus"===i&&t._config.DTX&&(e.fmtp.parameters.usedtx="1"))}))}function et(e,t,n){if(!t)return;let i,o;if("video"===e.media.mediaType?(i=n.videoExtensions,o=n.videoCodecs):(i=n.audioExtensions,o=n.audioCodecs),!0===t.twcc){const t=i.find((e=>Xe(e.extensionName)));if(t){const n=t.extensionName;e.attributes.extmaps.find((e=>Xe(e.extensionName)))||e.attributes.extmaps.push({entry:t.entry,extensionName:n});const i=function(e,t){return t.filter((t=>!!e.find((e=>e.payloadType===t.payloadType&&!!e.rtcpFeedbacks.find((e=>"transport-cc"===e.type))))))}(o,e.attributes.payloads);i.forEach((e=>{e.rtcpFeedbacks.find((e=>"transport-cc"===e.type))||e.rtcpFeedbacks.push({type:"transport-cc"})}))}}else if(!1===t.twcc){const t=e.attributes.extmaps.findIndex((e=>Xe(e.extensionName)));-1!==t&&e.attributes.extmaps.splice(t,1),e.attributes.payloads.forEach((e=>{const t=e.rtcpFeedbacks.findIndex((e=>"transport-cc"===e.type));-1!==t&&e.rtcpFeedbacks.splice(t,1)}))}if(!0===t.remb){const t=i.find((e=>Je(e.extensionName)));if(t){const n=t.extensionName;e.attributes.extmaps.find((e=>e.extensionName===n))||e.attributes.extmaps.push({entry:t.entry,extensionName:n});const i=function(e,t){return t.filter((t=>!!e.find((e=>e.payloadType===t.payloadType&&!!e.rtcpFeedbacks.find((e=>"goog-remb"===e.type))))))}(o,e.attributes.payloads);i.forEach((e=>{e.rtcpFeedbacks.find((e=>"goog-remb"===e.type))||e.rtcpFeedbacks.push({type:"goog-remb"})}))}}else if(!1===t.remb){const t=e.attributes.extmaps.findIndex((e=>Je(e.extensionName)));-1!==t&&e.attributes.extmaps.splice(t,1),e.attributes.payloads.forEach((e=>{const t=e.rtcpFeedbacks.findIndex((e=>"goog-remb"===e.type));-1!==t&&e.rtcpFeedbacks.splice(t,1)}))}}function tt(e,t,n){if(c())return;if("video"!==e.media.mediaType)return;if(!(t instanceof Z))return;if("vp9"!==n&&"vp8"!==n)return;if("vp8"===n&&!r("SIMULCAST"))return;if("vp9"===n&&r("ENABLE_SVC"))return;if(void 0===t._scalabilityMode||t._scalabilityMode.numSpatialLayers<=1)return;const i="vp8"===n?2:t._scalabilityMode.numSpatialLayers,o=e.attributes.ssrcs[0],s=e.attributes.ssrcGroups.find((e=>"FID"===e.semantic&&e.ssrcIds[0]===o.ssrcId)),a={semantic:"SIM",ssrcIds:[o.ssrcId]};for(let t=1;t<i;t++)e.attributes.ssrcs.push({ssrcId:o.ssrcId+t,attributes:d(o.attributes)}),a.ssrcIds.push(o.ssrcId+t),s&&(e.attributes.ssrcs.push({ssrcId:s.ssrcIds[1]+t,attributes:d(o.attributes)}),e.attributes.ssrcGroups.push({semantic:"FID",ssrcIds:[o.ssrcId+t,s.ssrcIds[1]+t]}));e.attributes.ssrcGroups.unshift(a)}async function nt(){try{const e=new RTCPeerConnection;e.addTransceiver("video",{direction:"sendonly",sendEncodings:[{scalabilityMode:s.L1T3}]});const t=await e.createOffer();if(!t.sdp)return void e.close();const n=a(t.sdp).mediaDescriptions[0];if(!n)return;const i=n.attributes.extmaps.find((e=>"https://aomediacodec.github.io/av1-rtp-spec/#dependency-descriptor-rtp-header-extension"===e.extensionName));return e.close(),i}catch(e){return}}async function it(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const i=new RTCPeerConnection;i.addTransceiver("video",{direction:"sendonly"}),i.addTransceiver("audio",{direction:"sendonly"}),i.addTransceiver("video",{direction:"recvonly"}),i.addTransceiver("audio",{direction:"recvonly"});const o=(await i.createOffer()).sdp,{send:s,recv:a,sendrecv:c}=function(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=arguments.length>2?arguments[2]:void 0;const o=Qe(i,t,n,"sendonly"),s=Qe(i,t,n,"recvonly"),a={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},c={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},d={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]};if(ot(o,s,"videoExtensions",a,c,d),ot(o,s,"videoCodecs",a,c,d),ot(o,s,"audioExtensions",a,c,d),ot(o,s,"audioCodecs",a,c,d),r("RAISE_H264_BASELINE_PRIORITY")){const t=[],n=[];if(d.videoCodecs.forEach(((e,i)=>{var o;if("h264"===(null===(o=e.rtpMap)||void 0===o?void 0:o.encodingName.toLocaleLowerCase())){var s,a;const o=d.videoCodecs[i+1],c=o&&Et(e,o),p=null===(s=e.fmtp)||void 0===s?void 0:s.parameters["profile-level-id"],l=null===(a=e.fmtp)||void 0===a?void 0:a.parameters["packetization-mode"];!p||p!==r("FIRST_H264_PROFILE_LEVEL_ID")||r("FIRST_PACKETIZATION_MODE")&&l!==r("FIRST_PACKETIZATION_MODE")?c?n.push([e,o]):n.push([e]):c?t.push([e,o]):t.push([e])}})),t.length>0&&n.length>0){e.debug("raising H264 baseline profile priority"),d.videoCodecs.forEach(((e,i)=>{var o;if("h264"===(null===(o=e.rtpMap)||void 0===o?void 0:o.encodingName.toLocaleLowerCase())){const o=Et(e,d.videoCodecs[i+1]),r=t.shift()||n.shift()||[];r.length>0&&(o?d.videoCodecs.splice(i,2,...r):d.videoCodecs.splice(i,1,...r))}}));const i=c.videoCodecs.filter((e=>{var t,n;return"h264"===(null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName.toLocaleLowerCase())&&(null===(n=e.fmtp)||void 0===n?void 0:n.parameters["profile-level-id"])!==r("FIRST_H264_PROFILE_LEVEL_ID")}));if(i.length>0){const e=ct(i,c.videoCodecs).map((e=>e.payloadType)),t=[...i.map((e=>e.payloadType)),...e];c.videoCodecs=c.videoCodecs.filter((e=>!t.includes(e.payloadType)))}r("FILTER_SEND_H264_BASELINE")&&(a.videoCodecs=a.videoCodecs.filter((e=>{var t,n;return!("h264"===(null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName.toLocaleLowerCase())&&(null===(n=e.fmtp)||void 0===n?void 0:n.parameters["profile-level-id"])!==r("FIRST_H264_PROFILE_LEVEL_ID"))})))}return{send:a,recv:c,sendrecv:d}}return{send:a,recv:c,sendrecv:d}}(t,n,o);try{i.close()}catch(e){}return{send:s,recv:a,sendrecv:c}}function ot(e,t,n,i,o,r){if("videoExtensions"===n||"audioExtensions"===n){const s=[];return e[n].forEach((e=>{t[n].some(((t,n)=>{if(e.entry===t.entry&&e.extensionName===t.extensionName)return s.push(n),!0}))?r[n].push(e):i[n].push(e)})),void t[n].forEach(((e,t)=>{-1===s.indexOf(t)&&o[n].push(e)}))}if("videoCodecs"===n||"audioCodecs"===n){const s=[];return e[n].forEach((e=>{t[n].some(((t,n)=>{if(e.payloadType===t.payloadType&&JSON.stringify(e)===JSON.stringify(t))return s.push(n),!0}))?r[n].push(e):i[n].push(e)})),void t[n].forEach(((e,t)=>{-1===s.indexOf(t)&&o[n].push(e)}))}}function rt(e){const{send:t,recv:n,sendrecv:i}=e;if(!i){if(!t||!n)throw new Error("cannot merge rtp capabilities because one of send or recv is empty!");return{send:t,recv:n}}let o,r;return t?(o={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},o.audioCodecs=[...t.audioCodecs,...i.audioCodecs],o.videoCodecs=[...t.videoCodecs,...i.videoCodecs],o.audioExtensions=[...t.audioExtensions,...i.audioExtensions],o.videoExtensions=[...t.videoExtensions,...i.videoExtensions]):o=d(i),n?(r={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},r.audioCodecs=[...n.audioCodecs,...i.audioCodecs],r.videoCodecs=[...n.videoCodecs,...i.videoCodecs],r.audioExtensions=[...n.audioExtensions,...i.audioExtensions],r.videoExtensions=[...n.videoExtensions,...i.videoExtensions]):r=d(i),{send:o,recv:r}}function st(e){if("audio"!==e.media.mediaType)return;e.attributes.payloads.filter((e=>{var t;return"opus"===(null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName.toLowerCase())})).forEach((e=>{e.fmtp||(e.fmtp={parameters:{}}),e.fmtp.parameters.stereo="1",e.fmtp.parameters["sprop-stereo"]="1"}))}function at(t,n,i,o){let s=[];if(t===we.VIDEO){if(r("H264_PROFILE_LEVEL_ID")&&"h264"===o&&(s=n.videoCodecs.filter((e=>(e.rtpMap&&e.rtpMap.encodingName.toLowerCase()||"").includes(o)&&e&&e.fmtp&&e.fmtp.parameters["profile-level-id"]===r("H264_PROFILE_LEVEL_ID")))),!Array.isArray(s)||0===s.length){let t=[];const r=[],a=[],c=[];if(i.videoCodecs.forEach((e=>{const n=e.rtpMap&&e.rtpMap.encodingName.toLowerCase()||"";n.includes(o)?t.push(e):n.includes("vp9")?r.push(e):n.includes("vp8")?a.push(e):n.includes("h264")&&c.push(e)})),0===t.length){let n="";0!==r.length?(t=r,n="vp9"):0!==a.length?(t=a,n="vp8"):0!==c.length&&(t=c,n="h264"),e.warning("codec ".concat(o," not included in rtpCapabilities, fallback to default payloads: ").concat(n))}0!==t.length&&(s=n.videoCodecs.filter((e=>t.some((t=>t.payloadType===e.payloadType)))))}if(0===s.length&&(e.warning("codec ".concat(o," not included in rtpCapabilities, fallback to default payloads: ").concat(n.videoCodecs[0].rtpMap&&n.videoCodecs[0].rtpMap.encodingName)),s=n.videoCodecs),r("USE_PUB_RTX")||r("USE_SUB_RTX")){const e=ct(s,n.videoCodecs);s=[...s,...e]}}else{s=n.audioCodecs.filter((e=>(e.rtpMap&&e.rtpMap.encodingName.toLowerCase()||"").includes(o)));const t=n.audioCodecs.filter((e=>(e.rtpMap&&e.rtpMap.encodingName.toLowerCase()||"").includes("red")));0===s.length&&(e.warning("codec ".concat(o," not included in rtpCapabilities, fallback to opus")),s=n.audioCodecs.filter((e=>(e.rtpMap&&e.rtpMap.encodingName.toLowerCase()||"").includes("opus")))),r("ENABLE_AUDIO_RED")&&0!==t.length&&(s=[...t,...s])}return s}function ct(e,t){const n=e.map((e=>e.payloadType.toString()));return t.filter((e=>e.rtpMap&&"rtx"===e.rtpMap.encodingName&&e.fmtp&&e.fmtp.parameters.apt&&n.includes(e.fmtp&&e.fmtp.parameters.apt)))}async function dt(e,t,n){const i=t.toString(),o=lt(i,"offer","remote","exchangeSDP");await e.setRemoteDescription({type:"offer",sdp:i});const r=await e.createAnswer();if(!r.sdp)throw new Error("cannot get answer sdp");let s=r.sdp;s=pt(s,n||{}),null==o||o(s||""),await e.setLocalDescription({type:"answer",sdp:s})}function pt(e,t,n){if(r("FORBID_MODIFY_LOCAL_OFFER_SDP"))return e;const i=a(e),{useXR:o}=t;return i.mediaDescriptions.forEach((e=>{e.attributes.mid&&(Array.isArray(n)&&!n.includes(e.attributes.mid)||("audio"===e.media.mediaType&&st(e),"video"===e.media.mediaType&&function(e){if("video"!==e.media.mediaType)return;if(!r("ENABLE_DOWN_SPS_PPS"))return;e.attributes.payloads.filter((e=>{var t;return"h264"===(null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName.toLowerCase())})).forEach((e=>{e.fmtp||(e.fmtp={parameters:{}}),e.fmtp.parameters["sps-pps-idr-in-keyframe"]="1"}))}(e),o&&["audio","video"].includes(e.media.mediaType)&&e.attributes.payloads.forEach((e=>{-1===e.rtcpFeedbacks.findIndex((e=>"rrtr"===e.type))&&e.rtcpFeedbacks.push({type:"rrtr"})}))))})),p(i)}function lt(t,n,i,o){if(r("SDP_LOGGING"))return e.upload("exchanging ".concat(i," ").concat(n," SDP during P2PConnection.").concat(o,"\n"),t),"offer"===n?e=>{lt(e,"answer","local"===i?"remote":"local",o)}:void 0}async function ht(t,n,i){try{var o;if(!$().supportSetRtpSenderParameters)return;if(!function(e){return"vp9"===e||"av1"===e}(t)||!r("ENABLE_SVC"))return;const s={},a={},c=n.getParameters(),d=null===(o=c.encodings)||void 0===o?void 0:o[0];a.scalabilityMode=Ge(i),d&&Object.assign(d,a),Object.assign(c,s),await n.setParameters(c),e.debug("[updateAdaptation] updateRtpSenderEncodings scalabilityMode success: ".concat(JSON.stringify(c.encodings)))}catch(t){e.debug("[updateAdaptation] updateRtpSenderEncodings scalabilityMode failed",t)}}function ut(e){const t=r("COMPATIBLE_SDP_EXTENSION");return!!(Array.isArray(t)&&t.length>0)&&t.some((t=>e.includes(t)))}function Et(e,t){try{var n;return(null===(n=e.fmtp)||void 0===n?void 0:n.parameters.apt)===t.payloadType.toString()}catch(e){return!1}}const _t=e=>"v=0\no=- 0 0 IN IP4 127.0.0.1\ns=AgoraGateway\nt=0 0\na=group:BUNDLE 0 1 2\na=msid-semantic: WMS\na=ice-lite".concat(e?"\na=extmap-allow-mixed":"","\nm=video 9 UDP/TLS/RTP/SAVPF 0\nc=IN IP4 127.0.0.1\na=rtcp:9 IN IP4 0.0.0.0\na=sendonly\na=rtcp-mux\na=rtcp-rsize\na=mid:0\nm=audio 9 UDP/TLS/RTP/SAVPF 0\nc=IN IP4 127.0.0.1\na=rtcp:9 IN IP4 0.0.0.0\na=sendonly\na=rtcp-mux\na=rtcp-rsize\na=mid:1\nm=application 9 UDP/DTLS/SCTP webrtc-datachannel\nc=IN IP4 127.0.0.1\na=mid:2\n"),Ct="9",mt=2e4,Rt=4e4;class St{get localCapabilities(){return d(this._localCapabilities)}get rtpCapabilities(){return d(this._rtpCapabilities)}get candidates(){return d(this._candidates)}get iceParameters(){return d(this._iceParameters)}get dtlsParameters(){return d(this._dtlsParameters)}constructor(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],i=arguments.length>3&&void 0!==arguments[3]&&arguments[3];this.sessionDesc=void 0,this._localCapabilities=void 0,this._rtpCapabilities=void 0,this._candidates=void 0,this._originCandidates=void 0,this._iceParameters=void 0,this._isUseExtmapAllowMixed=void 0,this._isUseLocalCodecs=void 0,this._isUseDataChannel=void 0,this._dtlsParameters=void 0,this.setup=void 0,this.currentMidIndex=void 0,this.cname=void 0,this.useLocalCodecsMids=[],this.preloadSsrcs=[],this.firefoxSsrcMidMap=new Map,this._isUseExtmapAllowMixed=t,this._isUseLocalCodecs=n,this._isUseDataChannel=i,e=d(e);const{iceParameters:o,dtlsParameters:r,candidates:s,rtpCapabilities:a,setup:c,localCapabilities:p,cname:l}=e;this._rtpCapabilities=a,this._candidates=s,this._originCandidates=d(s),this._iceParameters=o,this._dtlsParameters=r,this._localCapabilities=p,this.setup=c,this.cname=l,[this.sessionDesc]=this.updateRemoteRTPCapabilities(a),this.currentMidIndex=this.sessionDesc.mediaDescriptions.length-1}checkPreloadSsrcs(e){return e.length===this.preloadSsrcs.length&&e.every((e=>this.preloadSsrcs.includes(e)))}preloadRemoteMedia(e){let t=0;const n=[],i=[];for(;e>0;){const o=[_e({ssrcId:Rt+t},r("USE_SUB_RTX")?{rtx:Rt+t+1}:{})],s="".concat(Rt+t,"_").concat(mt+t),{ssrcs:a,ssrcGroups:c}=Ze(o,this.cname,r("SYNC_GROUP")?s:void 0),d=this.preCreateOrRecycleSendMedia("video",a,c,void 0),p=[{ssrcId:mt+t}],l="".concat(Rt+t,"_").concat(mt+t),{ssrcs:h,ssrcGroups:u}=Ze(p,this.cname,r("SYNC_GROUP")?l:void 0),E=this.preCreateOrRecycleSendMedia("audio",h,u,void 0);e--,t+=2,n.push(d,E),i.push(a[0].ssrcId,h[0].ssrcId)}return this.useLocalCodecsMids.push(...n),this.preloadSsrcs=i,{mids:n,preSSRCs:i,isAvailable:!0}}preCreateOrRecycleSendMedia(t,n,i,o){const r=this.rtpCapabilities.send.videoCodecs,s=this._isUseLocalCodecs||0===r.length?this.localCapabilities.recv:this.rtpCapabilities.send;e.debug("create or recycle send media without remote rtp capabilities, ssrcs ",n[0].ssrcId);const a=t===we.VIDEO?s.videoCodecs:s.audioCodecs,c=t===we.VIDEO?s.videoExtensions:s.audioExtensions;this.currentMidIndex+=1;const d="".concat(this.currentMidIndex);let p={media:{mediaType:t,port:Ct,protos:["UDP","TLS","RTP","SAVPF"],fmts:a.map((e=>e.payloadType.toString(10)))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:c,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:n,ssrcGroups:i,rtcpFeedbackWildcards:[],payloads:a,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:"sendonly",rtcpMux:!0,rtcpRsize:!0,mid:"".concat(d)}};return p=this.mungSendMediaDesc(p,o),this.sessionDesc.mediaDescriptions.push(p),this.updateBundleMids(),d}toString(){return p(this.sessionDesc)}send(e,t,n,i){const{ssrcs:o,ssrcGroups:s}=Ze(t,this.cname,r("SYNC_GROUP")?n:void 0),a=this.findPreloadMediaDesc(o);if(a){if(c()&&this.firefoxSsrcMidMap.set(o[0].ssrcId,a.attributes.mid),i&&(i.twcc||i.remb)){const e=this.sessionDesc.mediaDescriptions.indexOf(a);return this.sessionDesc.mediaDescriptions[e]=this.mungSendMediaDesc(a,i),{mid:a.attributes.mid,needExchangeSDP:!0}}return{mid:a.attributes.mid,needExchangeSDP:!1}}{const t=this.findAvailableMediaIndex(e,o);let n;return-1===t||1===t&&(_()||C()||m(143)||R(143)||r("RESERVE_MID_1_MLINE")||r("ENABLE_ENCODED_TRANSFORM")&&S())||0===t&&!f(138)&&r("USE_SUB_RTX")||I()?(n=this.createOrRecycleSendMedia(e,o,s,"sendonly",i),this.updateBundleMids()):(n=d(this.sessionDesc.mediaDescriptions[t]),n.attributes.direction="sendonly",n.attributes.ssrcs=o,n.attributes.ssrcGroups=s,this.sessionDesc.mediaDescriptions[t]=this.mungSendMediaDesc(n,i)),c()&&this.firefoxSsrcMidMap.set(o[0].ssrcId,n.attributes.mid),{mid:n.attributes.mid,needExchangeSDP:!0}}}sendDataChannel(){const{mediaDesc:e,needExchangeSDP:t}=this.createOrRecycleDataChannel();return this.updateBundleMids(),{mid:e.attributes.mid,needExchangeSDP:t}}batchSend(e){const t=e.map((e=>{let{kind:t,ssrcMsg:n,mslabel:i}=e;return this.send(t,n,i)})),n=[];let i=!1;return t.forEach((e=>{let{mid:t,needExchangeSDP:o}=e;o&&(i=!0),n.push(t)})),{mids:n,needExchangeSDP:i}}stopSending(e){const t=this.sessionDesc.mediaDescriptions.filter((t=>t.attributes.mid&&-1!==e.indexOf(t.attributes.mid)));if(t.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.stopSending.");t.forEach((e=>{"0"===e.attributes.mid||c()||I()?e.attributes.ssrcs=[]:(e.attributes.ssrcs=[],e.attributes.direction="inactive",e.media.port="0")})),this.updateBundleMids()}mute(e){const t=this.sessionDesc.mediaDescriptions.find((t=>t.attributes.mid===e));if(!t)throw new Error("mediaDescription not found with ".concat(e," in remote SDP when calling RemoteSDP.mute."));t.attributes.direction="inactive"}unmute(e){const t=this.sessionDesc.mediaDescriptions.find((t=>t.attributes.mid===e));if(!t)throw new Error("mediaDescription not found with ".concat(e," in remote SDP when calling RemoteSDP.unmute."));t.attributes.direction="sendonly"}muteRemote(e){const t=this.sessionDesc.mediaDescriptions.filter((t=>e.includes(t.attributes.mid||"")));if(t.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");t.forEach((e=>{e.attributes.direction="inactive"}))}unmuteRemote(e){const t=this.sessionDesc.mediaDescriptions.filter((t=>e.includes(t.attributes.mid||"")));if(t.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");t.forEach((e=>{e.attributes.direction="recvonly"}))}receive(e,t,n,i){e.forEach(((e,o)=>{this.createOrRecycleRecvMedia(e,[],"recvonly",t,n,i[o])})),this.updateBundleMids()}stopReceiving(e){const t=this.sessionDesc.mediaDescriptions.filter((t=>-1!==e.indexOf(t.attributes.mid)));if(t.length!==e.length)throw new Error("MediaDescriptions' length doesn't match mids's length when calling RemoteSDP.receive.");t.forEach((e=>{e.media.port="0",e.attributes.direction="inactive"})),this.updateBundleMids()}updateRemoteRTPCapabilities(e){const t=this.sessionDesc||a((n=this._isUseExtmapAllowMixed,this._isUseDataChannel?_t(n):"v=0\no=- 0 0 IN IP4 127.0.0.1\ns=AgoraGateway\nt=0 0\na=group:BUNDLE 0 1\na=msid-semantic: WMS\na=ice-lite".concat(n?"\na=extmap-allow-mixed":"","\nm=video 9 UDP/TLS/RTP/SAVPF 0\nc=IN IP4 127.0.0.1\na=rtcp:9 IN IP4 0.0.0.0\na=sendonly\na=rtcp-mux\na=rtcp-rsize\na=mid:0\nm=audio 9 UDP/TLS/RTP/SAVPF 0\nc=IN IP4 127.0.0.1\na=rtcp:9 IN IP4 0.0.0.0\na=sendonly\na=rtcp-mux\na=rtcp-rsize\na=mid:1\n")));var n;this._rtpCapabilities=e;let i=!1;const o=this.rtpCapabilities.send,r=this.localCapabilities.send,s=this.localCapabilities.recv,c=s.videoCodecs,d=s.audioCodecs,p=s.videoExtensions,l=s.audioExtensions;for(const e of t.mediaDescriptions)if("sendonly"!==e.attributes.direction||"string"!=typeof e.attributes.mid||!this.useLocalCodecsMids.includes(e.attributes.mid)){if(i=!0,e.attributes.iceUfrag=this._iceParameters.iceUfrag,e.attributes.icePwd=this._iceParameters.icePwd,e.attributes.fingerprints=this._dtlsParameters.fingerprints,e.attributes.candidates=this._candidates,e.attributes.setup=this.setup,"application"===e.media.mediaType&&(e.attributes.sctpPort="5000"),"video"===e.media.mediaType)if(this._isUseLocalCodecs&&"sendonly"===e.attributes.direction){e.media.fmts=c.map((e=>e.payloadType.toString(10))),e.attributes.payloads=c,e.attributes.extmaps=p;const t=e.attributes.mid;"string"!=typeof t||this.useLocalCodecsMids.includes(t)||this.useLocalCodecsMids.push(t)}else if(0===o.videoCodecs.length){const t=r.videoCodecs.filter((e=>{var t;return null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName.toLowerCase().includes("vp8")}));0===t.length&&t.push(r.videoCodecs[0]),e.media.fmts=t.map((e=>e.payloadType.toString(10))),e.attributes.payloads=t,e.attributes.extmaps=[]}else e.media.fmts=o.videoCodecs.map((e=>e.payloadType.toString(10))),e.attributes.payloads=o.videoCodecs,e.attributes.extmaps=o.videoExtensions;if("audio"===e.media.mediaType)if(this._isUseLocalCodecs&&"sendonly"===e.attributes.direction){e.media.fmts=d.map((e=>e.payloadType.toString(10))),e.attributes.payloads=d,e.attributes.extmaps=l;const t=e.attributes.mid;"string"!=typeof t||this.useLocalCodecsMids.includes(t)||this.useLocalCodecsMids.push(t)}else if(0===o.audioCodecs.length){const t=r.audioCodecs.filter((e=>{var t;return null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName.toLowerCase().includes("opus")}))||[r.audioCodecs[0]];e.media.fmts=t.map((e=>e.payloadType.toString(10))),e.attributes.payloads=t,e.attributes.extmaps=[]}else e.media.fmts=o.audioCodecs.map((e=>e.payloadType.toString(10))),e.attributes.payloads=o.audioCodecs,e.attributes.extmaps=o.audioExtensions,st(e)}return this.sessionDesc=t,this.currentMidIndex=t.mediaDescriptions.length-1,[this.sessionDesc,i]}updateCandidates(e){const t=this._originCandidates.filter((e=>"udp"===e.transport)),n=[];if(t.forEach((e=>{n.push(_e(_e({},e),{},{foundation:"tcpcandidate",priority:Number(e.priority)-1+"",transport:"tcp",port:Number(e.port)+90+""}))})),0!==t.length){switch(e){case be.TCP_RELAY:this._candidates=n;break;case be.UDP_TCP_RELAY:case be.RELAY:this._candidates=[...t,...n];break;default:this._candidates=t}for(const e of this.sessionDesc.mediaDescriptions)e.attributes.candidates=this.candidates}}restartICE(e){e=d(e),this._iceParameters=e,this.sessionDesc.mediaDescriptions.forEach((t=>{t.attributes.iceUfrag=e.iceUfrag,t.attributes.icePwd=e.icePwd}))}predictReceivingMids(e){const t=[];for(let n=0;n<e;n++)t.push((this.currentMidIndex+n+1).toString(10));return t}findAvailableMediaIndex(e,t){return this.sessionDesc.mediaDescriptions.findIndex((n=>{const i=n.media.mediaType===e&&"0"!==n.media.port&&("sendonly"===n.attributes.direction||"sendrecv"===n.attributes.direction)&&0===n.attributes.ssrcs.length;if(c()){if(i){const e=this.firefoxSsrcMidMap.get(t[0].ssrcId);return!(e||"0"!==n.attributes.mid&&"1"!==n.attributes.mid)||!(!e||e!==n.attributes.mid)}return!1}return i}))}createOrRecycleDataChannel(){for(const e of this.sessionDesc.mediaDescriptions)if("application"===e.media.mediaType)return{mediaDesc:e,needExchangeSDP:!1};this.currentMidIndex+=1;const e="".concat(this.currentMidIndex),t={media:{mediaType:"application",port:Ct,protos:["UDP","DTLS","SCTP"],fmts:["webrtc-datachannel"]},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:[],fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:[],ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:[],rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,mid:"".concat(e),sctpPort:"5000"}};return this.sessionDesc.mediaDescriptions.push(t),{mediaDesc:t,needExchangeSDP:!0}}createOrRecycleRecvMedia(e,t,n,i,o,r){const s=e._mediaStreamTrack.kind,a=this.rtpCapabilities.recv,c=at(s,a,this.localCapabilities.send,s===we.VIDEO?i:o),d=s===we.VIDEO?a.videoExtensions:a.audioExtensions;this.currentMidIndex+=1;const p="".concat(this.currentMidIndex);let l={media:{mediaType:s,port:Ct,protos:["UDP","TLS","RTP","SAVPF"],fmts:c.map((e=>e.payloadType.toString(10)))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:d,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:t,ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:c,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:n,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(p)}};l=this.mungRecvMediaDsec(l,e,r);const h=this.findFirstClosedMedia(s);if(h){const e=this.sessionDesc.mediaDescriptions.indexOf(h);this.sessionDesc.mediaDescriptions[e]=l}else this.sessionDesc.mediaDescriptions.push(l);return l}updateRemoteDtlsParameters(e){const t=new Set(this._dtlsParameters.fingerprints.map((e=>e.fingerprint))),n=new Set(e.map((e=>e.fingerprint)));let i=!1;t.size!==n.size&&(i=!0);for(const e of t)n.has(e)||(i=!0);return i}updateRemoteCodec(t,n,i){const o=[...new Set(this._rtpCapabilities.recv.videoCodecs.map((e=>e.rtpMap&&e.rtpMap.encodingName.toLowerCase()||"")).filter((e=>Object.keys(N).includes(e))))],s=new Set(n);if(o.every((e=>s.has(e))))return e.debug("codecs has not changed, no need to updateRemoteCodec, codecs: ".concat(n)),!1;const a=this._rtpCapabilities.recv.videoCodecs.filter((e=>n.some((t=>(e.rtpMap&&e.rtpMap.encodingName.toLowerCase()||"").includes(t)))));if(0===a.length)return e.debug("updateRemoteCodec failed, because cannot find matched codec, remoteCapabilities codecs: ".concat(o," codecs: ").concat(n)),!1;const c=[...new Set(a.map((e=>e.rtpMap&&e.rtpMap.encodingName.toLowerCase()||"")))];let d;if(e.debug("updateRemoteCodec, from ".concat(o," to ").concat(c)),0===t.length)d=this.sessionDesc.mediaDescriptions.filter((e=>"video"===e.media.mediaType&&"recvonly"===e.attributes.direction));else if(d=this.sessionDesc.mediaDescriptions.filter((e=>e.attributes.mid&&"video"===e.media.mediaType&&t.includes(e.attributes.mid)&&"recvonly"===e.attributes.direction)),d.length!==t.length)return e.debug("updateRemoteCodec failed, because cannot find mids, mids: ".concat(t,", codecs: ").concat(n)),!1;if(r("USE_PUB_RTX")||r("USE_SUB_RTX")){const e=ct(a,this.rtpCapabilities.recv.videoCodecs);a.push(...e)}this._rtpCapabilities.recv.videoCodecs=a;const p=this.localCapabilities.send,l=this.rtpCapabilities.recv,h=at(we.VIDEO,l,p,i);return d.forEach((t=>{const n=h.map((e=>e.payloadType.toString(10)));e.debug("updateRemoteCodec mid: ".concat(t.attributes.mid,", from"),t.attributes.payloads,"to",h),t.attributes.payloads=h,t.media.fmts=n})),e.debug("updateRemoteCodec success, mids: ".concat(t,", codecs: ").concat(n,", remote recv: ").concat(this._rtpCapabilities.recv.videoCodecs.length,", remote send: ").concat(this._rtpCapabilities.send.videoCodecs.length)),!0}createOrRecycleSendMedia(e,t,n,i,o){const r=this.rtpCapabilities.send.videoCodecs,s=this._isUseLocalCodecs||0===r.length?this.localCapabilities.recv:this.rtpCapabilities.send,a=e===we.VIDEO?s.videoCodecs:s.audioCodecs,c=e===we.VIDEO?s.videoExtensions:s.audioExtensions;this.currentMidIndex+=1;const d="".concat(this.currentMidIndex);let p={media:{mediaType:e,port:Ct,protos:["UDP","TLS","RTP","SAVPF"],fmts:a.map((e=>e.payloadType.toString(10)))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:c,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:t,ssrcGroups:n,rtcpFeedbackWildcards:[],payloads:a,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:i,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(d)}};p=this.mungSendMediaDesc(p,o);const l=this.findFirstClosedMedia(e);if(l){const e=this.sessionDesc.mediaDescriptions.indexOf(l);this.sessionDesc.mediaDescriptions[e]=p}else this.sessionDesc.mediaDescriptions.push(p);return p}updateBundleMids(){this.sessionDesc.attributes.groups[0].identificationTag=this.sessionDesc.mediaDescriptions.filter((e=>"0"!==e.media.port)).map((e=>e.attributes.mid))}mungRecvMediaDsec(e,t,n){const i=d(e);return function(e){const t=e.attributes.unrecognized.findIndex((e=>"x-google-flag"===e.attField&&"conference"===e.attValue));-1!==t&&e.attributes.unrecognized.splice(t,1)}(i),$e(i,t),function(e,t){if(e.attributes.payloads.forEach((e=>{var t;"h264"===(null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName.toLowerCase())&&e.fmtp&&e.fmtp.parameters&&r("ENABLE_UP_SPS_PPS")&&(e.fmtp.parameters["sps-pps-idr-in-keyframe"]="1")})),!(t instanceof Z&&t._encoderConfig&&-1===t._hints.indexOf(ee.SCREEN_TRACK)))return;const n=t._encoderConfig;$().supportMinBitrate&&n.bitrateMin&&e.attributes.payloads.forEach((e=>{var t;["h264","h265","vp8","vp9","av1"].includes((null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName.toLowerCase())||"")&&(e.fmtp||(e.fmtp={parameters:{}}),e.fmtp.parameters["x-google-min-bitrate"]="".concat(n.bitrateMin))})),$().supportMinBitrate&&!t._hints.includes(ee.LOW_STREAM)&&n.bitrateMax&&e.attributes.payloads.forEach((e=>{var t;["h264","h265","vp8","vp9","av1"].includes((null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName.toLowerCase())||"")&&(e.fmtp||(e.fmtp={parameters:{}}),e.fmtp.parameters["x-google-start-bitrate"]="".concat(r("X_GOOGLE_START_BITRATE")||Math.floor(n.bitrateMax)))}))}(i,t),function(e){if("video"!==e.media.mediaType)return;const t=h();if(t.name!==u.SAFARI&&t.os!==E.IOS)return;const n=e.attributes.extmaps.findIndex((e=>/video-orientation/g.test(e.extensionName)));-1!==n&&e.attributes.extmaps.splice(n,1)}(i),et(i,n,this.localCapabilities.send),i}mungSendMediaDesc(e,t){const n=d(e);return n.attributes&&n.attributes.payloads&&Array.isArray(n.attributes.payloads)&&n.attributes.payloads.length>0&&n.attributes.payloads.forEach((e=>{e.rtpMap&&"h264"===e.rtpMap.encodingName.toLocaleLowerCase()&&r("ENABLE_DOWN_SPS_PPS")&&(e.fmtp&&e.fmtp.parameters||(e.fmtp={parameters:{}}),e.fmtp.parameters["sps-pps-idr-in-keyframe"]="1")})),et(n,t,this.localCapabilities.recv),st(n),n}updateRecvMedia(e,t){const n=this.sessionDesc.mediaDescriptions.findIndex((t=>t.attributes.mid===e));if(-1!==n){const e=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[n],t);this.sessionDesc.mediaDescriptions[n]=e}}bumpMid(e){this.currentMidIndex+=e}findFirstClosedMedia(e){return this.sessionDesc.mediaDescriptions.find((t=>c()?"0"===t.media.port&&t.media.mediaType===e:"0"===t.media.port))}findPreloadMediaDesc(e){return this.sessionDesc.mediaDescriptions.find((t=>{var n;return(null===(n=t.attributes)||void 0===n||null===(n=n.ssrcs[0])||void 0===n?void 0:n.ssrcId)===e[0].ssrcId}))}getSSRC(e){var t;return null===(t=this.sessionDesc.mediaDescriptions.find((t=>t.attributes.mid===e)))||void 0===t?void 0:t.attributes.ssrcs}}var ft=function(e){return e[e.DOWN=0]="DOWN",e[e.UP=1]="UP",e}(ft||{});const It=new Map;function Nt(e,t,n,i){let{scale:o}=e;if(0===o&&i===ft.UP||o>=t.length-1&&i===ft.DOWN)return e;let r=_e(_e({},e),{},{scale:i===ft.DOWN?++o:--o});switch(n){case"maintain-framerate":r=_e(_e({},r),t[o].motion);break;case"maintain-resolution":r=_e(_e({},r),t[o].detail);break;case"balanced":r=_e(_e({},r),t[o].balanced)}return r}function gt(e,t){if(t){const n={overUse:0,underUse:0,adaptationList:Tt(t)};It.set(e,n)}else It.delete(e)}function Tt(e){const t=_e({},e),{bitrateMax:n,frameRate:i,scaleResolutionDownBy:o,bitrateMin:r}=t,{MIN_FRAME_RATE:s,MAX_THRESHOLD_FRAMERATE:a,MAX_SCALE:c,BITRATE_MIN_THRESHOLD:d,BITRATE_MAX_THRESHOLD:p,BWE_SCALE_UP_THRESHOLD:l,BWE_SCALE_DOWN_THRESHOLD:h,PERF_SCALE_DOWN_THRESHOLD:u,PERF_SCALE_UP_THRESHOLD:E,BALANCE_BITRATE_FACTOR:_,BALANCE_FRAMERATE_FACTOR:C,BALANCE_RESOLUTION_FACTOR:m,MOTION_RESOLUTION_FACTOR:R,MOTION_BITRATE_FACTOR:S,DETAIL_FRAMERATE_FACTOR:f,DETAIL_BITRATE_FACTOR:I}=T,N=Math.min(t.frameRate,a),g=[{scale:0,threshold:{bwe_down:Math.round(Math.pow(h,1)*n),bwe_up:n,fps_down:Math.round(Math.pow(u,1)*N),fps_up:i},balanced:{scaleResolutionDownBy:1,frameRate:i,bitrateMax:n,bitrateMin:r},motion:{scaleResolutionDownBy:1,frameRate:i,bitrateMax:n,bitrateMin:r},detail:{scaleResolutionDownBy:1,frameRate:i,bitrateMax:n,bitrateMin:r}}];for(let e=1;e<=c;e++){const t={bwe_up:Math.round(Math.pow(l,e)*n),bwe_down:Math.round(Math.pow(h,e+1)*n),fps_up:Math.round(Math.pow(E,e)*N),fps_down:Math.round(Math.pow(u,e+1)*N)},a={scaleResolutionDownBy:o/Math.pow(m,e),frameRate:Math.max(Math.round(Math.pow(C,e)*i),s),bitrateMax:Math.max(Math.round(Math.pow(_,e)*n),p),bitrateMin:Math.max(Math.round(Math.pow(_,e)*r),d)},c={scaleResolutionDownBy:o/Math.pow(R,e),frameRate:i,bitrateMax:Math.max(Math.round(Math.pow(S,e)*n),p),bitrateMin:Math.max(Math.round(Math.pow(S,e)*r),d)},T={scaleResolutionDownBy:1,frameRate:Math.max(Math.round(Math.pow(f,e)*i),s),bitrateMax:Math.max(Math.round(Math.pow(I,e)*n),p),bitrateMin:Math.max(Math.round(Math.pow(I,e)*r),d)};g.push({scale:e,threshold:t,balanced:a,motion:c,detail:T})}return g}function At(e,t,n,i,o,s){const a=It.get(e)||{overUse:0,underUse:0,adaptationList:Tt(o)},{adaptationList:c}=a;It.set(e,a);const{OVERUSE_TIMES_THRESHOLD:d,UNDERUSE_TIMES_THRESHOLD:p}=T,{scale:l}=i;let h,u;return"number"==typeof t&&t>0&&function(e,t,n,i){if(t>=n.length)return!1;let{threshold:{fps_down:o}}=n[t];return r("FORCE_AG_HIGH_FRAMERATE")&&"maintain-framerate"===i&&(o=n[0].threshold.fps_down),e<o}(t,l,c,s)&&(a.overUse++,u=g.CPU,a.overUse>d)||"number"==typeof n&&n>0&&function(e,t,n){if(t>=n.length)return!1;const{threshold:{bwe_down:i}}=n[t];return e<i}(n,l,c)&&(a.overUse++,u=g.BANDWIDTH,a.overUse>d)?(a.overUse=0,a.underUse=0,h=Nt(i,c,s,ft.DOWN),[h,u]):("number"==typeof t&&t>0&&"number"==typeof n&&n>0&&function(e,t,n,i){if(0===t)return;let{threshold:{fps_up:o}}=n[t];return r("FORCE_AG_HIGH_FRAMERATE")&&"maintain-framerate"===i&&(o=n[1].threshold.fps_up),e>o}(t,l,c,s)&&function(e,t,n){if(0===t)return;const{threshold:{bwe_up:i}}=n[t];return e>i}(n,l,c)&&(a.underUse++,a.underUse>p&&(a.overUse=0,a.underUse=0,h=Nt(i,c,s,ft.UP),0===h.scale&&(u=g.NONE))),[h,u])}function Dt(e){return!!r("ENABLE_AG_ADAPTATION")&&(!!(e instanceof te||e._hints.includes(ee.CUSTOM_TRACK))&&(!!r("FORCE_SUPPORT_AG_ADAPTATION")||!!(A(14,0,!1)&&D(17,4,!0)||v(14)&&O(17,4,!0))))}const vt=new Map;function Ot(t,n,i,o,s,a){if(Pt(t,i),s(n),"balanced"!==o&&"maintain-framerate"!==o&&"maintain-resolution"!==o)return;let c=-1;gt(t,n);const d=window.setInterval((()=>{const d=vt.get(t);if(!r("ENABLE_AG_ADAPTATION")||!d)return Pt(t,i),void s(n);const p=a();if(p.sendPackets>0&&p.OutgoingAvailableBandwidth>0){if(-1===c)return void(c=Date.now());if(Date.now()-c<1e3)return;const r=p.sendFrameRate,a=p.OutgoingAvailableBandwidth,[l,h]=At(t,r,a,d.adaptationConfig,n,o);h&&(i.qualityLimitationReason=h),l&&d.adaptationConfig.scale!==l.scale&&(e.debug("[".concat(t,"] applyAdaptation: ").concat(i.qualityLimitationReason,"\n           sendFps ").concat(r,", bwe ").concat(a,", switch from ").concat(d.adaptationConfig.scale," to ").concat(l.scale," ")),d.adaptationConfig=_e(_e({},d.adaptationConfig),l),s(l))}}),r("CHECK_LOCAL_STATS_INTERVAL")),p=_e({},n);vt.set(t,{timer:d,adaptationConfig:p,originConfig:n,adaptationFunc:s}),e.debug("[".concat(t,"] start adaptation, originConfig: ").concat(JSON.stringify(n),", degradationPreference: ").concat(o))}function Pt(e,t){const n=vt.get(e);if(n){const{timer:t}=n;window.clearTimeout(t),vt.delete(e)}t.qualityLimitationReason=g.NONE,gt(e)}var yt;function Lt(e,t,n){const i=e[t];if("function"!=typeof i)throw new Error("Cannot use mutex on object property.");return n.value=async function(){const e=this.mutex,n=await e.lock("From P2PConnection.".concat(t));try{for(var o=arguments.length,r=new Array(o),s=0;s<o;s++)r[s]=arguments[s];return await i.apply(this,r)}finally{n()}},n}function wt(e){try{if(e.iceServers)return!1;if(e.turnServer&&"off"!==e.turnServer.mode){if(x(e.turnServer.servers))return!1;if(r("FORCE_TURN_TCP")||e.turnServer.servers.concat(e.turnServer.serversFromGateway||[]).some((e=>e.forceturn)))return!0}return!1}catch(e){return!1}}var bt;ce((yt=class n extends Le{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get dtlsTransportState(){var e,t;return null!==(e=null===(t=this.peerConnection.getReceivers()[0])||void 0===t||null===(t=t.transport)||void 0===t?void 0:t.state)&&void 0!==e?e:null}get localCodecs(){return[...new Set(this.localCapabilities&&this.localCapabilities.send.videoCodecs.map((e=>e.rtpMap&&e.rtpMap.encodingName.toLowerCase()||"")).filter((e=>Object.keys(N).includes(e))))]}constructor(e,t){super(e,t),this.id=l(5,"connection-"),this.store=void 0,this.peerConnection=void 0,this.forceTurn=!1,this.remoteSDP=void 0,this.initialOffer=void 0,this.transportEventReceiver=void 0,this.statsFilter=void 0,this.extension={useXR:r("USE_XR")},this.localCapabilities=void 0,this.remoteCodecs=void 0,this.localCandidateCount=0,this.allCandidatesReceived=!1,this.isPreallocation=!1,this.isPreRender=!1,this.preMediaMap=new Map,this.dataStreamChannelMap=new Map,this.establishPromise=void 0,this.recoveredDataChannelIds=[],this.currentDataChannelId=1,this.supportAV1RtpSpec=!1,this.mutex=void 0,this.qualityLimitationReason=g.NONE,this.isFirstConnected=!1,this.store=t,this.forceTurn=wt(e),this.mutex=new P("P2PConnection-mutex",t.clientId),this.peerConnection=new RTCPeerConnection(n.resolvePCConfiguration(e),{optional:[{googDscp:!0}]}),this.isFirstConnected=!1,this.statsFilter=y(this.peerConnection,r("STATS_UPDATE_INTERVAL"),void 0,c()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1,e.isPreallocation&&(this.isPreallocation=!0),this.establishPromise=this.establish()}getPreMedia(e){return this.preMediaMap.get(e)}isPreSub(){return this.preMediaMap.size>0}async updateRemoteRTPCapabilities(t,n){if(this.remoteCodecs=n,!this.remoteSDP)return void e.debug("[P2PConnection] cannot updateRemoteRTPCapabilities before remote SDP created, local codecs: ".concat(this.localCodecs,", codecs: ").concat(n));if(this.remoteSDP.updateRemoteCodec(t,n,this.store.codec)){const e=await this.peerConnection.createOffer(),t=this.logSDPExchange(e.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(e);const n=this.remoteSDP.toString();null==t||t(n),await this.peerConnection.setRemoteDescription({type:"answer",sdp:n})}else e.debug("[P2PConnection] updateRemoteRTPCapabilities no need to exchange SDP.")}async establish(){try{this.peerConnection.addTransceiver("video",{direction:"recvonly"}),this.peerConnection.addTransceiver("audio",{direction:"recvonly"});const t=await this.peerConnection.createOffer();if(!t.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");const n=qe(t.sdp),i=await it({filterRTX:!r("USE_PUB_RTX")&&!r("USE_SUB_RTX"),filterVideoFec:r("FILTER_VIDEO_FEC"),filterAudioFec:r("FILTER_AUDIO_FEC"),filterVideoCodec:r("FILTER_VIDEO_CODEC"),unsupportedVideoUplinkCodec:r("UNSUPPORTED_VIDEO_UPLINK_CODEC"),unsupportedVideoDownlinkCodec:r("UNSUPPORTED_VIDEO_DOWNLINK_CODEC")},this.extension);if(this.localCapabilities=rt(i),this.initialOffer=t,r("ENABLE_SVC")&&"av1"==this.store.codec){const t=await nt();var e;if(t)this.supportAV1RtpSpec=!0,null===(e=i.send)||void 0===e||e.videoExtensions.push(t)}let o;return t.sdp&&ut(t.sdp)&&(o=d(i),Ke(o)),_e(_e({},n),{},{rtpCapabilities:o||i,offerSDP:t.sdp})}catch(e){throw new L(w.GET_LOCAL_CONNECTION_PARAMS_FAILED,e.toString())}}async connect(t){try{if(!this.initialOffer)throw new Error("Cannot establish P2PConnection without initial offer.");this.initialOffer.sdp&&ut(this.initialOffer.sdp)&&We(t.rtpCapabilities,this.localCapabilities),this.remoteSDP=new St(_e(_e({},t),{},{localCapabilities:this.localCapabilities}),this.supportAV1RtpSpec,!(!r("ENABLE_PRE_SUB_WITH_PRE_PC")||!r("PRE_USE_LOCAL_CODECS"))&&ne(this.store)),t.preallocation&&(this.isPreallocation=!0),Array.isArray(this.remoteCodecs)&&this.remoteCodecs.length>0&&this.remoteSDP.updateRemoteCodec([],this.remoteCodecs,this.store.codec);const n=this.remoteSDP.toString(),i=pt(this.initialOffer.sdp,this.extension),o=this.logSDPExchange(i||"","offer","local","connect");this.store.descriptionStart(),await this.peerConnection.setLocalDescription({type:"offer",sdp:i}),null==o||o(n),await this.peerConnection.setRemoteDescription({type:"answer",sdp:n});const s=this.peerConnection.getTransceivers()[0];if(null!=s&&s.receiver&&this.tryBindTransportEvents(s.receiver),ne(this.store))if(t.preallocation&&r("ENABLE_PRE_SUB_WITH_PRE_PC")){const t=r("PRE_SUB_NUM"),{mids:n,preSSRCs:i}=this.remoteSDP.preloadRemoteMedia(t);await dt(this.peerConnection,this.remoteSDP,this.extension),e.debug("[".concat(this.store.clientId,"] [P2PConnection] preload media, in pre pc,add preload ssrcs ").concat(i)),this.presetMedia(n,i)}else{const{preSSRCs:n=[]}=t,i=n.map((e=>e.ssrcMsg[0].ssrcId));if(0===n.length)return;const{mids:o}=this.remoteSDP.batchSend(n.map((e=>Object.assign({},e))));await dt(this.peerConnection,this.remoteSDP,this.extension),e.debug("[P2PConnection.connect] preload media, after join, add preload ssrcs ".concat(i)),this.presetMedia(o,i)}}catch(e){throw new L(w.EXCHANGE_SDP_FAILED,"P2PConnection.connect failed; ".concat(e.toString()))}}presetMedia(e,t){e.forEach(((e,n)=>{this.peerConnection.getTransceivers().forEach((i=>{if(null!=i.mid&&e===i.mid&&i.receiver.track){const o=i.receiver.track;let s;"video"===o.kind&&r("ENABLE_PRE_RENDER")&&(s=new ie({trackId:"track-".concat(o.kind,"-unknown-").concat(this.store.clientId,"_").concat(l(5,""))},!0),s.updateVideoTrack(o),s.onFirstVideoFrameRender=()=>{var e;const i=this.preMediaMap.get(t[n]);i&&(i.firstVideoRender=Date.now()),null===(e=this.onFirstVideoRender)||void 0===e||e.call(this,t[n])},s.onVideoBufferReady=()=>{var e;null===(e=this.onFirstVideoBufferReady)||void 0===e||e.call(this,t[n])},s.play(this.store.sessionId||void 0),this.isPreRender=!0),this.preMediaMap.set(t[n],{mid:e,track:o,player:s,transceiver:i})}})),this.store.peerReceiver()}))}checkDtlsParameters(e){return!!this.remoteSDP&&(e.length>0&&this.remoteSDP.updateRemoteDtlsParameters(e))}async updateRemoteConnect(n){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.updateRemoteConnect before remote SDP created");let i=!1;const{rtpCapabilities:o}=n;if([,i]=this.remoteSDP.updateRemoteRTPCapabilities(o),Array.isArray(this.remoteCodecs)&&this.remoteCodecs.length>0){const e=this.remoteSDP.updateRemoteCodec([],this.remoteCodecs,this.store.codec);i=i||e}const{preSSRCs:r=[]}=n,s=r.map((e=>e.ssrcMsg[0].ssrcId));if(!this.remoteSDP.checkPreloadSsrcs(s)){const n=[],i=[];if(Array.from(this.preMediaMap.entries()).every((e=>{let[t,{mid:o,player:r,track:s}]=e;return n.push(o),i.push(t),this.preMediaMap.delete(t),r&&r.destroy(),!0})),n.length>0&&(this.remoteSDP.stopSending(n),await dt(this.peerConnection,this.remoteSDP,this.extension),e.warn("[P2PConnection.updateRemoteConnect] preload media, failed, del preload ssrcs ".concat(i)),t.reportApiInvoke(this.store.sessionId,{name:b.PRELOAD_MEDIA_FAILED,options:[r,i],tag:M.TRACER}).onSuccess()),r.length>0){const{mids:t}=this.remoteSDP.batchSend(r.map((e=>Object.assign({},e))));await dt(this.peerConnection,this.remoteSDP,this.extension),e.debug("[P2PConnection.updateRemoteConnect] preload media, after join, add preload ssrcs ".concat(s)),this.presetMedia(t,s)}}i?(await dt(this.peerConnection,this.remoteSDP,this.extension),e.debug("[P2PConnection] updateRemoteConnect by exchanging SDP.")):e.debug("[P2PConnection] updateRemoteConnect no need to exchange SDP, because no need to update remote codecs (use local codecs)")}catch(e){throw new L(w.EXCHANGE_SDP_FAILED,"P2PConnection.updateRemoteConnect failed; ".concat(e.toString()))}}send(e,t,n){var i=this;return Ce((function*(){const o=yield he(i.mutex.lock("From P2PConnection.send"));try{if(!i.remoteSDP)throw new Error("Cannot call P2PConnection.send before remote SDP created");const s=[],d=Ge();e.forEach((e=>{const t=i.peerConnection.addTransceiver(e._mediaStreamTrack,_e({direction:"sendonly"},"video"===e.trackMediaType&&i.supportAV1RtpSpec&&d?{sendEncodings:[{scalabilityMode:d}]}:{}));s.push(t),e._updateRtpTransceiver(t)})),c()&&!0===r("SIMULCAST")&&(yield he(i.applySimulcastForFirefox(s,e)));const p=yield he(i.peerConnection.createOffer()),l=i.remoteSDP.predictReceivingMids(e.length),h=i.mungSendOfferSDP(p.sdp,e,l),u=a(h),E=l.map((e=>{const t=u.mediaDescriptions.find((t=>t.attributes.mid===e));if(!t)throw new Error("Cannot extract ssrc from mediaDescription.");return ze(t,r("USE_PUB_RTX"))}));let _;try{_=yield E}catch(o){_=[],i.remoteSDP.receive(e,t,n,_);const r=i.remoteSDP.toString();throw yield he(i.peerConnection.setLocalDescription({type:"offer",sdp:h})),yield he(i.peerConnection.setRemoteDescription({type:"answer",sdp:r})),yield he(i.stopSending(l,!0)),o}i.remoteSDP.receive(e,t,n,_);const C=i.remoteSDP.toString(),m=i.logSDPExchange(h,"offer","local","send");return yield he(i.peerConnection.setLocalDescription({type:"offer",sdp:h})),yield he(i.applySimulcastEncodings(s,e)),yield he(i.applySendEncodings(s,e)),null==m||m(C),yield he(i.peerConnection.setRemoteDescription({type:"answer",sdp:C})),s.map(((e,t)=>{const n=l[t];return{localSSRC:E[t],id:n,transceiver:e}}))}catch(e){throw e instanceof L?e:new L(w.EXCHANGE_SDP_FAILED,"P2PConnection.send failed; ".concat(e.toString()))}finally{o()}}))()}async createDataChannels(t,n){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.createDataChannels before remote SDP created");let i=this.dataStreamChannelMap.get(t);if(i&&"open"===i.readyState)e.debug("[P2PConnection] Channels are already available and can be reused directly.");else{const e=this.currentDataChannelId<1023?this.currentDataChannelId++:this.recoveredDataChannelIds.shift();if("number"!=typeof e)throw new Error("create DataChannel error, because cannot get dc id");i=this.peerConnection.createDataChannel("datastream-channel",{id:e,negotiated:!0,ordered:!1,maxRetransmits:r("DATASTREAM_MAX_RETRANSMITS")}),i.binaryType="arraybuffer",this.dataStreamChannelMap.set(t,i)}n.forEach((e=>{e._updateOriginDataChannel(i)}));const{needExchangeSDP:o}=this.remoteSDP.sendDataChannel();if(o){const t=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:t});const n=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(n),e.debug("[P2PConnection] createDataChannels by exchanging SDP.")}else e.debug("[P2PConnection] createDataChannels no need to exchange SDP.");return}catch(e){throw e instanceof L?e:new L(w.EXCHANGE_SDP_FAILED,"P2PConnection.createDataChannels failed; ".concat(e.toString()))}}async stopDataChannels(e){try{const t=this.dataStreamChannelMap.get(e);return t&&(t.id&&this.recoveredDataChannelIds.push(t.id),t.close()),void this.dataStreamChannelMap.delete(e)}catch(e){throw e instanceof L?e:new L(w.DATACHANNEL_FAILED,"P2PConnection.stopDataChannels failed; ".concat(e.toString()))}}async stopSending(e,t){const n=t?void 0:await this.mutex.lock("From P2PConnection.stopSending");try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopSending before remote SDP created");const t=this.peerConnection.getTransceivers().filter((t=>-1!==e.indexOf(t.mid)));if(t.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length when trying to call P2PConnection.stopSending.");t.map((e=>{var t;Pt(this.id+e.mid,this),e.direction="inactive",null===(t=e.stop)||void 0===t||t.call(e)}));const i=await this.peerConnection.createOffer(),o=this.logSDPExchange(i.sdp||"","offer","local","stopSending");await this.peerConnection.setLocalDescription(i),this.remoteSDP.stopReceiving(e);const r=this.remoteSDP.toString();null==o||o(r),await this.peerConnection.setRemoteDescription({type:"answer",sdp:r})}catch(e){throw new L(w.EXCHANGE_SDP_FAILED,"P2PConnection.stopSending failed; ".concat(e.toString()))}finally{n&&n()}}async receive(t,n,i,o){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(t," before remoteSDP created."));const{mid:r,needExchangeSDP:s}=this.remoteSDP.send(t,n,i,o);s&&(await dt(this.peerConnection,this.remoteSDP,this.extension),e.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(t," by exchanging SDP.")));const a=this.peerConnection.getTransceivers().find((e=>e.mid===r));if(!a)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:a.receiver.track,id:r,transceiver:a}}catch(e){throw new L(w.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(e.toString()))}}async batchReceive(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.batchReceive before remoteSDP created.");const{mids:n,needExchangeSDP:i}=this.remoteSDP.batchSend(t);return i&&(await dt(this.peerConnection,this.remoteSDP,this.extension),e.debug("[".concat(this.store.clientId,"] [P2PConnection] batchReceive by exchanging SDP."))),n.map((e=>{const t=this.peerConnection.getTransceivers().find((t=>t.mid===e));if(!t)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:t.receiver.track,id:e,transceiver:t}}))}catch(e){throw new L(w.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(e.toString()))}}async stopReceiving(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");e.forEach((e=>{Array.from(this.preMediaMap.entries()).some((t=>{let[n,{mid:i,player:o}]=t;if(i===e)return this.preMediaMap.delete(n),o&&o.destroy(),!0}))})),this.remoteSDP.stopSending(e);const t=this.remoteSDP.toString(),n=this.logSDPExchange(t,"offer","remote","stopReceiving");await this.peerConnection.setRemoteDescription({type:"offer",sdp:t});const i=await this.peerConnection.createAnswer();null==n||n(i.sdp||""),await this.peerConnection.setLocalDescription(i)}catch(e){throw new L(w.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(e.toString()))}}async muteRemote(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteRemote mid=".concat(e," before remote SDP created."));this.remoteSDP.mute(e);const t=this.remoteSDP.toString(),n=this.logSDPExchange(t,"offer","remote","muteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:t});const i=await this.peerConnection.createAnswer();null==n||n(i.sdp||""),await this.peerConnection.setLocalDescription(i)}catch(e){throw new L(w.EXCHANGE_SDP_FAILED,"P2PConnection.muteRemote failed; ".concat(e.toString()))}}async unmuteRemote(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteRemote mid=".concat(e," before remote SDP created."));this.remoteSDP.unmute(e);const t=this.remoteSDP.toString(),n=this.logSDPExchange(t,"offer","remote","unmuteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:t});const i=await this.peerConnection.createAnswer();null==n||n(i.sdp||""),await this.peerConnection.setLocalDescription(i)}catch(e){throw new L(w.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteRemote failed; ".concat(e.toString()))}}async muteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteLocal before remote SDP created.");const t=this.peerConnection.getTransceivers().filter((t=>t.mid&&-1!==e.indexOf(t.mid)));if(t.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length.");t.map((e=>{e.direction="inactive"}));const n=await this.peerConnection.createOffer(),i=this.logSDPExchange(n.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(n),this.remoteSDP.muteRemote(e);const o=this.remoteSDP.toString();null==i||i(o),await this.peerConnection.setRemoteDescription({type:"answer",sdp:o})}catch(e){throw new L(w.EXCHANGE_SDP_FAILED,"P2PConnection.muteLocal failed; ".concat(e.toString()))}}async unmuteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteLocal before remote SDP created.");const t=this.peerConnection.getTransceivers().filter((t=>t.mid&&-1!==e.indexOf(t.mid)));if(t.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length.");t.map((async(e,t)=>{e.direction="sendonly"}));const n=await this.peerConnection.createOffer(),i=this.logSDPExchange(n.sdp||"","offer","local","unmuteLocal");await this.peerConnection.setLocalDescription(n),this.remoteSDP.unmuteRemote(e),Array.isArray(this.remoteCodecs)&&this.remoteCodecs.length>0&&this.remoteSDP.updateRemoteCodec(e,this.remoteCodecs,this.store.codec);const o=this.remoteSDP.toString();null==i||i(o),await this.peerConnection.setRemoteDescription({type:"answer",sdp:o})}catch(e){throw new L(w.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteLocal failed; ".concat(e.toString()))}}restartICE(t){var n=this;return Ce((function*(){const i=yield he(n.mutex.lock("From P2PConnection.restartICE"));try{if(!n.remoteSDP)throw new Error("Cannot restartICE before remoteSDP created.");const o=$().supportPCSetConfiguration,s=r("FORCE_TURN_TCP")||n.forceTurn;if(t===be.RELAY&&!o)return;if(o&&!s){const i=t===be.RELAY?"relay":"all",o=n.peerConnection.getConfiguration();o.iceTransportPolicy!==i&&(e.debug("[".concat(n.store.clientId,"] restartICE change iceTransportPolicy from [").concat(o.iceTransportPolicy,"] to [").concat(i,"]")),o.iceTransportPolicy=i,n.peerConnection.setConfiguration(o))}n.remoteSDP.updateCandidates(t);const a=yield he(n.peerConnection.createOffer({iceRestart:!0}));if(!a.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");const c=qe(a.sdp),{remoteIceParameters:d}=yield c.iceParameters;n.remoteSDP.restartICE(d);const p=n.remoteSDP.toString(),l=n.logSDPExchange(a.sdp||"","offer","local","restartICE");n.store.descriptionStart(),yield he(n.peerConnection.setLocalDescription(a)),null==l||l(p),yield he(n.peerConnection.setRemoteDescription({type:"answer",sdp:p}))}catch(t){e.warning("[".concat(n.store.clientId,"] restart ICE failed, abort operation"),t)}finally{i()}}))()}async extendCandidate(){if(!this.remoteSDP||this.isFirstConnected)return;const t=await this.mutex.lock("From P2PConnection.extendCandidate");try{this.remoteSDP.updateCandidates(be.TCP_RELAY),await dt(this.peerConnection,this.remoteSDP,this.extension)}catch(t){e.warning("[".concat(this.store.clientId,"] extend candidate failed, abort operation"),t)}finally{t()}}close(){var e;this.peerConnection.getTransceivers().forEach((e=>{Pt(this.id+e.mid,this)})),this.preMediaMap.forEach((e=>{let{player:t}=e;t&&t.destroy()})),this.preMediaMap.clear(),this.peerConnection.close(),null===(e=this.onConnectionStateChange)||void 0===e||e.call(this,"closed"),this.tryUnbindTransportEvents(),this.unbindPCEvents(),this.unbindStatsEvents(),this.removeAllListeners(),this.transportEventReceiver=void 0,this.statsFilter.destroy(),this.dataStreamChannelMap.clear(),this.recoveredDataChannelIds=[],this.currentDataChannelId=1}getStats(){return _e(_e({},this.statsFilter.getStats()),{},{qualityLimitationReason:this.qualityLimitationReason})}getRemoteVideoIsReady(e){return this.statsFilter.getVideoIsReady(e)}async updateEncoderConfig(e,t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.updateEncoderConfig before remote SDP created.");const n=await this.peerConnection.createOffer(),i=this.mungSendOfferSDP(n.sdp,[t],[e]);this.remoteSDP.updateRecvMedia(e,t);const o=this.remoteSDP.toString(),r=this.logSDPExchange(i,"offer","local","updateEncoderConfig");await this.peerConnection.setLocalDescription({type:"offer",sdp:i}),null==r||r(o),await this.peerConnection.setRemoteDescription({type:"answer",sdp:o})}catch(e){throw new L(w.EXCHANGE_SDP_FAILED,e.toString())}}async updateSendParameters(e,t){const n=this.peerConnection.getTransceivers().filter((t=>t.mid===e));1===n.length&&(this.isVP8Simulcast(t)?c()||await this.applySimulcastEncodings(n,[t]):await this.applySendEncodings(n,[t]))}setStatsRemoteVideoIsReady(e,t){this.statsFilter.setVideoIsReady2(e,t)}async replaceTrack(e,t){const n=this.peerConnection.getTransceivers().find((e=>e.mid===t));n&&await n.sender.replaceTrack(e._mediaStreamTrack)}async getSelectedCandidatePair(){const e=this.peerConnection.getReceivers();if(e.length>0&&e[0].transport&&e[0].transport.iceTransport&&e[0].transport.iceTransport.getSelectedCandidatePair&&e[0].transport.iceTransport.getSelectedCandidatePair()){const t=e[0].transport.iceTransport,{local:n,remote:i}=t.getSelectedCandidatePair();return{local:_e(_e({},U),{},{candidateType:n.type,protocol:n.protocol,address:n.address,port:n.port}),remote:_e(_e({},U),{},{candidateType:i.type,protocol:i.protocol,address:i.address,port:i.port})}}return this.statsFilter.getSelectedCandidatePair()}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var e;null===(e=this.onICEConnectionStateChange)||void 0===e||e.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var e;"connected"===this.peerConnection.connectionState&&(this.isFirstConnected=!0),null===(e=this.onConnectionStateChange)||void 0===e||e.call(this,this.peerConnection.connectionState)},this.peerConnection.onicecandidateerror=t=>{if(t&&(t.errorCode||t.errorText)){var n;const i="code: ".concat(t.errorCode,", message: ").concat(t.errorText),o=t.port?"local: ".concat(t.port):"",r=ke(t.url||"");e.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICECandidateError(").concat(i,"), url: ").concat(r||"",", host_candidate:").concat(o)),null===(n=this.onICECandidateError)||void 0===n||n.call(this,i)}},this.peerConnection.onicegatheringstatechange=t=>{t&&t.target&&"iceGatheringState"in t.target&&e.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] RTCPeerConnection.onicegatheringstatechange(").concat(t.target.iceGatheringState,")"))},this.peerConnection.onicecandidate=t=>{t.candidate?this.localCandidateCount+=1:(this.peerConnection.onicecandidate=null,this.allCandidatesReceived=!0,e.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount))},setTimeout((()=>{this.allCandidatesReceived||(this.allCandidatesReceived=!0,e.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] onicecandidate timeout, local candidate count"),this.localCandidateCount))}),r("CANDIDATE_TIMEOUT"))}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(e){const t={iceServers:[]},i=e.cloudProxyServer||"disabled";return e.iceServers?t.iceServers=e.iceServers:e.turnServer&&(x(e.turnServer.servers)?t.iceServers=e.turnServer.servers:r("NEW_TURN_MODE")&&t.iceServers&&"disabled"===i?(r("USE_TURN_SERVER_OF_GATEWAY")?e.turnServer.serversFromGateway&&t.iceServers.push(...n.newTurnServerConfigToIceServers(e.turnServer.serversFromGateway)):t.iceServers.push(...n.newTurnServerConfigToIceServers(e.turnServer.servers)),r("NEW_FORCE_TURN")&&(t.iceTransportPolicy="relay")):"off"!==e.turnServer.mode&&(t.iceServers&&t.iceServers.push(...n.turnServerConfigToIceServers(e.turnServer.servers)),r("USE_TURN_SERVER_OF_GATEWAY")&&t.iceServers&&e.turnServer.serversFromGateway&&t.iceServers.push(...n.turnServerConfigToIceServers(e.turnServer.serversFromGateway)),r("FORCE_TURN_TCP")?t.iceTransportPolicy="relay":e.turnServer.servers.concat(e.turnServer.serversFromGateway||[]).forEach((e=>{e.forceturn&&(t.iceTransportPolicy="relay")})))),r("ENABLE_ENCODED_TRANSFORM")&&$().supportWebRTCEncodedTransform&&(t.encodedInsertableStreams=!0),t}static turnServerConfigToIceServers(e){const t=[];return e.forEach((e=>{e.security?e.tcpport&&t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turns:".concat(Ve(e.turnServerURL),":").concat(e.tcpport,"?transport=tcp")}):(e.udpport&&!r("FORCE_TURN_TCP")&&t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turn:".concat(e.turnServerURL,":").concat(e.udpport,"?transport=udp")}),e.tcpport&&t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turn:".concat(e.turnServerURL,":").concat(e.tcpport,"?transport=tcp")}))})),t}static newTurnServerConfigToIceServers(e){const t=[];return e.forEach((e=>{const n=r("NEW_TURN_MODE");1===n?t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turn:".concat(e.turnServerURL,":3478?transport=udp")}):2===n?t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turn:".concat(e.turnServerURL,":3478?transport=tcp")}):3===n?t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turns:".concat(Ve(e.turnServerURL),":443?transport=tcp")}):4===n&&(t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turn:".concat(e.turnServerURL,":3478?transport=udp")}),t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turn:".concat(e.turnServerURL,":3478?transport=tcp")}),t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turns:".concat(Ve(e.turnServerURL),":443?transport=tcp")}))})),t}tryBindTransportEvents(t){const n=t.transport;if(n){this.transportEventReceiver=t,n.onstatechange=()=>{var e;null!=n&&n.state&&(null===(e=this.onDTLSTransportStateChange)||void 0===e||e.call(this,n.state))},n.onerror=e=>{var t;null===(t=this.onDTLSTransportError)||void 0===t||t.call(this,"error"in e?e.error:e)};const i=n.iceTransport;i&&(i.onstatechange=()=>{const e=null==n?void 0:n.iceTransport.state;var t;e&&(null===(t=this.onICETransportStateChange)||void 0===t||t.call(this,e))},i.getSelectedCandidatePair&&(i.onselectedcandidatepairchange=()=>{if(i.getSelectedCandidatePair()){const{local:t,remote:n}=i.getSelectedCandidatePair()||{};if(t&&n){const i=t.address+":"+t.port,o=n.address+":"+n.port;e.info("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] selectedcandidatepairchange: local ").concat(JSON.stringify(ke(i)),", remote ").concat(JSON.stringify(ke(o))))}}}))}}tryUnbindTransportEvents(){this.transportEventReceiver&&this.transportEventReceiver.transport&&(this.transportEventReceiver.transport.onstatechange=null,this.transportEventReceiver.transport.onerror=null,this.transportEventReceiver.transport.iceTransport&&(this.transportEventReceiver.transport.iceTransport.onstatechange=null))}async updateRtpSenderEncodings(t,n){var i;if(!n){const e=this.peerConnection.getSenders();n=e.find((e=>e.track===t._mediaStreamTrack))}if(!n)return e.warn("[".concat(t.getTrackId(),"] no rtpSender found}"));if(this.isVP8Simulcast(t))return e.warn("[updateRtpSenderEncodings] Track is VP8 simulcast, please apply simulcast encodings");if(!$().supportSetRtpSenderParameters)return e.warn("[updateRtpSenderEncodings] Browser not support set rtp-sender parameters");const o={},s={};switch(t._optimizationMode){case"motion":o.degradationPreference="maintain-framerate";break;case"detail":o.degradationPreference="maintain-resolution";break;case"balanced":o.degradationPreference="balanced"}const a=Be(this.peerConnection,t._mediaStreamTrack),d=oe(t);if(Dt(t)&&a&&n&&d&&this.getLocalVideoStats&&["vp8","vp9"].includes(this.store.codec)){const e=o.degradationPreference||(t._hints.includes(ee.CUSTOM_TRACK)?r("CUSTOM_ADAPTATION_DEFAULT_MODE"):"maintain-framerate");Ot(this.id+a.mid,d,this,e,(e=>{n&&this.updateAdaptation(n,e)}),this.getLocalVideoStats.bind(this))}if(t._encoderConfig){const{bitrateMax:e,frameRate:n,scaleResolutionDownBy:i}=t._encoderConfig;e&&(s.maxBitrate=1e3*e),(t._hints.includes(ee.LOW_STREAM)||t.isUseScaleResolutionDownBy)&&(n&&(s.maxFramerate=Fe(n)),i&&i>=1&&(s.scaleResolutionDownBy=i))}const{maxFramerate:p}=r("ENCODER_CONFIG_LIMIT");if(p&&"number"==typeof p&&(s.maxFramerate=s.maxFramerate?Math.min(s.maxFramerate,p):p),r("DSCP_TYPE")&&V()){const e=r("DSCP_TYPE");["very-low","low","medium","high"].includes(e)&&(s.networkPriority=e)}const l=n.getParameters(),h=null===(i=l.encodings)||void 0===i?void 0:i[0];c()&&!h&&(o.encodings=[s]),h&&Object.assign(h,s),Object.assign(l,o),e.debug("[".concat(t.getTrackId(),"] updateRtpSenderEncodings: ").concat(JSON.stringify(l.encodings))),await n.setParameters(l),await ht(this.store.codec,n,r("SVC_MODE"))}async updateAdaptation(t,n){var i;if(!t)return e.debug("[updateAdaptation] no rtpSender found");if(!$().supportSetRtpSenderParameters)return e.debug("[updateAdaptation] Browser not support set rtp-sender parameters");const o={},{bitrateMax:r,frameRate:s,scaleResolutionDownBy:a}=n;r&&(o.maxBitrate=1e3*r),s&&(o.maxFramerate=Fe(s)),a&&a>=1&&["vp8","vp9"].includes(this.store.codec)&&(o.scaleResolutionDownBy=a);const c=t.getParameters(),d=null===(i=c.encodings)||void 0===i?void 0:i[0];d&&Object.assign(d,o),Object.assign(c,{});try{await t.setParameters(c),e.debug("[updateAdaptation] updateRtpSenderEncodings: ".concat(JSON.stringify(c.encodings)))}catch(n){!("transport"in t)||t.transport&&"connected"===t.transport.state?"connected"!==this.peerConnectionState?e.debug("[updateAdaptation] peerConnection not connected}"):e.debug("[updateAdaptation] updateRtpSenderEncodings failed",n):e.debug("[updateAdaptation] rtpSender transport not connected}")}}async applySendEncodings(t,n){try{if(!$().supportSetRtpSenderParameters)return;if(t.length!==n.length)return;for(let e=0;e<t.length;e++){const i=t[e],o=n[e];o instanceof Z&&!this.isVP8Simulcast(o)&&await this.updateRtpSenderEncodings(o,i.sender)}}catch(t){e.debug("[".concat(this.store.clientId,"] Apply RTPSendEncodings failed."))}}mungSendOfferSDP(e,t,n){if(r("FORBID_MODIFY_LOCAL_OFFER_SDP"))return e;const i=a(e);return t.forEach(((e,t)=>{const o=n[t],r=i.mediaDescriptions.find((e=>e.attributes.mid===o));r&&($e(r,e),tt(r,e,this.store.codec))})),p(i)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=e=>{var t;null===(t=this.onFirstAudioReceived)||void 0===t||t.call(this,e)},this.statsFilter.onFirstVideoReceived=e=>{var t;null===(t=this.onFirstVideoReceived)||void 0===t||t.call(this,e)},this.statsFilter.onFirstAudioDecoded=e=>{var t;null===(t=this.onFirstAudioDecoded)||void 0===t||t.call(this,e)},this.statsFilter.onFirstVideoDecoded=(e,t,n)=>{var i;null===(i=this.onFirstVideoDecoded)||void 0===i||i.call(this,e,t,n)},this.statsFilter.onSelectedLocalCandidateChanged=(e,t)=>{var n;null===(n=this.onSelectedLocalCandidateChanged)||void 0===n||n.call(this,e,t)},this.statsFilter.onSelectedRemoteCandidateChanged=(e,t)=>{var n;null===(n=this.onSelectedRemoteCandidateChanged)||void 0===n||n.call(this,e,t)},this.statsFilter.onFirstVideoDecodedTimeout=e=>{var t;null===(t=this.onFirstVideoDecodedTimeout)||void 0===t||t.call(this,e)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0,this.statsFilter.onFirstVideoDecodedTimeout=void 0}async applySimulcastForFirefox(e,t){if(e.length===t.length)for(let s=0;s<e.length;s++){var n,i,o,r;const a=e[s],c=t[s];if(c instanceof Z&&!c._hints.includes(ee.LOW_STREAM)&&null!==(n=c._encoderConfig)&&void 0!==n&&n.bitrateMax&&(null===(i=c._encoderConfig)||void 0===i?void 0:i.bitrateMax)>200&&null!==(o=c._scalabilityMode)&&void 0!==o&&o.numSpatialLayers&&(null===(r=c._scalabilityMode)||void 0===r?void 0:r.numSpatialLayers)>1&&"vp8"===this.store.codec){const e={},t={high:1e3*(c._encoderConfig.bitrateMax-50),medium:5e4};e.encodings=[{rid:"m",active:!0,maxBitrate:t.medium,scaleResolutionDownBy:4},{rid:"h",active:!0,maxBitrate:t.high}];const n=a.sender.getParameters();await a.sender.setParameters(Object.assign(n,e))}}}async applySimulcastEncodings(e,t){if(!c()&&e.length===t.length)for(let n=0;n<e.length;n++){const i=t[n];if(i instanceof Z&&this.isVP8Simulcast(i)){const t=e[n],o={},r={high:1e3*(i._encoderConfig.bitrateMax-50),medium:5e4};o.encodings=[{active:!0,adaptivePtime:!1,networkPriority:"high",priority:"high",maxBitrate:r.high},{active:!0,adaptivePtime:!1,networkPriority:"low",priority:"low",maxBitrate:r.medium,scaleResolutionDownBy:4}];const s=t.sender.getParameters();await t.sender.setParameters(Object.assign(s,o))}}}isVP8Simulcast(e){var t,n,i,o;return!!(e instanceof Z&&r("SIMULCAST")&&"vp8"===this.store.codec&&!e._hints.includes(ee.LOW_STREAM)&&null!==(t=e._encoderConfig)&&void 0!==t&&t.bitrateMax&&(null===(n=e._encoderConfig)||void 0===n?void 0:n.bitrateMax)>200&&null!==(i=e._scalabilityMode)&&void 0!==i&&i.numSpatialLayers&&(null===(o=e._scalabilityMode)||void 0===o?void 0:o.numSpatialLayers)>1)}logSDPExchange(t,n,i,o){if(r("SDP_LOGGING"))return e.upload("[".concat(this.store.clientId,"] exchanging ").concat(i," ").concat(n," SDP during P2PConnection.").concat(o,"\n"),t),"offer"===n?e=>{this.logSDPExchange(e,"answer","local"===i?"remote":"local",o)}:void 0}async getRemoteSSRC(e){if(!this.remoteSDP)return;const t=this.remoteSDP.getSSRC(e);return t&&0!==t.length?t[0].ssrcId:void 0}setConfiguration(e){if($().supportPCSetConfiguration){const t=n.resolvePCConfiguration(e);this.peerConnection.setConfiguration(t)}e.isPreallocation&&(this.isPreallocation=!0)}}).prototype,"updateRemoteRTPCapabilities",[Lt],Object.getOwnPropertyDescriptor(yt.prototype,"updateRemoteRTPCapabilities"),yt.prototype),ce(yt.prototype,"connect",[Lt],Object.getOwnPropertyDescriptor(yt.prototype,"connect"),yt.prototype),ce(yt.prototype,"updateRemoteConnect",[Lt],Object.getOwnPropertyDescriptor(yt.prototype,"updateRemoteConnect"),yt.prototype),ce(yt.prototype,"createDataChannels",[Lt],Object.getOwnPropertyDescriptor(yt.prototype,"createDataChannels"),yt.prototype),ce(yt.prototype,"receive",[Lt],Object.getOwnPropertyDescriptor(yt.prototype,"receive"),yt.prototype),ce(yt.prototype,"batchReceive",[Lt],Object.getOwnPropertyDescriptor(yt.prototype,"batchReceive"),yt.prototype),ce(yt.prototype,"stopReceiving",[Lt],Object.getOwnPropertyDescriptor(yt.prototype,"stopReceiving"),yt.prototype),ce(yt.prototype,"muteRemote",[Lt],Object.getOwnPropertyDescriptor(yt.prototype,"muteRemote"),yt.prototype),ce(yt.prototype,"unmuteRemote",[Lt],Object.getOwnPropertyDescriptor(yt.prototype,"unmuteRemote"),yt.prototype),ce(yt.prototype,"muteLocal",[Lt],Object.getOwnPropertyDescriptor(yt.prototype,"muteLocal"),yt.prototype),ce(yt.prototype,"unmuteLocal",[Lt],Object.getOwnPropertyDescriptor(yt.prototype,"unmuteLocal"),yt.prototype),ce(yt.prototype,"close",[Lt],Object.getOwnPropertyDescriptor(yt.prototype,"close"),yt.prototype),ce(yt.prototype,"updateEncoderConfig",[Lt],Object.getOwnPropertyDescriptor(yt.prototype,"updateEncoderConfig"),yt.prototype),ce(yt.prototype,"updateSendParameters",[Lt],Object.getOwnPropertyDescriptor(yt.prototype,"updateSendParameters"),yt.prototype),ce(yt.prototype,"replaceTrack",[Lt],Object.getOwnPropertyDescriptor(yt.prototype,"replaceTrack"),yt.prototype),ce(yt.prototype,"updateAdaptation",[Lt],Object.getOwnPropertyDescriptor(yt.prototype,"updateAdaptation"),yt.prototype),ce(yt.prototype,"getRemoteSSRC",[Lt],Object.getOwnPropertyDescriptor(yt.prototype,"getRemoteSSRC"),yt.prototype),!$().supportUnifiedPlan||r("CHROME_FORCE_PLAN_B")&&V();let Mt=(bt=class n extends Le{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get dtlsTransportState(){var e,t;return null!==(e=null===(t=this.peerConnection.getReceivers()[0])||void 0===t||null===(t=t.transport)||void 0===t?void 0:t.state)&&void 0!==e?e:null}get localCodecs(){return[...new Set(this.localCapabilities&&this.localCapabilities.send.videoCodecs.map((e=>e.rtpMap&&e.rtpMap.encodingName.toLowerCase()||"")).filter((e=>Object.keys(N).includes(e))))]}constructor(e,t,n){super(e,t),this.id=l(5,"connection-"),this.store=void 0,this.peerConnection=void 0,this.forceTurn=!1,this.remoteSDP=void 0,this.initialOffer=void 0,this.transportEventReceiver=void 0,this.statsFilter=void 0,this.extension={useXR:r("USE_XR")},this.localCapabilities=void 0,this.remoteCodecs=void 0,this.localCandidateCount=0,this.allCandidatesReceived=!1,this.isPreallocation=!1,this.preMediaMap=new Map,this.dataStreamChannelMap=new Map,this.establishPromise=void 0,this.recoveredDataChannelIds=[],this.currentDataChannelId=1,this.supportAV1RtpSpec=!1,this.mutex=void 0,this.qualityLimitationReason=g.NONE,this.isFirstConnected=!1,this.store=t,this.forceTurn=wt(e),this.mutex=new P("NVConnectionExtension-mutex",t.clientId),this.peerConnection=n,this.isFirstConnected=!1,this.statsFilter=y(this.peerConnection,r("STATS_UPDATE_INTERVAL"),void 0,c()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1,e.isPreallocation&&(this.isPreallocation=!0),this.establishPromise=this.establish()}getPreMedia(e){return this.preMediaMap.get(e)}isPreSub(){return this.preMediaMap.size>0}async updateRemoteRTPCapabilities(t,n){if(this.remoteCodecs=n,!this.remoteSDP)return void e.debug("[NVConnectionExtension] cannot updateRemoteRTPCapabilities before remote SDP created, local codecs: ".concat(this.localCodecs,", codecs: ").concat(n));if(this.remoteSDP.updateRemoteCodec(t,n,this.store.codec)){const e=await this.peerConnection.createOffer(),t=this.logSDPExchange(e.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(e);const n=this.remoteSDP.toString();null==t||t(n),await this.peerConnection.setRemoteDescription({type:"answer",sdp:n})}else e.debug("[NVConnectionExtension] updateRemoteRTPCapabilities no need to exchange SDP.")}async establish(){try{this.peerConnection.addTransceiver("video",{direction:"recvonly"}),this.peerConnection.addTransceiver("audio",{direction:"recvonly"});const t=await this.peerConnection.createOffer();if(!t.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");const n=qe(t.sdp),i=await it({filterRTX:!r("USE_PUB_RTX")&&!r("USE_SUB_RTX"),filterVideoFec:r("FILTER_VIDEO_FEC"),filterAudioFec:r("FILTER_AUDIO_FEC"),filterVideoCodec:r("FILTER_VIDEO_CODEC"),unsupportedVideoUplinkCodec:r("UNSUPPORTED_VIDEO_UPLINK_CODEC"),unsupportedVideoDownlinkCodec:r("UNSUPPORTED_VIDEO_DOWNLINK_CODEC")},this.extension);if(this.localCapabilities=rt(i),this.initialOffer=t,r("ENABLE_SVC")&&"av1"==this.store.codec){const t=await nt();var e;if(t)this.supportAV1RtpSpec=!0,null===(e=i.send)||void 0===e||e.videoExtensions.push(t)}let o;return t.sdp&&ut(t.sdp)&&(o=d(i),Ke(o)),_e(_e({},n),{},{rtpCapabilities:o||i,offerSDP:t.sdp})}catch(e){throw new L(w.GET_LOCAL_CONNECTION_PARAMS_FAILED,e.toString())}}async connect(t){try{if(!this.initialOffer)throw new Error("Cannot establish NVConnectionExtension without initial offer.");this.initialOffer.sdp&&ut(this.initialOffer.sdp)&&We(t.rtpCapabilities,this.localCapabilities),this.remoteSDP=new St(_e(_e({},t),{},{localCapabilities:this.localCapabilities}),this.supportAV1RtpSpec,!(!r("ENABLE_PRE_SUB_WITH_PRE_PC")||!r("PRE_USE_LOCAL_CODECS"))&&ne(this.store),!0),t.preallocation&&(this.isPreallocation=!0),Array.isArray(this.remoteCodecs)&&this.remoteCodecs.length>0&&this.remoteSDP.updateRemoteCodec([],this.remoteCodecs,this.store.codec);const n=this.remoteSDP.toString(),i=pt(this.initialOffer.sdp,this.extension),o=this.logSDPExchange(i||"","offer","local","connect");this.store.descriptionStart(),await this.peerConnection.setLocalDescription({type:"offer",sdp:i}),null==o||o(n),await this.peerConnection.setRemoteDescription({type:"answer",sdp:n});const s=this.peerConnection.getTransceivers()[0];if(null!=s&&s.receiver&&this.tryBindTransportEvents(s.receiver),ne(this.store))if(t.preallocation&&r("ENABLE_PRE_SUB_WITH_PRE_PC")){const t=r("PRE_SUB_NUM"),{mids:n,preSSRCs:i}=this.remoteSDP.preloadRemoteMedia(t);await dt(this.peerConnection,this.remoteSDP,this.extension),e.debug("[".concat(this.store.clientId,"] [NVConnectionExtension] preload media, in pre pc,add preload ssrcs ").concat(i)),this.presetMedia(n,i)}else{const{preSSRCs:n=[]}=t,i=n.map((e=>e.ssrcMsg[0].ssrcId));if(0===n.length)return;const{mids:o}=this.remoteSDP.batchSend(n.map((e=>Object.assign({},e))));await dt(this.peerConnection,this.remoteSDP,this.extension),e.debug("[NVConnectionExtension.connect] preload media, after join, add preload ssrcs ".concat(i)),this.presetMedia(o,i)}}catch(e){throw new L(w.EXCHANGE_SDP_FAILED,"NVConnectionExtension.connect failed; ".concat(e.toString()))}}presetMedia(e,t){e.forEach(((e,n)=>{this.peerConnection.getTransceivers().forEach((i=>{if(null!=i.mid&&e===i.mid&&i.receiver.track){const o=i.receiver.track;let s;"video"===o.kind&&r("ENABLE_PRE_RENDER")&&(s=new ie({trackId:"track-".concat(o.kind,"-unknown-").concat(this.store.clientId,"_").concat(l(5,""))},!0),s.updateVideoTrack(o),s.onFirstVideoFrameRender=()=>{var e;const i=this.preMediaMap.get(t[n]);i&&(i.firstVideoRender=Date.now()),null===(e=this.onFirstVideoRender)||void 0===e||e.call(this,t[n])},s.onVideoBufferReady=()=>{var e;null===(e=this.onFirstVideoBufferReady)||void 0===e||e.call(this,t[n])},s.play(this.store.sessionId||void 0)),this.preMediaMap.set(t[n],{mid:e,track:o,player:s,transceiver:i})}})),this.store.peerReceiver()}))}checkDtlsParameters(e){return!!this.remoteSDP&&(e.length>0&&this.remoteSDP.updateRemoteDtlsParameters(e))}async updateRemoteConnect(n){try{if(!this.remoteSDP)throw new Error("Cannot call NVConnectionExtension.updateRemoteConnect before remote SDP created");let i=!1;const{rtpCapabilities:o}=n;if([,i]=this.remoteSDP.updateRemoteRTPCapabilities(o),Array.isArray(this.remoteCodecs)&&this.remoteCodecs.length>0){const e=this.remoteSDP.updateRemoteCodec([],this.remoteCodecs,this.store.codec);i=i||e}const{preSSRCs:r=[]}=n,s=r.map((e=>e.ssrcMsg[0].ssrcId));if(!this.remoteSDP.checkPreloadSsrcs(s)){const n=[],i=[];if(Array.from(this.preMediaMap.entries()).every((e=>{let[t,{mid:o,player:r,track:s}]=e;return n.push(o),i.push(t),this.preMediaMap.delete(t),r&&r.destroy(),!0})),n.length>0&&(this.remoteSDP.stopSending(n),await dt(this.peerConnection,this.remoteSDP,this.extension),e.warn("[NVConnectionExtension.updateRemoteConnect] preload media, failed, del preload ssrcs ".concat(i)),t.reportApiInvoke(this.store.sessionId,{name:b.PRELOAD_MEDIA_FAILED,options:[r,i],tag:M.TRACER}).onSuccess()),r.length>0){const{mids:t}=this.remoteSDP.batchSend(r.map((e=>Object.assign({},e))));await dt(this.peerConnection,this.remoteSDP,this.extension),e.debug("[NVConnectionExtension.updateRemoteConnect] preload media, after join, add preload ssrcs ".concat(s)),this.presetMedia(t,s)}}i?(await dt(this.peerConnection,this.remoteSDP,this.extension),e.debug("[NVConnectionExtension] updateRemoteConnect by exchanging SDP.")):e.debug("[NVConnectionExtension] updateRemoteConnect no need to exchange SDP, because no need to update remote codecs (use local codecs)")}catch(e){throw new L(w.EXCHANGE_SDP_FAILED,"NVConnectionExtension.updateRemoteConnect failed; ".concat(e.toString()))}}send(e,t,n){var i=this;return Ce((function*(){const o=yield he(i.mutex.lock("From NVConnectionExtension.send"));try{if(!i.remoteSDP)throw new Error("Cannot call NVConnectionExtension.send before remote SDP created");const s=[],d=Ge();e.forEach((e=>{const t=i.peerConnection.addTransceiver(e._mediaStreamTrack,_e({direction:"sendonly"},"video"===e.trackMediaType&&i.supportAV1RtpSpec&&d?{sendEncodings:[{scalabilityMode:d}]}:{}));s.push(t),e._updateRtpTransceiver(t)})),c()&&!0===r("SIMULCAST")&&(yield he(i.applySimulcastForFirefox(s,e)));const p=yield he(i.peerConnection.createOffer()),l=i.remoteSDP.predictReceivingMids(e.length),h=i.mungSendOfferSDP(p.sdp,e,l),u=a(h),E=l.map((e=>{const t=u.mediaDescriptions.find((t=>t.attributes.mid===e));if(!t)throw new Error("Cannot extract ssrc from mediaDescription.");return ze(t,r("USE_PUB_RTX"))}));let _;try{_=yield E}catch(o){_=[],i.remoteSDP.receive(e,t,n,_);const r=i.remoteSDP.toString();throw yield he(i.peerConnection.setLocalDescription({type:"offer",sdp:h})),yield he(i.peerConnection.setRemoteDescription({type:"answer",sdp:r})),yield he(i.stopSending(l,!0)),o}i.remoteSDP.receive(e,t,n,_);const C=i.remoteSDP.toString(),m=i.logSDPExchange(h,"offer","local","send");return yield he(i.peerConnection.setLocalDescription({type:"offer",sdp:h})),yield he(i.applySimulcastEncodings(s,e)),yield he(i.applySendEncodings(s,e)),null==m||m(C),yield he(i.peerConnection.setRemoteDescription({type:"answer",sdp:C})),s.map(((e,t)=>{const n=l[t];return{localSSRC:E[t],id:n,transceiver:e}}))}catch(e){throw e instanceof L?e:new L(w.EXCHANGE_SDP_FAILED,"NVConnectionExtension.send failed; ".concat(e.toString()))}finally{o()}}))()}async createDataChannels(t,n){try{if(!this.remoteSDP)throw new Error("Cannot call NVConnectionExtension.createDataChannels before remote SDP created");let i=this.dataStreamChannelMap.get(t);if(i&&"open"===i.readyState)e.debug("[NVConnectionExtension] Channels are already available and can be reused directly.");else{const e=this.currentDataChannelId<1023?this.currentDataChannelId++:this.recoveredDataChannelIds.shift();if("number"!=typeof e)throw new Error("create DataChannel error, because cannot get dc id");i=this.peerConnection.createDataChannel("datastream-channel",{id:e,negotiated:!0,ordered:!1,maxRetransmits:r("DATASTREAM_MAX_RETRANSMITS")}),i.binaryType="arraybuffer",this.dataStreamChannelMap.set(t,i)}n.forEach((e=>{e._updateOriginDataChannel(i)}));const{needExchangeSDP:o}=this.remoteSDP.sendDataChannel();if(o){const t=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:t});const n=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(n),e.debug("[NVConnectionExtension] createDataChannels by exchanging SDP.")}else e.debug("[NVConnectionExtension] createDataChannels no need to exchange SDP.");return}catch(e){throw e instanceof L?e:new L(w.EXCHANGE_SDP_FAILED,"NVConnectionExtension.createDataChannels failed; ".concat(e.toString()))}}async stopDataChannels(e){try{const t=this.dataStreamChannelMap.get(e);return t&&(t.id&&this.recoveredDataChannelIds.push(t.id),t.close()),void this.dataStreamChannelMap.delete(e)}catch(e){throw e instanceof L?e:new L(w.DATACHANNEL_FAILED,"NVConnectionExtension.stopDataChannels failed; ".concat(e.toString()))}}async stopSending(e,t){const n=t?void 0:await this.mutex.lock("From NVConnectionExtension.stopSending");try{if(!this.remoteSDP)throw new Error("Cannot call NVConnectionExtension.stopSending before remote SDP created");const t=this.peerConnection.getTransceivers().filter((t=>-1!==e.indexOf(t.mid)));if(t.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length when trying to call NVConnectionExtension.stopSending.");t.map((e=>{var t;Pt(this.id+e.mid,this),e.direction="inactive",null===(t=e.stop)||void 0===t||t.call(e)}));const i=await this.peerConnection.createOffer(),o=this.logSDPExchange(i.sdp||"","offer","local","stopSending");await this.peerConnection.setLocalDescription(i),this.remoteSDP.stopReceiving(e);const r=this.remoteSDP.toString();null==o||o(r),await this.peerConnection.setRemoteDescription({type:"answer",sdp:r})}catch(e){throw new L(w.EXCHANGE_SDP_FAILED,"NVConnectionExtension.stopSending failed; ".concat(e.toString()))}finally{n&&n()}}async receive(t,n,i,o){try{if(!this.remoteSDP)throw new Error("Cannot call NVConnectionExtension.receive ".concat(t," before remoteSDP created."));const{mid:r,needExchangeSDP:s}=this.remoteSDP.send(t,n,i,o);s&&(await dt(this.peerConnection,this.remoteSDP,this.extension),e.debug("[".concat(this.store.clientId,"] [NVConnectionExtension] receive ").concat(t," by exchanging SDP.")));const a=this.peerConnection.getTransceivers().find((e=>e.mid===r));if(!a)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:a.receiver.track,id:r,transceiver:a}}catch(e){throw new L(w.EXCHANGE_SDP_FAILED,"NVConnectionExtension.receive failed; ".concat(e.toString()))}}async batchReceive(t){try{if(!this.remoteSDP)throw new Error("Cannot call NVConnectionExtension.batchReceive before remoteSDP created.");const{mids:n,needExchangeSDP:i}=this.remoteSDP.batchSend(t);return i&&(await dt(this.peerConnection,this.remoteSDP,this.extension),e.debug("[".concat(this.store.clientId,"] [NVConnectionExtension] batchReceive by exchanging SDP."))),n.map((e=>{const t=this.peerConnection.getTransceivers().find((t=>t.mid===e));if(!t)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:t.receiver.track,id:e,transceiver:t}}))}catch(e){throw new L(w.EXCHANGE_SDP_FAILED,"NVConnectionExtension.receive failed; ".concat(e.toString()))}}async stopReceiving(e){try{if(!this.remoteSDP)throw new Error("Cannot call NVConnectionExtension.stopReceiving before remote SDP created.");e.forEach((e=>{Array.from(this.preMediaMap.entries()).some((t=>{let[n,{mid:i,player:o}]=t;if(i===e)return this.preMediaMap.delete(n),o&&o.destroy(),!0}))})),this.remoteSDP.stopSending(e);const t=this.remoteSDP.toString(),n=this.logSDPExchange(t,"offer","remote","stopReceiving");await this.peerConnection.setRemoteDescription({type:"offer",sdp:t});const i=await this.peerConnection.createAnswer();null==n||n(i.sdp||""),await this.peerConnection.setLocalDescription(i)}catch(e){throw new L(w.EXCHANGE_SDP_FAILED,"NVConnectionExtension stopReceiving failed; ".concat(e.toString()))}}async muteRemote(e){try{if(!this.remoteSDP)throw new Error("Cannot call NVConnectionExtension.muteRemote mid=".concat(e," before remote SDP created."));this.remoteSDP.mute(e);const t=this.remoteSDP.toString(),n=this.logSDPExchange(t,"offer","remote","muteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:t});const i=await this.peerConnection.createAnswer();null==n||n(i.sdp||""),await this.peerConnection.setLocalDescription(i)}catch(e){throw new L(w.EXCHANGE_SDP_FAILED,"NVConnectionExtension.muteRemote failed; ".concat(e.toString()))}}async unmuteRemote(e){try{if(!this.remoteSDP)throw new Error("Cannot call NVConnectionExtension.unmuteRemote mid=".concat(e," before remote SDP created."));this.remoteSDP.unmute(e);const t=this.remoteSDP.toString(),n=this.logSDPExchange(t,"offer","remote","unmuteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:t});const i=await this.peerConnection.createAnswer();null==n||n(i.sdp||""),await this.peerConnection.setLocalDescription(i)}catch(e){throw new L(w.EXCHANGE_SDP_FAILED,"NVConnectionExtension.unmuteRemote failed; ".concat(e.toString()))}}async muteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call NVConnectionExtension.muteLocal before remote SDP created.");const t=this.peerConnection.getTransceivers().filter((t=>t.mid&&-1!==e.indexOf(t.mid)));if(t.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length.");t.map((e=>{e.direction="inactive"}));const n=await this.peerConnection.createOffer(),i=this.logSDPExchange(n.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(n),this.remoteSDP.muteRemote(e);const o=this.remoteSDP.toString();null==i||i(o),await this.peerConnection.setRemoteDescription({type:"answer",sdp:o})}catch(e){throw new L(w.EXCHANGE_SDP_FAILED,"NVConnectionExtension.muteLocal failed; ".concat(e.toString()))}}async unmuteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call NVConnectionExtension.unmuteLocal before remote SDP created.");const t=this.peerConnection.getTransceivers().filter((t=>t.mid&&-1!==e.indexOf(t.mid)));if(t.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length.");t.map((async(e,t)=>{e.direction="sendonly"}));const n=await this.peerConnection.createOffer(),i=this.logSDPExchange(n.sdp||"","offer","local","unmuteLocal");await this.peerConnection.setLocalDescription(n),this.remoteSDP.unmuteRemote(e),Array.isArray(this.remoteCodecs)&&this.remoteCodecs.length>0&&this.remoteSDP.updateRemoteCodec(e,this.remoteCodecs,this.store.codec);const o=this.remoteSDP.toString();null==i||i(o),await this.peerConnection.setRemoteDescription({type:"answer",sdp:o})}catch(e){throw new L(w.EXCHANGE_SDP_FAILED,"NVConnectionExtension.unmuteLocal failed; ".concat(e.toString()))}}restartICE(t){var n=this;return Ce((function*(){const i=yield he(n.mutex.lock("From NVConnectionExtension.restartICE"));try{if(!n.remoteSDP)throw new Error("Cannot restartICE before remoteSDP created.");const o=$().supportPCSetConfiguration,s=r("FORCE_TURN_TCP")||n.forceTurn;if(t===be.RELAY&&!o)return;if(o&&!s){const i=t===be.RELAY?"relay":"all",o=n.peerConnection.getConfiguration();o.iceTransportPolicy!==i&&(e.debug("[".concat(n.store.clientId,"] restartICE change iceTransportPolicy from [").concat(o.iceTransportPolicy,"] to [").concat(i,"]")),o.iceTransportPolicy=i,n.peerConnection.setConfiguration(o))}n.remoteSDP.updateCandidates(t);const a=yield he(n.peerConnection.createOffer({iceRestart:!0}));if(!a.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");const c=qe(a.sdp),{remoteIceParameters:d}=yield c.iceParameters;n.remoteSDP.restartICE(d);const p=n.remoteSDP.toString(),l=n.logSDPExchange(a.sdp||"","offer","local","restartICE");n.store.descriptionStart(),yield he(n.peerConnection.setLocalDescription(a)),null==l||l(p),yield he(n.peerConnection.setRemoteDescription({type:"answer",sdp:p}))}catch(t){e.warning("[".concat(n.store.clientId,"] restart ICE failed, abort operation"),t)}finally{i()}}))()}async extendCandidate(){if(!this.remoteSDP||this.isFirstConnected)return;const t=await this.mutex.lock("From NVConnectionExtension.extendCandidate");try{this.remoteSDP.updateCandidates(be.TCP_RELAY),await dt(this.peerConnection,this.remoteSDP,this.extension)}catch(t){e.warning("[".concat(this.store.clientId,"] extend candidate failed, abort operation"),t)}finally{t()}}close(){var e;this.peerConnection.getTransceivers().forEach((e=>{Pt(this.id+e.mid,this)})),this.preMediaMap.forEach((e=>{let{player:t}=e;t&&t.destroy()})),this.preMediaMap.clear(),this.peerConnection.close(),null===(e=this.onConnectionStateChange)||void 0===e||e.call(this,"closed"),this.tryUnbindTransportEvents(),this.unbindPCEvents(),this.unbindStatsEvents(),this.removeAllListeners(),this.transportEventReceiver=void 0,this.statsFilter.destroy(),this.dataStreamChannelMap.clear(),this.recoveredDataChannelIds=[],this.currentDataChannelId=1}getStats(){return _e(_e({},this.statsFilter.getStats()),{},{qualityLimitationReason:this.qualityLimitationReason})}getRemoteVideoIsReady(e){return this.statsFilter.getVideoIsReady(e)}async updateEncoderConfig(e,t){try{if(!this.remoteSDP)throw new Error("Cannot call NVConnectionExtension.updateEncoderConfig before remote SDP created.");const n=await this.peerConnection.createOffer(),i=this.mungSendOfferSDP(n.sdp,[t],[e]);this.remoteSDP.updateRecvMedia(e,t);const o=this.remoteSDP.toString(),r=this.logSDPExchange(i,"offer","local","updateEncoderConfig");await this.peerConnection.setLocalDescription({type:"offer",sdp:i}),null==r||r(o),await this.peerConnection.setRemoteDescription({type:"answer",sdp:o})}catch(e){throw new L(w.EXCHANGE_SDP_FAILED,e.toString())}}async updateSendParameters(e,t){const n=this.peerConnection.getTransceivers().filter((t=>t.mid===e));1===n.length&&(this.isVP8Simulcast(t)?c()||await this.applySimulcastEncodings(n,[t]):await this.applySendEncodings(n,[t]))}setStatsRemoteVideoIsReady(e,t){this.statsFilter.setVideoIsReady2(e,t)}async replaceTrack(e,t){const n=this.peerConnection.getTransceivers().find((e=>e.mid===t));n&&await n.sender.replaceTrack(e._mediaStreamTrack)}async getSelectedCandidatePair(){const e=this.peerConnection.getReceivers();if(e.length>0&&e[0].transport&&e[0].transport.iceTransport&&e[0].transport.iceTransport.getSelectedCandidatePair&&e[0].transport.iceTransport.getSelectedCandidatePair()){const t=e[0].transport.iceTransport,{local:n,remote:i}=t.getSelectedCandidatePair();return{local:_e(_e({},U),{},{candidateType:n.type,protocol:n.protocol,address:n.address,port:n.port}),remote:_e(_e({},U),{},{candidateType:i.type,protocol:i.protocol,address:i.address,port:i.port})}}return this.statsFilter.getSelectedCandidatePair()}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var e;null===(e=this.onICEConnectionStateChange)||void 0===e||e.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var e;"connected"===this.peerConnection.connectionState&&(this.isFirstConnected=!0),null===(e=this.onConnectionStateChange)||void 0===e||e.call(this,this.peerConnection.connectionState)},this.peerConnection.onicecandidateerror=t=>{if(t&&(t.errorCode||t.errorText)){var n;const i="code: ".concat(t.errorCode,", message: ").concat(t.errorText),o=t.port?"local: ".concat(t.port):"",r=ke(t.url||"");e.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: NVConnectionExtension.onICECandidateError(").concat(i,"), url: ").concat(r||"",", host_candidate:").concat(o)),null===(n=this.onICECandidateError)||void 0===n||n.call(this,i)}},this.peerConnection.onicegatheringstatechange=t=>{t&&t.target&&"iceGatheringState"in t.target&&e.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] RTCPeerConnection.onicegatheringstatechange(").concat(t.target.iceGatheringState,")"))},this.peerConnection.onicecandidate=t=>{t.candidate?this.localCandidateCount+=1:(this.peerConnection.onicecandidate=null,this.allCandidatesReceived=!0,e.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount))},setTimeout((()=>{this.allCandidatesReceived||(this.allCandidatesReceived=!0,e.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] onicecandidate timeout, local candidate count"),this.localCandidateCount))}),r("CANDIDATE_TIMEOUT"))}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(e){const t={iceServers:[]},i=e.cloudProxyServer||"disabled";return e.iceServers?t.iceServers=e.iceServers:e.turnServer&&(x(e.turnServer.servers)?t.iceServers=e.turnServer.servers:r("NEW_TURN_MODE")&&t.iceServers&&"disabled"===i?(r("USE_TURN_SERVER_OF_GATEWAY")?e.turnServer.serversFromGateway&&t.iceServers.push(...n.newTurnServerConfigToIceServers(e.turnServer.serversFromGateway)):t.iceServers.push(...n.newTurnServerConfigToIceServers(e.turnServer.servers)),r("NEW_FORCE_TURN")&&(t.iceTransportPolicy="relay")):"off"!==e.turnServer.mode&&(t.iceServers&&t.iceServers.push(...n.turnServerConfigToIceServers(e.turnServer.servers)),r("USE_TURN_SERVER_OF_GATEWAY")&&t.iceServers&&e.turnServer.serversFromGateway&&t.iceServers.push(...n.turnServerConfigToIceServers(e.turnServer.serversFromGateway)),r("FORCE_TURN_TCP")?t.iceTransportPolicy="relay":e.turnServer.servers.concat(e.turnServer.serversFromGateway||[]).forEach((e=>{e.forceturn&&(t.iceTransportPolicy="relay")})))),r("ENABLE_ENCODED_TRANSFORM")&&$().supportWebRTCEncodedTransform&&(t.encodedInsertableStreams=!0),t}static turnServerConfigToIceServers(e){const t=[];return e.forEach((e=>{e.security?e.tcpport&&t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turns:".concat(Ve(e.turnServerURL),":").concat(e.tcpport,"?transport=tcp")}):(e.udpport&&!r("FORCE_TURN_TCP")&&t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turn:".concat(e.turnServerURL,":").concat(e.udpport,"?transport=udp")}),e.tcpport&&t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turn:".concat(e.turnServerURL,":").concat(e.tcpport,"?transport=tcp")}))})),t}static newTurnServerConfigToIceServers(e){const t=[];return e.forEach((e=>{const n=r("NEW_TURN_MODE");1===n?t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turn:".concat(e.turnServerURL,":3478?transport=udp")}):2===n?t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turn:".concat(e.turnServerURL,":3478?transport=tcp")}):3===n?t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turns:".concat(Ve(e.turnServerURL),":443?transport=tcp")}):4===n&&(t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turn:".concat(e.turnServerURL,":3478?transport=udp")}),t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turn:".concat(e.turnServerURL,":3478?transport=tcp")}),t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turns:".concat(Ve(e.turnServerURL),":443?transport=tcp")}))})),t}tryBindTransportEvents(t){const n=t.transport;if(n){this.transportEventReceiver=t,n.onstatechange=()=>{var e;null!=n&&n.state&&(null===(e=this.onDTLSTransportStateChange)||void 0===e||e.call(this,n.state))},n.onerror=e=>{var t;null===(t=this.onDTLSTransportError)||void 0===t||t.call(this,"error"in e?e.error:e)};const i=n.iceTransport;i&&(i.onstatechange=()=>{const e=null==n?void 0:n.iceTransport.state;var t;e&&(null===(t=this.onICETransportStateChange)||void 0===t||t.call(this,e))},i.getSelectedCandidatePair&&(i.onselectedcandidatepairchange=()=>{if(i.getSelectedCandidatePair()){const{local:t,remote:n}=i.getSelectedCandidatePair()||{};if(t&&n){const i=t.address+":"+t.port,o=n.address+":"+n.port;e.info("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] selectedcandidatepairchange: local ").concat(JSON.stringify(ke(i)),", remote ").concat(JSON.stringify(ke(o))))}}}))}}tryUnbindTransportEvents(){this.transportEventReceiver&&this.transportEventReceiver.transport&&(this.transportEventReceiver.transport.onstatechange=null,this.transportEventReceiver.transport.onerror=null,this.transportEventReceiver.transport.iceTransport&&(this.transportEventReceiver.transport.iceTransport.onstatechange=null))}async updateRtpSenderEncodings(t,n){var i;if(!n){const e=this.peerConnection.getSenders();n=e.find((e=>e.track===t._mediaStreamTrack))}if(!n)return e.warn("[".concat(t.getTrackId(),"] no rtpSender found}"));if(this.isVP8Simulcast(t))return e.warn("[updateRtpSenderEncodings] Track is VP8 simulcast, please apply simulcast encodings");if(!$().supportSetRtpSenderParameters)return e.warn("[updateRtpSenderEncodings] Browser not support set rtp-sender parameters");const o={},s={};switch(t._optimizationMode){case"motion":o.degradationPreference="maintain-framerate";break;case"detail":o.degradationPreference="maintain-resolution";break;case"balanced":o.degradationPreference="balanced"}const a=Be(this.peerConnection,t._mediaStreamTrack),d=oe(t);if(Dt(t)&&a&&n&&d&&this.getLocalVideoStats&&["vp8","vp9"].includes(this.store.codec)){const e=o.degradationPreference||(t._hints.includes(ee.CUSTOM_TRACK)?r("CUSTOM_ADAPTATION_DEFAULT_MODE"):"maintain-framerate");Ot(this.id+a.mid,d,this,e,(e=>{n&&this.updateAdaptation(n,e)}),this.getLocalVideoStats.bind(this))}if(t._encoderConfig){const{bitrateMax:e,frameRate:n,scaleResolutionDownBy:i}=t._encoderConfig;e&&(s.maxBitrate=1e3*e),(t._hints.includes(ee.LOW_STREAM)||t.isUseScaleResolutionDownBy)&&(n&&(s.maxFramerate=Fe(n)),i&&i>=1&&(s.scaleResolutionDownBy=i))}const{maxFramerate:p}=r("ENCODER_CONFIG_LIMIT");if(p&&"number"==typeof p&&(s.maxFramerate=s.maxFramerate?Math.min(s.maxFramerate,p):p),r("DSCP_TYPE")&&V()){const e=r("DSCP_TYPE");["very-low","low","medium","high"].includes(e)&&(s.networkPriority=e)}const l=n.getParameters(),h=null===(i=l.encodings)||void 0===i?void 0:i[0];c()&&!h&&(o.encodings=[s]),h&&Object.assign(h,s),Object.assign(l,o),e.debug("[".concat(t.getTrackId(),"] updateRtpSenderEncodings: ").concat(JSON.stringify(l.encodings))),await n.setParameters(l),await ht(this.store.codec,n,r("SVC_MODE"))}async updateAdaptation(t,n){var i;if(!t)return e.debug("[updateAdaptation] no rtpSender found");if(!$().supportSetRtpSenderParameters)return e.debug("[updateAdaptation] Browser not support set rtp-sender parameters");const o={},{bitrateMax:r,frameRate:s,scaleResolutionDownBy:a}=n;r&&(o.maxBitrate=1e3*r),s&&(o.maxFramerate=Fe(s)),a&&a>=1&&["vp8","vp9"].includes(this.store.codec)&&(o.scaleResolutionDownBy=a);const c=t.getParameters(),d=null===(i=c.encodings)||void 0===i?void 0:i[0];d&&Object.assign(d,o),Object.assign(c,{});try{await t.setParameters(c),e.debug("[updateAdaptation] updateRtpSenderEncodings: ".concat(JSON.stringify(c.encodings)))}catch(n){!("transport"in t)||t.transport&&"connected"===t.transport.state?"connected"!==this.peerConnectionState?e.debug("[updateAdaptation] peerConnection not connected}"):e.debug("[updateAdaptation] updateRtpSenderEncodings failed",n):e.debug("[updateAdaptation] rtpSender transport not connected}")}}async applySendEncodings(t,n){try{if(!$().supportSetRtpSenderParameters)return;if(t.length!==n.length)return;for(let e=0;e<t.length;e++){const i=t[e],o=n[e];o instanceof Z&&!this.isVP8Simulcast(o)&&await this.updateRtpSenderEncodings(o,i.sender)}}catch(t){e.debug("[".concat(this.store.clientId,"] Apply RTPSendEncodings failed."))}}mungSendOfferSDP(e,t,n){const i=a(e);return t.forEach(((e,t)=>{const o=n[t],r=i.mediaDescriptions.find((e=>e.attributes.mid===o));r&&($e(r,e),tt(r,e,this.store.codec))})),p(i)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=e=>{var t;null===(t=this.onFirstAudioReceived)||void 0===t||t.call(this,e)},this.statsFilter.onFirstVideoReceived=e=>{var t;null===(t=this.onFirstVideoReceived)||void 0===t||t.call(this,e)},this.statsFilter.onFirstAudioDecoded=e=>{var t;null===(t=this.onFirstAudioDecoded)||void 0===t||t.call(this,e)},this.statsFilter.onFirstVideoDecoded=(e,t,n)=>{var i;null===(i=this.onFirstVideoDecoded)||void 0===i||i.call(this,e,t,n)},this.statsFilter.onSelectedLocalCandidateChanged=(e,t)=>{var n;null===(n=this.onSelectedLocalCandidateChanged)||void 0===n||n.call(this,e,t)},this.statsFilter.onSelectedRemoteCandidateChanged=(e,t)=>{var n;null===(n=this.onSelectedRemoteCandidateChanged)||void 0===n||n.call(this,e,t)},this.statsFilter.onFirstVideoDecodedTimeout=e=>{var t;null===(t=this.onFirstVideoDecodedTimeout)||void 0===t||t.call(this,e)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0,this.statsFilter.onFirstVideoDecodedTimeout=void 0}async applySimulcastForFirefox(e,t){if(e.length===t.length)for(let s=0;s<e.length;s++){var n,i,o,r;const a=e[s],c=t[s];if(c instanceof Z&&!c._hints.includes(ee.LOW_STREAM)&&null!==(n=c._encoderConfig)&&void 0!==n&&n.bitrateMax&&(null===(i=c._encoderConfig)||void 0===i?void 0:i.bitrateMax)>200&&null!==(o=c._scalabilityMode)&&void 0!==o&&o.numSpatialLayers&&(null===(r=c._scalabilityMode)||void 0===r?void 0:r.numSpatialLayers)>1&&"vp8"===this.store.codec){const e={},t={high:1e3*(c._encoderConfig.bitrateMax-50),medium:5e4};e.encodings=[{rid:"m",active:!0,maxBitrate:t.medium,scaleResolutionDownBy:4},{rid:"h",active:!0,maxBitrate:t.high}];const n=a.sender.getParameters();await a.sender.setParameters(Object.assign(n,e))}}}async applySimulcastEncodings(e,t){if(!c()&&e.length===t.length)for(let n=0;n<e.length;n++){const i=t[n];if(i instanceof Z&&this.isVP8Simulcast(i)){const t=e[n],o={},r={high:1e3*(i._encoderConfig.bitrateMax-50),medium:5e4};o.encodings=[{active:!0,adaptivePtime:!1,networkPriority:"high",priority:"high",maxBitrate:r.high},{active:!0,adaptivePtime:!1,networkPriority:"low",priority:"low",maxBitrate:r.medium,scaleResolutionDownBy:4}];const s=t.sender.getParameters();await t.sender.setParameters(Object.assign(s,o))}}}isVP8Simulcast(e){var t,n,i,o;return!!(e instanceof Z&&r("SIMULCAST")&&"vp8"===this.store.codec&&!e._hints.includes(ee.LOW_STREAM)&&null!==(t=e._encoderConfig)&&void 0!==t&&t.bitrateMax&&(null===(n=e._encoderConfig)||void 0===n?void 0:n.bitrateMax)>200&&null!==(i=e._scalabilityMode)&&void 0!==i&&i.numSpatialLayers&&(null===(o=e._scalabilityMode)||void 0===o?void 0:o.numSpatialLayers)>1)}logSDPExchange(t,n,i,o){if(r("SDP_LOGGING"))return e.upload("[".concat(this.store.clientId,"] exchanging ").concat(i," ").concat(n," SDP during NVConnectionExtension.").concat(o,"\n"),t),"offer"===n?e=>{this.logSDPExchange(e,"answer","local"===i?"remote":"local",o)}:void 0}async getRemoteSSRC(e){if(!this.remoteSDP)return;const t=this.remoteSDP.getSSRC(e);return t&&0!==t.length?t[0].ssrcId:void 0}setConfiguration(e){if($().supportPCSetConfiguration){const t=n.resolvePCConfiguration(e);this.peerConnection.setConfiguration(t)}e.isPreallocation&&(this.isPreallocation=!0)}},ce(bt.prototype,"updateRemoteRTPCapabilities",[Ut],Object.getOwnPropertyDescriptor(bt.prototype,"updateRemoteRTPCapabilities"),bt.prototype),ce(bt.prototype,"connect",[Ut],Object.getOwnPropertyDescriptor(bt.prototype,"connect"),bt.prototype),ce(bt.prototype,"updateRemoteConnect",[Ut],Object.getOwnPropertyDescriptor(bt.prototype,"updateRemoteConnect"),bt.prototype),ce(bt.prototype,"createDataChannels",[Ut],Object.getOwnPropertyDescriptor(bt.prototype,"createDataChannels"),bt.prototype),ce(bt.prototype,"receive",[Ut],Object.getOwnPropertyDescriptor(bt.prototype,"receive"),bt.prototype),ce(bt.prototype,"batchReceive",[Ut],Object.getOwnPropertyDescriptor(bt.prototype,"batchReceive"),bt.prototype),ce(bt.prototype,"stopReceiving",[Ut],Object.getOwnPropertyDescriptor(bt.prototype,"stopReceiving"),bt.prototype),ce(bt.prototype,"muteRemote",[Ut],Object.getOwnPropertyDescriptor(bt.prototype,"muteRemote"),bt.prototype),ce(bt.prototype,"unmuteRemote",[Ut],Object.getOwnPropertyDescriptor(bt.prototype,"unmuteRemote"),bt.prototype),ce(bt.prototype,"muteLocal",[Ut],Object.getOwnPropertyDescriptor(bt.prototype,"muteLocal"),bt.prototype),ce(bt.prototype,"unmuteLocal",[Ut],Object.getOwnPropertyDescriptor(bt.prototype,"unmuteLocal"),bt.prototype),ce(bt.prototype,"close",[Ut],Object.getOwnPropertyDescriptor(bt.prototype,"close"),bt.prototype),ce(bt.prototype,"updateEncoderConfig",[Ut],Object.getOwnPropertyDescriptor(bt.prototype,"updateEncoderConfig"),bt.prototype),ce(bt.prototype,"updateSendParameters",[Ut],Object.getOwnPropertyDescriptor(bt.prototype,"updateSendParameters"),bt.prototype),ce(bt.prototype,"replaceTrack",[Ut],Object.getOwnPropertyDescriptor(bt.prototype,"replaceTrack"),bt.prototype),ce(bt.prototype,"updateAdaptation",[Ut],Object.getOwnPropertyDescriptor(bt.prototype,"updateAdaptation"),bt.prototype),ce(bt.prototype,"getRemoteSSRC",[Ut],Object.getOwnPropertyDescriptor(bt.prototype,"getRemoteSSRC"),bt.prototype),bt);function Ut(e,t,n){const i=e[t];if("function"!=typeof i)throw new Error("Cannot use mutex on object property.");return n.value=async function(){const e=this.mutex,n=await e.lock("From NVConnectionExtension.".concat(t));try{for(var o=arguments.length,r=new Array(o),s=0;s<o;s++)r[s]=arguments[s];return await i.apply(this,r)}finally{n()}},n}var xt;let Vt=(xt=class t extends Le{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get localCodecs(){return this._p2pConnection.localCodecs}constructor(e,n){super(e,n),this.name="DataChannelConnection",this.store=void 0,this.peerConnection=void 0,this.cname=void 0,this.mutex=new P("DataChannelConnection-mutex"),this.dataChannel=void 0,this._p2pConnection=void 0,this.establishPromise=void 0,this._nvMedia=void 0,this.store=n,this.store.dcId=this.store.dcId+1,this.peerConnection=new RTCPeerConnection(t.resolvePCConfiguration(e),{optional:[{googDscp:!0}]}),this.dataChannel=this.peerConnection.createDataChannel("agora-signal",{ordered:!1,maxPacketLifeTime:50}),this.dataChannel.binaryType="arraybuffer",this._p2pConnection=new Mt(e,n,this.peerConnection),this.bindPCEvents(),this.establishPromise=this._p2pConnection.establishPromise}getPreMedia(e){var t;return null===(t=this._p2pConnection)||void 0===t?void 0:t.getPreMedia(e)}isPreSub(){var e,t;return null!==(e=null===(t=this._p2pConnection)||void 0===t?void 0:t.isPreSub())&&void 0!==e&&e}async establish(){return await this._p2pConnection.establish()}getP2PConnectionParams(){return this._p2pConnection.establishPromise}updateRtpSenderEncodings(e){return this._p2pConnection.updateRtpSenderEncodings(e)}async connect(e){return this.cname=e.cname,await this._p2pConnection.connect(e),await new Promise(((t,i)=>{const o=setTimeout((()=>{this.closeSignal(),i(new n(w.DATACHANNEL_CONNECTION_TIMEOUT,"Datachannel connection timed out, candidates: ".concat(JSON.stringify(e.candidates))))}),r("DC_CONNECTION_TIMEOUT"));this.dataChannel.onopen=()=>{if("open"===this.dataChannel.readyState)return clearTimeout(o),void t()},this.dataChannel.onerror=e=>{this.closeSignal(),i(e)},this.dataChannel.addEventListener("close",(()=>{i(new n(w.DATACHANNEL_CONNECTION_TIMEOUT))}))})),{transmitter:this.dataChannel,close:this.closeSignal.bind(this)}}async updateRemoteRTPCapabilities(e,t){return this._p2pConnection.updateRemoteRTPCapabilities(e,t)}send(e,t,n){var i=this;return Ce((function*(){const o=yield he(i.mutex.lock("From DataChannelConnection.send"));try{return yield*de(pe(i._p2pConnection.send(e,t,n)))}finally{o()}}))()}async stopSending(e,t){return this._p2pConnection.stopSending(e,t)}async createDataChannels(e,t){return this._p2pConnection.createDataChannels(e,t)}async stopDataChannels(e){return this._p2pConnection.stopDataChannels(e)}async receive(t,n,i,o){return this._nvMedia?(e.debug("[DataChannelConnection] receive ".concat(t," by DataChannel.")),await this._nvMedia.reveiveByRTCMedia(t,n,this.cname)):(e.debug("[DataChannelConnection] receive ".concat(t," by WebRTC.")),await this._p2pConnection.receive(t,n,i,o))}async batchReceive(e){return[...await this._p2pConnection.batchReceive(e)]}async stopReceiving(e){return await this._p2pConnection.stopReceiving(e)}async muteRemote(e){return await this._p2pConnection.muteRemote(e)}async unmuteRemote(e){return await this._p2pConnection.unmuteRemote(e)}async muteLocal(e){return await this._p2pConnection.muteLocal(e)}async unmuteLocal(e){return await this._p2pConnection.unmuteLocal(e)}restartICE(e){var t=this;return Ce((function*(){return yield*de(pe(t._p2pConnection.restartICE(e)))}))()}close(){var e;null===(e=this._nvMedia)||void 0===e||e.close(),this._p2pConnection.close(),this.unbindConnectionEvents(this._p2pConnection)}getStats(){return this._p2pConnection.getStats()}getRemoteVideoIsReady(e){return this._p2pConnection.getRemoteVideoIsReady(e)}updateRemoteConnect(e){var t;return null===(t=this._nvMedia)||void 0===t||t.setRemoteRtpCapabilities(e),this._p2pConnection.updateRemoteConnect(e)}async updateEncoderConfig(e,t){return await this._p2pConnection.updateEncoderConfig(e,t)}async updateSendParameters(e,t){return await this._p2pConnection.updateSendParameters(e,t)}setStatsRemoteVideoIsReady(e,t){this._p2pConnection.setStatsRemoteVideoIsReady(e,t)}async replaceTrack(e,t){return await this._p2pConnection.replaceTrack(e,t)}async getRemoteSSRC(e){return this._p2pConnection.getRemoteSSRC(e)}logSDPExchange(t,n,i,o){if(r("SDP_LOGGING"))return e.upload("exchanging ".concat(i," ").concat(n," SDP during DataChannelConnection.").concat(o,"\n"),t),"offer"===n?e=>{this.logSDPExchange(e,"answer","local"===i?"remote":"local",o)}:void 0}static resolvePCConfiguration(e){const n={iceServers:[]};return e.iceServers?n.iceServers=e.iceServers:e.turnServer&&"off"!==e.turnServer.mode&&(x(e.turnServer.servers)?n.iceServers=e.turnServer.servers:(n.iceServers&&n.iceServers.push(...t.turnServerConfigToIceServers(e.turnServer.servers)),r("USE_TURN_SERVER_OF_GATEWAY")&&n.iceServers&&e.turnServer.serversFromGateway&&n.iceServers.push(...t.turnServerConfigToIceServers(e.turnServer.serversFromGateway)),r("FORCE_TURN_TCP")?n.iceTransportPolicy="relay":e.turnServer.servers.concat(e.turnServer.serversFromGateway||[]).forEach((e=>{e.forceturn&&(n.iceTransportPolicy="relay")})))),r("ENABLE_ENCODED_TRANSFORM")&&$().supportWebRTCEncodedTransform&&(n.encodedInsertableStreams=!0),n}static turnServerConfigToIceServers(e){const t=[];return e.forEach((e=>{e.security?e.tcpport&&t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turns:".concat(Ve(e.turnServerURL),":").concat(e.tcpport,"?transport=tcp")}):(e.udpport&&!r("FORCE_TURN_TCP")&&t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turn:".concat(e.turnServerURL,":").concat(e.udpport,"?transport=udp")}),e.tcpport&&t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turn:".concat(e.turnServerURL,":").concat(e.tcpport,"?transport=tcp")}))})),t}bindPCEvents(){this._p2pConnection.onICEConnectionStateChange=e=>{var t;return null===(t=this.onICEConnectionStateChange)||void 0===t?void 0:t.call(this,e)},this._p2pConnection.onConnectionStateChange=e=>{var t;return null===(t=this.onConnectionStateChange)||void 0===t?void 0:t.call(this,e)},this._p2pConnection.onDTLSTransportStateChange=e=>{var t;return null===(t=this.onDTLSTransportStateChange)||void 0===t?void 0:t.call(this,e)},this._p2pConnection.onDTLSTransportError=e=>{var t;return null===(t=this.onDTLSTransportError)||void 0===t?void 0:t.call(this,e)},this._p2pConnection.onICETransportStateChange=e=>{var t;return null===(t=this.onICETransportStateChange)||void 0===t?void 0:t.call(this,e)},this._p2pConnection.onFirstAudioReceived=e=>{var t;return null===(t=this.onFirstAudioReceived)||void 0===t?void 0:t.call(this,e)},this._p2pConnection.onFirstVideoReceived=e=>{var t;return null===(t=this.onFirstVideoReceived)||void 0===t?void 0:t.call(this,e)},this._p2pConnection.onFirstAudioDecoded=e=>{var t;return null===(t=this.onFirstAudioDecoded)||void 0===t?void 0:t.call(this,e)},this._p2pConnection.onFirstVideoRender=e=>{var t;return null===(t=this.onFirstVideoRender)||void 0===t?void 0:t.call(this,e)},this._p2pConnection.onFirstVideoBufferReady=e=>{var t;return null===(t=this.onFirstVideoBufferReady)||void 0===t?void 0:t.call(this,e)},this._p2pConnection.onFirstVideoDecoded=(e,t,n)=>{var i;return null===(i=this.onFirstVideoDecoded)||void 0===i?void 0:i.call(this,e,t,n)},this._p2pConnection.onFirstVideoDecodedTimeout=e=>{var t;return null===(t=this.onFirstVideoDecodedTimeout)||void 0===t?void 0:t.call(this,e)},this._p2pConnection.onSelectedLocalCandidateChanged=(e,t)=>{var n;return null===(n=this.onSelectedLocalCandidateChanged)||void 0===n?void 0:n.call(this,e,t)},this._p2pConnection.onSelectedRemoteCandidateChanged=(e,t)=>{var n;return null===(n=this.onSelectedRemoteCandidateChanged)||void 0===n?void 0:n.call(this,e,t)}}closeSignal(){this.dataChannel.close(),this.peerConnection.close()}unbindConnectionEvents(e){e.onConnectionStateChange=void 0,e.onICEConnectionStateChange=void 0,e.onICETransportStateChange=void 0,e.onDTLSTransportStateChange=void 0,e.onDTLSTransportError=void 0,e.onFirstAudioDecoded=void 0,e.onFirstAudioReceived=void 0,e.onFirstVideoDecoded=void 0,e.onFirstVideoReceived=void 0,e.onSelectedLocalCandidateChanged=void 0,e.onSelectedRemoteCandidateChanged=void 0,e.onFirstVideoDecodedTimeout=void 0}setConfiguration(e){this._p2pConnection.setConfiguration(e)}},ce(xt.prototype,"connect",[Ft],Object.getOwnPropertyDescriptor(xt.prototype,"connect"),xt.prototype),ce(xt.prototype,"updateRemoteRTPCapabilities",[Ft],Object.getOwnPropertyDescriptor(xt.prototype,"updateRemoteRTPCapabilities"),xt.prototype),ce(xt.prototype,"createDataChannels",[Ft],Object.getOwnPropertyDescriptor(xt.prototype,"createDataChannels"),xt.prototype),ce(xt.prototype,"receive",[Ft],Object.getOwnPropertyDescriptor(xt.prototype,"receive"),xt.prototype),ce(xt.prototype,"stopReceiving",[Ft],Object.getOwnPropertyDescriptor(xt.prototype,"stopReceiving"),xt.prototype),ce(xt.prototype,"muteRemote",[Ft],Object.getOwnPropertyDescriptor(xt.prototype,"muteRemote"),xt.prototype),ce(xt.prototype,"unmuteRemote",[Ft],Object.getOwnPropertyDescriptor(xt.prototype,"unmuteRemote"),xt.prototype),ce(xt.prototype,"muteLocal",[Ft],Object.getOwnPropertyDescriptor(xt.prototype,"muteLocal"),xt.prototype),ce(xt.prototype,"unmuteLocal",[Ft],Object.getOwnPropertyDescriptor(xt.prototype,"unmuteLocal"),xt.prototype),ce(xt.prototype,"close",[Ft],Object.getOwnPropertyDescriptor(xt.prototype,"close"),xt.prototype),ce(xt.prototype,"updateEncoderConfig",[Ft],Object.getOwnPropertyDescriptor(xt.prototype,"updateEncoderConfig"),xt.prototype),ce(xt.prototype,"updateSendParameters",[Ft],Object.getOwnPropertyDescriptor(xt.prototype,"updateSendParameters"),xt.prototype),ce(xt.prototype,"replaceTrack",[Ft],Object.getOwnPropertyDescriptor(xt.prototype,"replaceTrack"),xt.prototype),ce(xt.prototype,"getRemoteSSRC",[Ft],Object.getOwnPropertyDescriptor(xt.prototype,"getRemoteSSRC"),xt.prototype),xt);function Ft(e,t,n){const i=e[t];if("function"!=typeof i)throw new Error("Cannot use mutex on object property.");return n.value=async function(){const e=this.mutex,n=await e.lock("From DataChannelConnection.".concat(t));try{for(var o=arguments.length,r=new Array(o),s=0;s<o;s++)r[s]=arguments[s];return await i.apply(this,r)}finally{n()}},n}Re.ACCESS_POINT,Ie.NO_FLAG_SET,Ie.FLAG_SET_BUT_EMPTY,Ie.INVALID_FALG_SET,Ie.FLAG_SET_BUT_NO_RE,Ie.INVALID_SERVICE_ID,Ie.NO_SERVICE_AVAILABLE,Ie.NO_SERVICE_AVAILABLE_P2P,Ie.NO_SERVICE_AVAILABLE_VOICE,Ie.NO_SERVICE_AVAILABLE_WEBRTC,Ie.NO_SERVICE_AVAILABLE_CDS,Ie.NO_SERVICE_AVAILABLE_CDN,Ie.NO_SERVICE_AVAILABLE_TDS,Ie.NO_SERVICE_AVAILABLE_REPORT,Ie.NO_SERVICE_AVAILABLE_APP_CENTER,Ie.NO_SERVICE_AVAILABLE_ENV0,Ie.NO_SERVICE_AVAILABLE_VOET,Ie.NO_SERVICE_AVAILABLE_STRING_UID,Ie.NO_SERVICE_AVAILABLE_WEBRTC_UNILBS,Re.UNILBS,fe.INVALID_VENDOR_KEY,fe.INVALID_CHANNEL_NAME,fe.INTERNAL_ERROR,fe.NO_AUTHORIZED,fe.DYNAMIC_KEY_TIMEOUT,fe.NO_ACTIVE_STATUS,fe.DYNAMIC_KEY_EXPIRED,fe.STATIC_USE_DYNAMIC_KEY,fe.DYNAMIC_USE_STATIC_KEY,fe.USER_OVERLOAD,fe.FORBIDDEN_REGION,fe.CANNOT_MEET_AREA_DEMAND,fe.REQ_DOWNGRADE_FALLBACK,Re.STRING_UID_ALLOCATOR,Se.IIIEGAL_APPID,Se.IIIEGAL_UID,Se.INTERNAL_ERROR;const kt={[Ne.K_TIMESTAMP_EXPIRED]:{desc:"K_TIMESTAMP_EXPIRED",action:"failed"},[Ne.K_CHANNEL_PERMISSION_INVALID]:{desc:"K_CHANNEL_PERMISSION_INVALID",action:"failed"},[Ne.K_CERTIFICATE_INVALID]:{desc:"K_CERTIFICATE_INVALID",action:"failed"},[Ne.K_CHANNEL_NAME_EMPTY]:{desc:"K_CHANNEL_NAME_EMPTY",action:"failed"},[Ne.K_CHANNEL_NOT_FOUND]:{desc:"K_CHANNEL_NOT_FOUND",action:"failed"},[Ne.K_TICKET_INVALID]:{desc:"K_TICKET_INVALID",action:"failed"},[Ne.K_CHANNEL_CONFLICTED]:{desc:"K_CHANNEL_CONFLICTED",action:"failed"},[Ne.K_SERVICE_NOT_READY]:{desc:"K_SERVICE_NOT_READY",action:"tryNext"},[Ne.K_SERVICE_TOO_HEAVY]:{desc:"K_SERVICE_TOO_HEAVY",action:"tryNext"},[Ne.K_UID_BANNED]:{desc:"K_UID_BANNED",action:"failed"},[Ne.K_IP_BANNED]:{desc:"K_IP_BANNED",action:"failed"},[Ne.DATASTREAM2_NOT_AVAILABLE]:{desc:"DATASTREAM2_NOT_AVAILABLE",action:"quit"},[Ne.K_AUTO_REBALANCE]:{desc:"k_AUTO_REBALANCE",action:"recover"},[Ne.K_VOS_FALLBACK]:{desc:"K_VOS_FALLBACK",action:"tryNext"},[Ne.ERR_INVALID_VENDOR_KEY]:{desc:"ERR_INVALID_VENDOR_KEY",action:"failed"},[Ne.ERR_INVALID_CHANNEL_NAME]:{desc:"ERR_INVALID_CHANNEL_NAME",action:"failed"},[Ne.WARN_NO_AVAILABLE_CHANNEL]:{desc:"WARN_NO_AVAILABLE_CHANNEL",action:"failed"},[Ne.WARN_LOOKUP_CHANNEL_TIMEOUT]:{desc:"WARN_LOOKUP_CHANNEL_TIMEOUT",action:"tryNext"},[Ne.WARN_LOOKUP_CHANNEL_REJECTED]:{desc:"WARN_LOOKUP_CHANNEL_REJECTED",action:"failed"},[Ne.WARN_OPEN_CHANNEL_TIMEOUT]:{desc:"WARN_OPEN_CHANNEL_TIMEOUT",action:"tryNext"},[Ne.WARN_OPEN_CHANNEL_REJECTED]:{desc:"WARN_OPEN_CHANNEL_REJECTED",action:"failed"},[Ne.WARN_REQUEST_DEFERRED]:{desc:"WARN_REQUEST_DEFERRED",action:"failed"},[Ne.ERR_DYNAMIC_KEY_TIMEOUT]:{desc:"ERR_DYNAMIC_KEY_TIMEOUT",action:"failed"},[Ne.ERR_NO_AUTHORIZED]:{desc:"ERR_NO_AUTHORIZED",action:"failed"},[Ne.ERR_VOM_SERVICE_UNAVAILABLE]:{desc:"ERR_VOM_SERVICE_UNAVAILABLE",action:"tryNext"},[Ne.ERR_NO_CHANNEL_AVAILABLE_CODE]:{desc:"ERR_NO_CHANNEL_AVAILABLE_CODE",action:"failed"},[Ne.ERR_MASTER_VOCS_UNAVAILABLE]:{desc:"ERR_MASTER_VOCS_UNAVAILABLE",action:"tryNext"},[Ne.ERR_INTERNAL_ERROR]:{desc:"ERR_INTERNAL_ERROR",action:"tryNext"},[Ne.ERR_NO_ACTIVE_STATUS]:{desc:"ERR_NO_ACTIVE_STATUS",action:"failed"},[Ne.ERR_INVALID_UID]:{desc:"ERR_INVALID_UID",action:"failed"},[Ne.ERR_DYNAMIC_KEY_EXPIRED]:{desc:"ERR_DYNAMIC_KEY_EXPIRED",action:"failed"},[Ne.ERR_STATIC_USE_DYANMIC_KE]:{desc:"ERR_STATIC_USE_DYANMIC_KE",action:"failed"},[Ne.ERR_DYNAMIC_USE_STATIC_KE]:{desc:"ERR_DYNAMIC_USE_STATIC_KE",action:"failed"},[Ne.ERR_NO_VOCS_AVAILABLE]:{desc:"ERR_NO_VOCS_AVAILABLE",action:"tryNext"},[Ne.ERR_NO_VOS_AVAILABLE]:{desc:"ERR_NO_VOS_AVAILABLE",action:"tryNext"},[Ne.ERR_JOIN_CHANNEL_TIMEOUT]:{desc:"ERR_JOIN_CHANNEL_TIMEOUT",action:"tryNext"},[Ne.ERR_JOIN_BY_MULTI_IP]:{desc:"ERR_JOIN_BY_MULTI_IP",action:"recover"},[Ne.ERR_NOT_JOINED]:{desc:"ERR_NOT_JOINED",action:"failed"},[Ne.ERR_REPEAT_JOIN_REQUEST]:{desc:"ERR_REPEAT_JOIN_REQUEST",action:"quit"},[Ne.ERR_REPEAT_JOIN_CHANNEL]:{desc:"ERR_REPEAT_JOIN_CHANNEL",action:"quit"},[Ne.ERR_INVALID_STRINGUID]:{desc:"ERR_INVALID_STRINGUID",action:"failed"},[Ne.ERR_TOO_MANY_USERS]:{desc:"ERR_TOO_MANY_USERS",action:"tryNext"},[Ne.ERR_SET_CLIENT_ROLE_TIMEOUT]:{desc:"ERR_SET_CLIENT_ROLE_TIMEOUT",action:"failed"},[Ne.ERR_SET_CLIENT_ROLE_NO_PERMISSION]:{desc:"ERR_SET_CLIENT_ROLE_TIMEOUT",action:"failed"},[Ne.ERR_SET_CLIENT_ROLE_ALREADY_IN_USE]:{desc:"ERR_SET_CLIENT_ROLE_ALREADY_IN_USE",action:"success"},[Ne.ERR_PUBLISH_REQUEST_INVALID]:{desc:"ERR_PUBLISH_REQUEST_INVALID",action:"failed"},[Ne.ERR_SUBSCRIBE_REQUEST_INVALID]:{desc:"ERR_SUBSCRIBE_REQUEST_INVALID",action:"failed"},[Ne.ERR_NOT_SUPPORTED_MESSAGE]:{desc:"ERR_NOT_SUPPORTED_MESSAGE",action:"failed"},[Ne.ERR_ILLEAGAL_PLUGIN]:{desc:"ERR_ILLEAGAL_PLUGIN",action:"failed"},[Ne.ILLEGAL_CLIENT_ROLE_LEVEL]:{desc:"ILLEGAL_CLIENT_ROLE_LEVEL",action:"failed"},[Ne.ERR_REJOIN_TOKEN_INVALID]:{desc:"ERR_REJOIN_TOKEN_INVALID",action:"failed"},[Ne.ERR_REJOIN_USER_NOT_JOINED]:{desc:"ERR_REJOIN_NOT_JOINED",action:"failed"},[Ne.ERR_INVALID_OPTIONAL_INFO]:{desc:"ERR_INVALID_OPTIONAL_INFO",action:"quit"},[Ne.ERR_TEST_RECOVER]:{desc:"ERR_TEST_RECOVER",action:"recover"},[Ne.ERR_TEST_TRYNEXT]:{desc:"ERR_TEST_TRYNEXT",action:"recover"},[Ne.ERR_TEST_RETRY]:{desc:"ERR_TEST_RETRY",action:"recover"},[Ne.ILLEGAL_AES_PASSWORD]:{desc:"ERR_TEST_RETRY",action:"failed"},[Ne.ERR_TOO_MANY_BROADCASTERS]:{desc:"ERR_TOO_MANY_BROADCASTERS",action:"failed"},[Ne.ERR_TOO_MANY_SUBSCRIBERS]:{desc:"ERR_TOO_MANY_SUBSCRIBERS",action:"failed"},[Ne.ERR_LICENSE_ILLEGAL]:{desc:"ERR_LICENSE_ILLEGAL",action:"quit"},[Ne.ERR_LICENSE_MISSING]:{desc:"ERR_LICENSE_MISSING",action:"quit"},[Ne.ERR_LICENSE_EXPIRED]:{desc:"ERR_LICENSE_EXPIRED",action:"quit"},[Ne.ERR_LICENSE_MINUTES_EXCEEDED]:{desc:"ERR_LICENSE_MINUTES_EXCEEDED",action:"quit"},[Ne.ERR_LICENSE_PERIOD_INVALID]:{desc:"ERR_LICENSE_PERIOD_INVALID",action:"quit"},[Ne.ERR_LICENSE_MULTIPLE_SDK_SERVICE]:{desc:"ERR_LICENSE_MULTIPLE_SDK_SERVICE",action:"quit"}};function Bt(e){const t=kt[e];return t||{desc:"UNKNOWN_ERROR_".concat(e),action:"failed"}}class Gt extends o{get url(){return this._url?this._url:null}get reconnectMode(){return this._reconnectMode}set reconnectMode(e){["tryNext","recover"].includes(e)&&this.resetReconnectCount(e),this._reconnectMode=e}get state(){return this._state}set state(e){e!==this._state&&(this._state=e,"reconnecting"===this._state?this.emit(Ue.RECONNECTING,this.reconnectReason):"connected"===this._state?this.emit(Ue.CONNECTED):"closed"===this._state?this.emit(Ue.CLOSED):"failed"===this._state&&this.emit(Ue.FAILED))}constructor(e,t,n,i){super(),this.connectionID=0,this.currentURLIndex=0,this.reconnectReason=void 0,this._reconnectMode="tryNext",this._initMutex=void 0,this._name=void 0,this._state="closed",this._reconnectInterrupter=void 0,this._url=void 0,this._retryConfig=void 0,this._reconnectCount=0,this._forceCloseTimeout=5e3,this._onlineReconnectListener=void 0,this._closeEstablishingTransmitter=()=>{},this._store=void 0,this._joinChannelServiceRecordIndex=void 0,this._transmitter=void 0,this._useCompress=void 0,this._inflateLength=0,this._deflateLength=0,this._store=i,this._name=e,this._retryConfig=_e({},t),this._useCompress=n}resetReconnectCount(t){e.debug("".concat(this._name," reset reconnect count, reason: ").concat(t)),this._reconnectCount=0}close(e,t){if(this.currentURLIndex=0,this.resetReconnectCount("close"),this._reconnectInterrupter&&this._reconnectInterrupter(),this._transmitter){this._transmitter.onclose=null,this._transmitter.onopen=null,this._transmitter.onmessage=null;const e=this._transmitter;t?setTimeout((()=>e.close()),500):e.close(),this._transmitter=void 0}this.state=e?"failed":"closed",this._closeEstablishingTransmitter&&this._closeEstablishingTransmitter()}reconnect(t,n){if(!this._transmitter)return void e.warning("[".concat(this._name,"] can not reconnect, no websocket"));var i;(void 0!==t&&(this.reconnectMode=t),e.debug("[".concat(this._name,"] reconnect is triggered initiative")),"number"==typeof this._joinChannelServiceRecordIndex)&&(null===(i=this._store)||void 0===i||i.recordJoinChannelService({status:"error",errors:[new Error(n)]},this._joinChannelServiceRecordIndex));const o=this._transmitter.onclose;this._transmitter.onclose=null,this._transmitter.close(),o&&o.bind(this._transmitter)({code:9999,reason:n})}getInflateData(){const e=this._inflateLength,t=this._deflateLength;return this.clearInflateData(),{inflateLength:e,deflateLength:t}}setInflateData(e){this._deflateLength=this._deflateLength+e.originLength,this._inflateLength=this._inflateLength+e.compressedLength}clearInflateData(){this._inflateLength=0,this._deflateLength=0}}let Ht=function(e){return e[e.Default=0]="Default",e[e.Ack=1]="Ack",e}({});class Kt{constructor(e,t,n){this.version=1,this.initialRTO=void 0,this.maxBatchAckCount=void 0,this.maxRTO=void 0,this.initialRTT=void 0,this.ID=void 0,this.rtt=void 0,this.packetNumber=1,this.rtoRatioMap=new Map,this.timeoutMap=new Map,this.unorderedPacketQueue=[],this.batchAckPacketQueue=[],this.lastOrderedPacketNumber=0,this.batchAckTimer=void 0,this.sendImpl=void 0,this.receiveImpl=void 0,this.sendImpl=e,this.receiveImpl=t,this.ID=l(7,"transmitter-"),this.initialRTO=void 0!==(null==n?void 0:n.initialRTO)?n.initialRTO:r("TRANSMITTER_INITIAL_RTO"),this.initialRTT=void 0!==(null==n?void 0:n.initialRTT)?n.initialRTT:r("TRANSMITTER_INITIAL_RTT"),this.rtt=void 0!==(null==n?void 0:n.initialRTT)?n.initialRTT:r("TRANSMITTER_INITIAL_RTT"),this.maxBatchAckCount=void 0!==(null==n?void 0:n.maxBatchAckCount)?n.maxBatchAckCount:r("TRANSMITTER_MAX_BATCH_ACK_COUNT"),this.maxRTO=void 0!==(null==n?void 0:n.maxRTO)?n.maxRTO:r("TRANSMITTER_MAX_RTO")}packetize(e,t){return{type:Ht.Default,version:this.version,packetNumber:t,payload:e}}serialize(e){switch(e.type){case Ht.Default:{let t;if("string"==typeof e.payload){t=(new TextEncoder).encode(e.payload)}else t=e.payload;const n=new ArrayBuffer(t.length+15),i=new DataView(n);i.setUint16(0,e.version),i.setUint8(2,e.type),i.setUint32(3,e.packetNumber),F(i,7,BigInt(e.sendTs));return new Uint8Array(i.buffer).set(t,15),n}case Ht.Ack:{const t=new ArrayBuffer(16),n=new DataView(t);return n.setUint16(0,e.version),n.setUint8(2,e.type),n.setUint32(3,e.maxAckPacketNumber),n.setUint8(7,e.shift),F(n,8,BigInt(e.ackSendTs)),t}}}deserialize(t){const n=new DataView(t),i=n.getUint16(0),o=n.getUint8(2);switch(o){case Ht.Default:{const e=n.getUint32(3),r=k(n,7),s=t.slice(15),a=new Uint8Array(s);return{version:i,type:o,packetNumber:e,sendTs:Number(r),payload:a}}case Ht.Ack:{const e=n.getUint32(3),t=n.getUint8(7),r=k(n,8);return{version:i,type:o,maxAckPacketNumber:e,shift:t,ackSendTs:Number(r)}}default:throw e.error("[".concat(this.ID,"] Unrecognized packet type ").concat(o)),new Error("Unrecognized packet type ".concat(o))}}sendMessage(t){r("DC_DEBUG_LOG")&&"string"==typeof t&&e.debug("[".concat(this.ID,"] sending message packet"),JSON.parse(t));const n=this.packetize(t,this.packetNumber);this.packetNumber=4294967295===this.packetNumber?1:this.packetNumber+1;const i=this.calculateRTO(n),o=window.setTimeout((()=>{this.resendMessage(n)}),i);this.timeoutMap.set(n.packetNumber,o),this.sendPacket(n)}onData(e){const t=this.deserialize(e);t.type===Ht.Default?this.ack(t):t.type===Ht.Ack&&(this.updateRTT(t,Math.round(performance.now())),this.clearRTO(t))}close(){this.rtt=this.initialRTT,this.packetNumber=1,Array.from(this.timeoutMap.entries()).forEach((e=>{let[t,n]=e;window.clearTimeout(n)})),this.timeoutMap=new Map,this.rtoRatioMap=new Map,this.unorderedPacketQueue=[],this.batchAckPacketQueue=[],this.lastOrderedPacketNumber=0,void 0!==this.batchAckTimer&&window.clearTimeout(this.batchAckTimer)}resendMessage(t){const n=this.calculateRTO(t),i=window.setTimeout((()=>{r("DC_DEBUG_LOG")&&"string"==typeof t.payload&&e.debug("[".concat(this.ID,"] resending message packet"),JSON.parse(t.payload),"timeout: ".concat(n)),this.resendMessage(t)}),n);this.timeoutMap.set(t.packetNumber,i),this.sendPacket(t)}calculateRTO(e){const t=this.rtoRatioMap.get(e.packetNumber);if(void 0===t)return this.rtoRatioMap.set(e.packetNumber,1),this.initialRTO;{const n=9*this.rtt/8*t;return this.rtoRatioMap.set(e.packetNumber,t+1),n>this.maxRTO?this.maxRTO:n}}updateRTT(e,t){const n=e.ackSendTs;this.rtt=this.rtt*(7/8)+(t-n-this.rtt)/8}ack(t){if(t.packetNumber===this.lastOrderedPacketNumber+1)for(this.batchAckPacketQueue.length>=this.maxBatchAckCount&&this.batchAck(),this.batchAckTimer?this.batchAckPacketQueue.push(t):(this.batchAckPacketQueue.push(t),this.batchAckTimer=window.setTimeout((()=>{this.batchAck()}),this.rtt/8)),this.lastOrderedPacketNumber+=1,this.receiveImpl(t.payload);;){const e=this.unorderedPacketQueue[0];if(!e){this.unorderedPacketQueue.shift();break}this.batchAckTimer&&this.batchAck(),this.receiveImpl(e.payload),this.unorderedPacketQueue.shift(),this.lastOrderedPacketNumber+=1}else if(t.packetNumber<=this.lastOrderedPacketNumber){const n={ackSendTs:t.sendTs,maxAckPacketNumber:t.packetNumber,shift:0,type:Ht.Ack,version:this.version};r("DC_DEBUG_LOG")&&e.debug("[".concat(this.ID,"] sending ack packet"),n,"packetNumber: ".concat(t.packetNumber)),this.sendPacket(n)}else if(t.packetNumber>this.lastOrderedPacketNumber){this.unorderedPacketQueue[t.packetNumber-this.lastOrderedPacketNumber-2]=t;const n={ackSendTs:t.sendTs,maxAckPacketNumber:t.packetNumber,shift:0,type:Ht.Ack,version:this.version};r("DC_DEBUG_LOG")&&e.debug("[".concat(this.ID,"] sending ack packet"),n,"packetNumber: ".concat(t.packetNumber)),this.sendPacket(n)}}batchAck(){window.clearTimeout(this.batchAckTimer),this.batchAckTimer=void 0;const t={ackSendTs:this.batchAckPacketQueue[this.batchAckPacketQueue.length-1].sendTs,maxAckPacketNumber:this.batchAckPacketQueue[this.batchAckPacketQueue.length-1].packetNumber,shift:this.batchAckPacketQueue.length-1,type:Ht.Ack,version:this.version};r("DC_DEBUG_LOG")&&e.debug("[".concat(this.ID,"] sending batch ack packet"),t,"shift: ".concat(this.batchAckPacketQueue.length-1)),this.sendPacket(t),this.batchAckPacketQueue=[]}sendPacket(e){e.type===Ht.Default&&(e.sendTs=Math.round(performance.now()));const t=this.serialize(e);this.sendImpl(t)}clearRTO(e){for(let t=e.maxAckPacketNumber-e.shift;t<=e.maxAckPacketNumber;t++){const e=this.timeoutMap.get(t);void 0!==e&&window.clearTimeout(e),this.timeoutMap.delete(t),this.rtoRatioMap.delete(t)}}}class Wt extends Gt{constructor(e,t){super(e,t,arguments.length>2&&void 0!==arguments[2]&&arguments[2],arguments.length>3?arguments[3]:void 0),this._initMutex=void 0,this._reconnectInterrupter=void 0,this._url=void 0,this._transmitter=void 0,this._addresses=void 0,this._reliableTransmission=void 0,this._textEncoder=void 0,this._textDecoder=void 0,this._textEncoder=new TextEncoder,this._textDecoder=new TextDecoder,this._initMutex=new P("datachannel");const{timeout:n,timeoutFactor:i}=t,o=Math.max(300,Math.floor(3*n/5)),r=Math.max(1.2,Math.floor(8*i)/10);B.ONLINE&&(this._retryConfig.timeout=o,this._retryConfig.timeoutFactor=r),G.on(H.NETWORK_STATE_CHANGE,((e,t)=>{e!==t&&(this.resetReconnectCount("network state change: ".concat(t," -> ").concat(e)),e===B.ONLINE?(this._retryConfig.timeout=o,this._retryConfig.timeoutFactor=r):(this._retryConfig.timeout=n,this._retryConfig.timeoutFactor=i))}))}getConnection(){if(this._reliableTransmission)return this._reliableTransmission}async init(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5e3;this._forceCloseTimeout=t;const i=(t,i)=>{this._addresses=e,this.currentURLIndex=this._addresses.findIndex((e=>e.fingerprint||r("FINGERPRINT")));const o=this._addresses[this.currentURLIndex];this.state="connecting",this.createTransmitterConnection(o).then(t).catch(i),this.once(Ue.CLOSED,(()=>i(new n(w.WS_DISCONNECT)))),this.once(Ue.CONNECTED,(()=>t()))};return this._initMutex.lock().then((e=>new Promise(((e,t)=>{i(e,t)})).then((()=>{e()})).catch((()=>{e()}))))}async sendMessage(e){let t=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(!this._transmitter||!this._reliableTransmission)throw new n(w.WS_ABORT,"datachannel is not ready");try{t||(e=JSON.stringify(e));const n=this._textEncoder.encode(e),i=re(n,{raw:!0});this._reliableTransmission.sendMessage(i)}catch(e){throw new n(w.WS_ERR,"send datachannel signal message error"+e.toString())}}unbindDcCloseEventListener(){this._transmitter&&(this._transmitter.onclose=null)}sendMessageWithJSON(e){const t=JSON.stringify(e);return{compressed:t,compressedLength:t.length,origin:e}}sendMessageWithUint8Array(e){return{compressed:e,compressedLength:e.byteLength,origin:e}}createTransmitterConnection(t){return this.connectionID+=1,this._joinChannelServiceRecordIndex=void 0,this._url="dc://".concat(t.ip,":").concat(t.port),new Promise(((i,o)=>{var r;const s=()=>{e.debug("[".concat(this._name,"] datachannel opened:"),this._url),this.reconnectMode="recover",this.state="connected",this.resetReconnectCount("opened"),i()},a=async t=>{var r;if(null===(r=this._closeEstablishingTransmitter)||void 0===r||r.call(this),e.debug("[".concat(this._name,"] datachannel close ").concat(this._url,", code: ").concat(t.code,", reason: ").concat(t.reason,", current mode: ").concat(this.reconnectMode)),this._reconnectCount<this._retryConfig.maxRetryCount){"connected"===this.state&&(this.reconnectReason=t.reason,this.state="reconnecting");const r=j(this,Ue.WILL_RECONNECT,this.reconnectMode)||this.reconnectMode,s=await this.reconnectWithAction(r);if("closed"===this.state)return void e.debug("[".concat(this.connectionID,"] dc is closed, no need to reconnect"));if(!s)return o(new n(w.WS_DISCONNECT,"datachannel reconnect failed: ".concat(t.code))),void this.close(!0);i()}else o(new n(w.WS_DISCONNECT,"datachannel close: ".concat(t.code))),this.close()},c=async e=>{try{var t;null===(t=this._reliableTransmission)||void 0===t||t.onData(e.data)}catch(e){console.log(e)}};this._transmitter&&(this._transmitter.onclose=null,this._transmitter.close()),this._reliableTransmission&&(this._reliableTransmission.close(),this._reliableTransmission=void 0),e.debug("[".concat(this._name,"] start connect, address: ").concat(JSON.stringify(t)));const d=null===(r=this._store)||void 0===r?void 0:r.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"gateway"}),p=Date.now();K(this,Ue.TO_CONNECT_DATACHANNEL).then((t=>{var n,i;if(!t)throw new Error("transmissonInfo not exist yet");const{transmitter:o,close:r}=t;this._transmitter=o,null===(n=this._store)||void 0===n||n.signalChannelOpen();const l=Date.now()-p;e.debug("[choose dc] dc open cost ".concat(l,"ms"));this._reliableTransmission=new Kt((e=>{var t;this._transmitter&&"open"===this._transmitter.readyState&&(null===(t=this._transmitter)||void 0===t||t.send(e))}),(e=>{if("string"==typeof e)this.emit(Ue.ON_MESSAGE,e);else{const t=se(e,{raw:!0}).buffer,n=this._textDecoder.decode(t);this.emit(Ue.ON_MESSAGE,n)}})),this._closeEstablishingTransmitter=()=>{var e;null===(e=this._reliableTransmission)||void 0===e||e.close(),this._reliableTransmission=void 0,r()},s&&s(),o.onclose=a,o.onmessage=c,null===(i=this._store)||void 0===i||i.recordJoinChannelService({endTs:Date.now(),status:"success"},d),this._joinChannelServiceRecordIndex=d})).catch((t=>{var i;if(null===(i=this._store)||void 0===i||i.recordJoinChannelService({endTs:Date.now(),status:t instanceof n&&t.code===w.WS_ABORT?"aborted":"error",errors:[t]},d),"closed"!==this.state){if(t instanceof n&&t.code===w.WS_ERR){const i=new n(w.WS_ERR,"init datachannel failed! Error: ".concat(t.toString()));return e.error("[".concat(this._name,"]").concat(i)),void o(i)}a&&a(t)}else o(new n(w.WS_DISCONNECT,"datachannel is closed: ".concat(t.toString())))}))}))}async reconnectWithAction(t){let n=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(this._reconnectCount>=this._retryConfig.maxRetryCount)return!1;if(!this._addresses)return!1;if("closed"===this.state)return!1;this._onlineReconnectListener||G.networkState!==B.OFFLINE||(this._onlineReconnectListener=G.onlineWaiter&&G.onlineWaiter.then((()=>{this._onlineReconnectListener=void 0})));let i=!0;if(this._reconnectInterrupter=()=>{i=!1},n){const n=W(this._reconnectCount,this._retryConfig);e.debug("[".concat(this._name,"] wait ").concat(n,"ms to reconnect datachannel, mode: ").concat(t)),await Promise.race([Y(n),this._onlineReconnectListener||new Promise((()=>{}))])}if("closed"===this.state||!i)return!1;this._reconnectCount+=1;const o=async(e,t)=>{this.emit(Ue.RECONNECT_CREATE_CONNECTION,t),await this.createTransmitterConnection(e)};try{if("retry"===t){const e=this._addresses[this.currentURLIndex];await o(e,t)}else if("tryNext"===t){this.currentURLIndex+=1;for(let e=this.currentURLIndex;e<this._addresses.length;e++){if(this._addresses[e].fingerprint||r("FINGERPRINT")){this.currentURLIndex=e;break}this.currentURLIndex+=1}if(this.currentURLIndex>=this._addresses.length)return e.debug("[".concat(this._name,"] the available addresses are exhausted, change to recover")),await this.reconnectWithAction("recover",!1);e.debug("[".concat(this._name,"] datachannel url length: ").concat(this._addresses.length," current index: ").concat(this.currentURLIndex));const n=this._addresses[this.currentURLIndex];await o(n,t)}else"recover"===t&&(e.debug("[".concat(this._name,"] start to failback to websocket")),this.resetReconnectCount("recover mode"),this.emit(Ue.FAILBACK));return!0}catch(i){var s;return e.error("[".concat(this._name,"] reconnect failed"),i.toString()),null!=i&&null!==(s=i.data)&&void 0!==s&&s.desc&&Array.isArray(i.data.desc)&&i.data.desc.length&&i.data.desc.includes("dynamic key expired")?(this.emit(Ue.ON_TOKEN_PRIVILEGE_DID_EXPIRE),!1):await this.reconnectWithAction(t,n)}}}class Yt extends o{get connectionState(){return this._connectionState}set connectionState(e){e!==this._connectionState&&(this._connectionState=e,e===ge.CONNECTED?this.emit(Te.WS_CONNECTED):e===ge.RECONNECTING?this.emit(Te.WS_RECONNECTING,this._websocketReconnectReason):e===ge.CLOSED&&this.emit(Te.WS_CLOSED,this._disconnectedReason))}get currentURLIndex(){return this.websocket.currentURLIndex}get url(){return this.websocket?this.websocket.url:null}get rtt(){return this.rttRolling.mean()}processPendingNotifications(){0!==this.pendingNotifications.length&&(e.debug("[".concat(this.clientId,"] processing ").concat(this.pendingNotifications.length," pending notifications")),this.pendingNotifications.forEach((e=>{let{type:t,message:n}=e;this.emit(t,n),t===ve.ON_NOTIFICATION&&this.handleNotification(n),t===ve.ON_USER_BANNED&&this.handleUserBanned(n)})),this.pendingNotifications=[])}handleUserBanned(e){switch(e.error_code){case 14:this.close(J.UID_BANNED);break;case 15:this.close(J.IP_BANNED);break;case 16:this.close(J.CHANNEL_BANNED)}}constructor(t,n){super(),this.__name__="DataChannelSignal",this._disconnectedReason=void 0,this._websocketReconnectReason=void 0,this._connectionState=ge.CLOSED,this.reconnectToken=void 0,this.websocket=void 0,this.openConnectionTime=void 0,this.clientId=void 0,this.lastMsgTime=Date.now(),this.uploadCache=[],this.uploadCacheInterval=void 0,this.rttRolling=new X(5),this.pingpongTimer=void 0,this.inflateDataTimer=void 0,this.pingpongTimeoutCount=0,this.ortc=void 0,this.joinResponse=void 0,this.multiIpOption=void 0,this.initError=void 0,this.spec=void 0,this.store=void 0,this.isJoining=!1,this.pendingNotifications=[],this.onWebsocketMessage=t=>{if(t instanceof ArrayBuffer)return void this.emit(Te.ON_BINARY_DATA,t);const n=JSON.parse(t);if(r("DC_DEBUG_LOG")&&e.debug("[datachannel-signal] received packet",n),this.lastMsgTime=Date.now(),Object.prototype.hasOwnProperty.call(n,"_id")){const e="res-@".concat(n._id);this.emit(e,n._result,n._message)}else Object.prototype.hasOwnProperty.call(n,"_type")&&(this.isJoining?n._type===ve.ON_NOTIFICATION||n._type===ve.ON_USER_BANNED?(this.emit(n._type,n._message),n._type===ve.ON_NOTIFICATION&&this.handleNotification(n._message),n._type===ve.ON_USER_BANNED&&this.handleUserBanned(n._message)):(this.pendingNotifications.push({type:n._type,message:n._message}),e.debug("[".concat(this.clientId,"] cached notification during join: ").concat(n._type))):(this.emit(n._type,n._message),n._type===ve.ON_NOTIFICATION&&this.handleNotification(n._message),n._type===ve.ON_USER_BANNED&&this.handleUserBanned(n._message)))},this.clientId=t.clientId,this.spec=t,this.store=n,this.websocket=new Wt("gateway-".concat(this.clientId),this.spec.retryConfig,!0,n),this.handleWebsocketEvents(),window.addEventListener("offline",(()=>{this.connectionState===ge.CONNECTED&&this.reconnect("retry",Me.OFFLINE)}))}async request(t,i,o,s){const a=l(6,""),c={_id:a,_type:t,_message:i},d=this.websocket.connectionID,p=()=>new Promise(((e,i)=>{if(this.connectionState===ge.CONNECTED)return e();const o=()=>{this.off(Te.WS_CLOSED,r),e()},r=()=>{this.off(Te.WS_CONNECTED,o),i(new n(w.WS_ABORT))};this.once(Te.WS_CONNECTED,o),this.once(Te.WS_CLOSED,r),t!==Ae.PUBLISH&&t!==Ae.SUBSCRIBE&&t!==Ae.UNSUBSCRIBE&&t!==Ae.UNPUBLISH&&t!==Ae.CONTROL&&t!==Ae.RESTART_ICE||this.once(Te.DISCONNECT_P2P,(()=>{i(new n(w.DISCONNECT_P2P))})),t!==Ae.PUBLISH&&t!==Ae.RESTART_ICE||this.once(Te.ABORT_P2P_EXECUTION,(()=>{i(new n(w.DISCONNECT_P2P))}))}));if(this.connectionState!==ge.CONNECTING&&this.connectionState!==ge.RECONNECTING||t===Ae.JOIN||t===Ae.REJOIN||await p(),t===Ae.LEAVE&&(this.websocket.unbindDcCloseEventListener(),s=!0),r("DC_DEBUG_LOG")&&e.debug("[datachannel-signal] sendMessage",c),await this.websocket.sendMessage(c,!0,!1),s)return;const h=new Promise(((o,s)=>{let c=!1;const p=(e,n)=>{c=!0,o({isSuccess:"success"===e,message:n||{}}),this.off(Te.WS_CLOSED,l),this.off(Te.WS_RECONNECTING,l),this.emit(Te.REQUEST_SUCCESS,t,i)};this.once("res-@".concat(a),p);const l=()=>{s(new n(w.WS_ABORT,"type: ".concat(t))),this.off(Te.WS_CLOSED,l),this.off(Te.WS_RECONNECTING,l),this.off("res-@".concat(a),p)};this.once(Te.WS_CLOSED,l),this.once(Te.WS_RECONNECTING,l),Y(r("SIGNAL_REQUEST_TIMEOUT")).then((()=>{this.websocket.connectionID!==d||c||(e.warning("dc request timeout, type: ".concat(t)),this.emit(Te.REQUEST_TIMEOUT,t,i))}))}));let u=null;try{u=await h}catch(e){if(this.connectionState===ge.CLOSED||t===Ae.LEAVE)throw new n(w.WS_ABORT);return!this.spec.forceWaitGatewayResponse||o?e.throw():t===Ae.JOIN||t===Ae.REJOIN?null:(await p(),await this.request(t,i))}if(u.isSuccess)return u.message;const E=Number(u.message.error_code||u.message.code),_=Bt(E),C=new n(w.UNEXPECTED_RESPONSE,"".concat(_.desc,": ").concat(u.message.error_str),{code:E,data:u.message});return"success"===_.action?u.message:(e.warning("[".concat(this.websocket.connectionID,"] unexpected response from type ").concat(t,", error_code: ").concat(E,", message: ").concat(_.desc,", action: ").concat(_.action)),E===Ne.ERR_TOO_MANY_BROADCASTERS?t===Ae.JOIN||t===Ae.REJOIN?(this.initError=C,this.close(),C.throw()):C.throw():"failed"===_.action?C.throw():"quit"===_.action?(this.initError=C,this.close(),C.throw()):(E===Ne.ERR_JOIN_BY_MULTI_IP?(this.multiIpOption=u.message.option,e.warning("[".concat(this.clientId,"] detect multi ip, recover")),this.reconnect("recover",Me.MULTI_IP)):this.reconnect(_.action,Me.SERVER_ERROR),t===Ae.JOIN||t===Ae.REJOIN?null:await this.request(t,i)))}waitMessage(e,t){return new Promise((n=>{const i=o=>{(!t||t(o))&&(this.off(e,i),n(o))};this.on(e,i)}))}uploadWRTCStats(t){if(!this.store.sessionId)return void e.warn("[".concat(this.clientId,"] no session id when upload wrtc stats"));const n={lts:Date.now(),sid:this.store.sessionId,uid:this.store.intUid,stats:t};this.upload(De.WRTC_STATS,n)}upload(e,t){const n={_type:e,_message:t};try{this.websocket.sendMessage(n)}catch(e){const t=r("MAX_UPLOAD_CACHE")||50;this.uploadCache.push(n),this.uploadCache.length>t&&this.uploadCache.splice(0,1),this.uploadCache.length>0&&!this.uploadCacheInterval&&(this.uploadCacheInterval=window.setInterval((()=>{if(this.connectionState!==ge.CONNECTED)return;const e=this.uploadCache.splice(0,1)[0];0===this.uploadCache.length&&(window.clearInterval(this.uploadCacheInterval),this.uploadCacheInterval=void 0),this.upload(e._type,e._message)}),r("UPLOAD_CACHE_INTERVAL")||2e3))}}async send(e,t){const n={_type:e,_message:t};await this.websocket.sendMessage(n)}init(t){return this.initError=void 0,this.multiIpOption=void 0,this.joinResponse=void 0,this.reconnectToken=void 0,this.openConnectionTime=void 0,new Promise(((i,o)=>{this.once(Te.WS_CONNECTED,(()=>i(this.joinResponse))),this.once(Te.WS_CLOSED,(()=>o(this.initError||new n(w.WS_ABORT)))),this.connectionState=ge.CONNECTING,this.websocket.init(t).catch(o),this.websocket.once(Ue.FAILBACK,(()=>{o(new n(w.INIT_DATACHANNEL_TIMEOUT))})),this.inflateDataTimer&&window.clearInterval(this.inflateDataTimer),this.inflateDataTimer=window.setInterval((()=>{this.handleInflateData()}),2e4),setTimeout((()=>{void 0===this.openConnectionTime&&(e.debug("[".concat(this.clientId,"] init datachannel timeout while join with failback to websocket")),o(new n(w.INIT_DATACHANNEL_TIMEOUT)))}),r("DC_JOIN_WITH_FAILBACK"))}))}close(t){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.inflateDataTimer&&(this.handleInflateData(),window.clearInterval(this.inflateDataTimer),this.inflateDataTimer=void 0),this.reconnectToken=void 0,this.joinResponse=void 0,this.isJoining=!1,this.pendingNotifications=[],this._disconnectedReason=t||J.LEAVE,this.connectionState=ge.CLOSED,e.debug("[".concat(this.clientId,"] ")+"will close datachannel in signal"),this.websocket.close(),t===J.FALLBACK&&(this.websocket.removeAllListeners(),this.websocket=new Wt("gateway-".concat(this.clientId),this.spec.retryConfig,!0,this.store),this.handleWebsocketEvents())}async join(){if(this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),r("DC_PINGPONG_INTERVAL")),!this.joinResponse){this.emit(Te.ABORT_P2P_EXECUTION),this.store.signalConnected();const e=await K(this,Te.REQUEST_JOIN_INFO);this.store.joinReq(),this.isJoining=!0,this.pendingNotifications=[];const t=await this.request(Ae.JOIN,e);if(this.store.joinRep(),this.ortc=null==e?void 0:e.ortc,!t)return this.emit(Te.REPORT_JOIN_GATEWAY,w.TIMEOUT,this.url||""),!1;this.joinResponse=t,this.emit(Te.JOIN_RESPONSE,this.joinResponse),this.reconnectToken=this.joinResponse.rejoin_token}return this.connectionState=ge.CONNECTED,this.isJoining=!1,this.processPendingNotifications(),!0}async rejoin(){if(!this.reconnectToken)throw new n(w.UNEXPECTED_ERROR,"can not rejoin, no rejoin token");const e=Q(this,Te.REQUEST_REJOIN_INFO);e.token=this.reconnectToken;const t=await this.request(Ae.REJOIN,e);return!!t&&(this.connectionState=ge.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),r("DC_PINGPONG_INTERVAL")),t.peers&&t.peers.forEach((e=>{this.emit(ve.ON_USER_ONLINE,{uid:e.uid}),e.audio&&this.emit(ve.ON_ADD_AUDIO_STREAM,{uid:e.uid,uint_id:e.uint_id,audio:!0,ssrcId:e.audio_ssrc}),e.video&&this.emit(ve.ON_ADD_VIDEO_STREAM,{uid:e.uid,uint_id:e.uint_id,video:!0,ssrcId:e.video_ssrc}),e.audio_mute?this.emit(ve.MUTE_AUDIO,{uid:e.uid}):this.emit(ve.UNMUTE_AUDIO,{uid:e.uid}),e.video_mute?this.emit(ve.MUTE_VIDEO,{uid:e.uid}):this.emit(ve.UNMUTE_VIDEO,{uid:e.uid}),e.audio_enable_local?this.emit(ve.ENABLE_LOCAL_AUDIO,{uid:e.uid}):this.emit(ve.DISABLE_LOCAL_AUDIO,{uid:e.uid}),e.video_enable_local?this.emit(ve.ENABLE_LOCAL_VIDEO,{uid:e.uid}):this.emit(ve.DISABLE_LOCAL_VIDEO,{uid:e.uid}),e.audio||e.video||this.emit(ve.ON_REMOVE_STREAM,{uid:e.uid,uint_id:e.uint_id})})),!0)}reconnect(e,t){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.websocket.reconnect(e,t)}async downgradeCodec(e){if(!this.ortc)return!1;const t={downgrade_codec:e,ortc:this.ortc};return!!await this.request(Ae.DOWNGRADE_CODEC,t)}handleNotification(t){e.debug("[".concat(this.clientId,"] receive notification: "),t);const n=Bt(t.code);if("success"!==n.action){if("failed"!==n.action)return"quit"===n.action?("ERR_REPEAT_JOIN_CHANNEL"===n.desc&&this.close(J.UID_BANNED),void this.close()):void this.reconnect(n.action,Me.SERVER_ERROR);e.error("[".concat(this.clientId,"] ignore error: "),n.desc)}}handlePingPong(){if(!this.websocket||"connected"!==this.websocket.state)return;this.pingpongTimeoutCount>0&&this.rttRolling.add(3e3),this.pingpongTimeoutCount+=1,r("DC_DEBUG_LOG")&&console.debug("[datachannel-signal] pingpongTimeoutCount: ".concat(this.pingpongTimeoutCount));const t=r("PING_PONG_TIME_OUT"),n=Date.now();this.pingpongTimeoutCount>=t&&(e.warning("[datachannel-signal] PINGPONG Timeout. Last Socket Message: ".concat(n-this.lastMsgTime,"ms")),n-this.lastMsgTime>r("WEBSOCKET_TIMEOUT_MIN"))?this.reconnect("recover",Me.FALLBACK):this.request(Ae.PING,void 0,!0).then((()=>{this.pingpongTimeoutCount=0;const e=Date.now()-n;this.rttRolling.add(e),r("REPORT_STATS")&&this.send(Ae.PING_BACK,{pingpongElapse:e})})).catch((e=>{}))}handleInflateData(){const{inflateLength:e,deflateLength:t}=this.websocket.getInflateData();0!==e&&0!==t&&this.upload(De.WS_INFLATE_DATA_LENGTH,{ws_deflate_length:t,ws_inflate_length:e})}handleWebsocketEvents(){this.websocket.on(Ue.RECONNECT_CREATE_CONNECTION,(e=>{this.emit(Te.WS_RECONNECT_CREATE_CONNECTION,e)})),this.websocket.on(Ue.ON_MESSAGE,this.onWebsocketMessage),this.websocket.on(Ue.CLOSED,(()=>{this.connectionState=ge.CLOSED})),this.websocket.on(Ue.FAILED,(()=>{this._disconnectedReason=J.NETWORK_ERROR,this.connectionState=ge.CLOSED})),this.websocket.on(Ue.RECONNECTING,(e=>{this._websocketReconnectReason=e,this.joinResponse=void 0,this.connectionState===ge.CONNECTED?this.connectionState=ge.RECONNECTING:this.connectionState=ge.CONNECTING})),this.websocket.on(Ue.WILL_RECONNECT,((t,n)=>{if(Q(this,Te.IS_P2P_DISCONNECTED)&&"retry"===t)return e.debug("".concat(this.clientId," reconnect mode is retry, but p2p lost, change to tryNext")),this.reconnectToken=void 0,this.emit(Te.NEED_RENEW_SESSION),this.emit(Te.DISCONNECT_P2P),n("tryNext");"retry"!==t&&(e.debug("".concat(this.clientId," websockt will_connect event, renewSession reconnectMode is ").concat(t)),this.reconnectToken=void 0,this.emit(Te.NEED_RENEW_SESSION),this.emit(Te.DISCONNECT_P2P)),n(t)})),this.websocket.on(Ue.CONNECTED,(()=>{this.openConnectionTime=Date.now(),this.reconnectToken?this.rejoin().catch((t=>{e.warning("[".concat(this.clientId,"] rejoin failed ").concat(t)),this.reconnect("tryNext",Me.SERVER_ERROR)})):this.join().catch((t=>{if(this.emit(Te.REPORT_JOIN_GATEWAY,t.message||t.code,this.url||""),t instanceof n&&t.code===w.UNEXPECTED_RESPONSE&&t.data.code===Ne.ERR_NO_AUTHORIZED)return e.warning("[".concat(this.clientId,"] reconnect no authorized, recover")),void this.reconnect("recover",Me.SERVER_ERROR);e.error("[".concat(this.clientId,"] join gateway request failed"),t.toString()),this.spec.forceWaitGatewayResponse?this.reconnect("tryNext",Me.SERVER_ERROR):(this.initError=t,this.close())}))})),this.websocket.on(Ue.REQUEST_NEW_URLS,((e,t)=>{K(this,Te.REQUEST_RECOVER,this.multiIpOption).then(e).catch(t)})),this.websocket.on(Ue.ON_TOKEN_PRIVILEGE_DID_EXPIRE,(()=>{this.emit(ve.ON_TOKEN_PRIVILEGE_DID_EXPIRE)})),this.websocket.on(Ue.TO_CONNECT_DATACHANNEL,((e,t)=>{K(this,Te.PRE_CONNECT_PC).then(e).catch(t)})),this.websocket.on(Ue.FAILBACK,(()=>{void 0!==this.openConnectionTime&&this.emit(Te.DATACHANNEL_FAILBACK)}))}}const jt={name:"DataChannelConnection",create:function(e){let{store:t,spec:n}=e;return new Vt(n,t)}};const Jt={name:"DataChannelSignal",create:function(e){let{store:t,spec:n}=e;return new Yt(n,t)}};export{jt as DataChannelConnectionService,Jt as DataChannelSignalService};
